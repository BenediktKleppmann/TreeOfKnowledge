{% extends 'layouts/base_tool.html' %}
{% load bootstrap3 %}

{% block title %}
	Edit Simulation {{ model.name }}
{% endblock %}

{% block additionalcss %}


<style>
		
		
		/* --- Table box ----------------------------------------------------------- */
		
		.box {
			/*position: absolute;*/
			top: 40px;
			left: 0;
			height:450px;
		
		}
		
		.overflowing-content {
		    height: 100%;
			overflow: auto;
		}
		
		.table-box {
			width: max-content;
			width: intrinsic;           /* Safari/WebKit uses a non-standard name */
            width: -moz-max-content;    /* Firefox/Gecko */
            width: -webkit-max-content; /* Chrome */
		}
		
		#uploaded_table {
			margin-bottom:0px;
		}
		/* --- Table format -------------------------------------------------------- */
        .table {
			margin-bottom:0px;
			width: 2705px;
			overflow: auto;
        }
		

        thead, tbody, tr, td, th { display: block; text-align:left; }

        tr:after {
            content: ' ';
            display: block;
            visibility: hidden;
            clear: both;
        }

		
        thead th {
            height: max-content;
			height: intrinsic;           /* Safari/WebKit uses a non-standard name */
            height: -moz-max-content;    /* Firefox/Gecko */
            height: -webkit-max-content; /* Chrome */
        }
		
		
		thead {
			margin-left:20px;
		}
		
		.table thead > tr > th {border-bottom: 0;}

        tbody {
            height: 300px;
            overflow-y: auto;
			direction: rtl;
        }

        tbody td, thead th {
            width: 150px;
            float: left;
        }
		
		[contenteditable="true"]:focus {
			background-color: rgb(242, 242, 241);
		}
		 /* --- Attribute Selections ----------------------------------------------------- */
		
		#attribute_selections {
			margin-bottom:25px;
		}
		
		#attribute_selections > .btn {
			width:130px;
			margin-left:10px;
			margin-right:10px;
			display: inline-block;
			padding-left:8px;
		}
		
		/* --- Attributes Selection Menu ----------------------------------------------------- */
		
		.modal-dialog {
			width:700px;
		}	
		
		.modal-header {		
			margin-right: 0px;
			margin-left: 0px;
			padding-right: 0px;
			padding-left: 0px;
		}

		#chooseAttributeTitle {
			font-size:22px;
		}
		
		#selection-options-frame {
			/*border: solid 1px grey; */
			height: 290px; 
			width: 250px; 
			overflow-y:auto;
			margin-bottom:10px;
		}
		
		#selection-options {
			padding-left: 5px;
		}
		
		#selection-options > .btn {
			margin-top:5px; 
			width: 220px;
			text-align: left;
		}

		
</style>
{% endblock %}

{% block content %}

	{% for error in errors %}
		<div class="error">{{ error }}</div><br>
	{% endfor %}
	<br>
	<h1>5 - What are the columns?</h1>
	<br>

	<br>
	<br>
	
	<div class="form">
		<div class="form-group">
			<div class="box">
				<div class="overflowing-content">			
					<div class="table-box">
						<div id="attribute_selections"></div>
						<p id="uploaded_table"></p>
					</div>
				</div>
			</div>
			<br>
			<button type="submit" class="btn btn-primary">
				<span class="glyphicon glyphicon-star"></span> Next
			</button>
		</div>
	</div>	
	
	<br>
	<br>
	


	<!-- Modal -->
	<div class="modal fade" id="chooseAttribute" tabindex="-1" role="dialog" aria-labelledby="chooseAttributeTitle" aria-hidden="true">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header row">
			<h5 class="modal-title col-md-11" id="chooseAttributeTitle">Select Attribute type ....</h5>
			<button type="button col-md-1" class="close" data-dismiss="modal" aria-label="Close" style="margin-top:2px; margin-right:19px;font-size:29px">
			  <span aria-hidden="true" >&times;</span>
			</button>
		  </div>
		  <div class="modal-body">
			  <div class="container-fluid">
				<div class="row">
				  <div class="col-md-5">
					<span id="modal-attributenumber" style="visibility:hidden;"></span>
					<div id="selection-options-frame">
						<div class="input-group" id="selection-options" ></div>
					</div>
					<button type="button" class="btn btn-info" data-toggle="modal" data-target="#createAttribute" data-attributenumber="1" style="width:220px;">Create attribute type</button>
				  </div>
				  <div class="col-md-7 ml-auto">
					<div class="form">
						<div id="attribute-details"></div>
					</div>	
				  </div>
				</div>
			  </div>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
			<button type="button" class="btn btn-primary" onclick="saveAttributeSelection()" data-dismiss="modal">Save</button>
		  </div>
		</div>
	  </div>
	</div>

	<div id="useful-things" style="display:none;">
		<div id="attribute-options"></div>
		<div id="object_hierachy_tree">{{ object_hierachy_tree }}</div>
	</div>
	

<script>
    function CreateTableFromJSON() {
	
		// THE DATA
		var data_table_json = {{ uploaded_dataset.data_table_json | safe }}

		// GET HEADER VALUES
		var table_headers = data_table_json["table_header"]
		var table_body = data_table_json["table_body"]

		// MAKE TABLE.
		var table = document.createElement("table");
		table.setAttribute("class", "table table-sm table-condensed");
		table.setAttribute("style", "width: " + 153*table_headers.length + "px;");
		
		// MAKE TABLE HEADER
		var theader = table.createTHead();
		var tr = theader.insertRow(-1);                   // TABLE ROW.

		for (var i = 0; i < table_headers.length; i++) {
			var th = document.createElement("th");      // TABLE HEADER.
			th.setAttribute("scope", "col");
			th.setAttribute("contenteditable", "true");	
			th.innerHTML = table_headers[i];
			tr.appendChild(th);
		}
		
		// MAKE TABLE ROWS
		var tbody = document.createElement('tbody')
		for (var i = 0; i < table_body[0].length; i++) {
			tr = tbody.insertRow(-1);

			for (var j = 0; j < table_headers.length; j++) {
				var tabCell = tr.insertCell(-1);
				tabCell.innerHTML = table_body[j][i];
				tabCell.setAttribute("contenteditable", "true"); //ATTRIBUTE: contenteditable="true"
			}
		}
		table.appendChild(tbody)
			
		// ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
        var divContainer = document.getElementById("uploaded_table");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);
		
		
		//================================================================================
		//MAKE THE "Choose Attribute" Buttons
		
		var attSelectionBlock = document.getElementById("attribute_selections");
		attSelectionBlock.innerHTML = "";
			
		for (var i = 0; i < table_headers.length; i++) {
			var button = document.createElement("button");                     // Create <button id="attribute-button1" type="button" class="btn btn-primary" data-toggle="modal" data-target="#chooseAttribute" data-attributenumber="1">Choose Attribute</button>
			button.setAttribute("id", "attribute-button" + i);
			button.setAttribute("type", "button");
			button.setAttribute("class", "btn btn-primary");
			button.setAttribute("data-toggle", "modal");
			button.setAttribute("data-target", "#chooseAttribute");
			button.setAttribute("data-attributenumber", i);
			button.innerHTML = "Choose Attribute"      
			attSelectionBlock.appendChild(button);	
		}	
    }
	
	
	
	
	function saveAttributeSelection() {

		var attributenumber = $("#modal-attributenumber").html();
		var attributechoice = $("#attribute-choice").html();
		
		$("#attribute-button" + attributenumber).html(attributechoice);
		$("#attribute-button" + attributenumber).attr("class", "btn btn-light");

	}

	
	
			  
	function inspectAttribute(i) {
		// ADD IN THE ATTRIBUTE DETAILS INTO THE ATTRIBUTE SELECTION MENU
		var attribute_details = JSON.parse($("#attribute-options").html())
		var attribute_detail = attribute_details[i]
		
		
		var attributeDetailsBlock = document.getElementById("attribute-details");
		attributeDetailsBlock.innerHTML = "";
		
		var h_three = document.createElement("h3");         // <h3 id="attribute-choice">Option 2</h3>
		h_three.setAttribute("id", "attribute-choice");
		h_three.innerHTML = attribute_detail['attribute_name']
		attributeDetailsBlock.appendChild(h_three);	
		
		var div_form_group1 = document.createElement("div");         // <div class="form-group">
		div_form_group1.setAttribute("class", "form-group");
		
		var label1 = document.createElement("label");         // <label class="control-label" for="attribute-description">Description</label>
		label1.setAttribute("class", "control-label");		
		label1.setAttribute("for", "attribute-description");	
		label1.innerHTML = "Description"
		div_form_group1.appendChild(label1);	
		
		var textarea = document.createElement("textarea");         // <textarea cols="20" rows="3" class="form-control" id="attribute-description"></textarea>
		textarea.setAttribute("cols", "20");		
		textarea.setAttribute("rows", "3");	
		textarea.setAttribute("class", "form-control");	
		textarea.setAttribute("id", "attribute-description");	
		textarea.innerHTML = attribute_detail['description']
		div_form_group1.appendChild(textarea);	
		attributeDetailsBlock.appendChild(div_form_group1);	
		
		var hr = document.createElement("hr");         // <hr />
		attributeDetailsBlock.appendChild(hr);	
		
		
		var format_specifications = Object.keys(attribute_detail['format'])
			
		for (var j = 0; j < format_specifications.length; j++) {
			
			var form_group_div = document.createElement("div");         // <div class="form-group row">           ]
			form_group_div.setAttribute("class", "form-group row");
			
			var label = document.createElement("label");   // <label for="form-element" class="col-sm-8 col-form-label">Number of conflicting values</label>
			label.setAttribute("for", "form-element" + j );
			label.setAttribute("class", "col-sm-4 col-form-label");
			label.innerHTML = format_specifications[j];
			form_group_div.appendChild(label);	
			
			var div_col = document.createElement("div");   // <div class="col-sm-4">
			div_col.setAttribute("class", "col-sm-8");
			
			var input = document.createElement("input");  // <input type="text" readonly class="form-control-plaintext" id="form-element" value="">
			input.setAttribute("type", "text");
			input.setAttribute("readonly", "");
			input.setAttribute("class", "form-control-plaintext");
			input.setAttribute("id", "form-element" + j );
			input.setAttribute("value", attribute_detail['format'][format_specifications[j]]);
			div_col.appendChild(input);	
			form_group_div.appendChild(div_col);	
					
			attributeDetailsBlock.appendChild(form_group_div);	
		}
		
		
		var hr = document.createElement("hr");         // <hr />
		attributeDetailsBlock.appendChild(hr);	
		
		var div_form_group2 = document.createElement("div");         // <div class="form-group row">
		div_form_group2.setAttribute("class", "form-group row");
		
		var label2 = document.createElement("label");         // <label for="number_of_conflicting_values" class="col-sm-8 col-form-label">Number of conflicting values</label>
		label2.setAttribute("for", "number_of_conflicting_values");
		label2.setAttribute("class", "col-sm-8 col-form-label");		
		label2.innerHTML = "Number of conflicting values"
		div_form_group2.appendChild(label2);	
		
		var div_col2 = document.createElement("div");   // <div class="col-sm-4">
		div_col2.setAttribute("class", "col-sm-4");
		
		var input2 = document.createElement("input");  // <input type="text" readonly class="form-control-plaintext" id="number_of_conflicting_values" value="10" style="width:80px;">
		input2.setAttribute("type", "text");
		input2.setAttribute("readonly", "");
		input2.setAttribute("class", "form-control-plaintext");
		input2.setAttribute("id", "number_of_conflicting_values" );
		input2.setAttribute("value", attribute_detail['number_of_conflicting_values']);
		input2.setAttribute("style", "width:40px;" );
		div_col2.appendChild(input2);	
		div_form_group2.appendChild(div_col2);	
		attributeDetailsBlock.appendChild(div_form_group2);	
		
	}


	/*========================================================================*/
	/*========================================================================*/
	/*========================================================================*/

	
	
	window.onload = function() {
		
	
		/*====  Create Table    ========================================== */
		CreateTableFromJSON();
	  
	  
		/*====  WHEN CLICKED, LOAD the AttributeSelection Modal    ======= */
		var ATTRIBUTES = ['attributenumber'];
	  	$('[data-toggle="modal"]').on('click', function (e) {
		   //PART 0: clear the attribute details-section
		  var attributeDetailsBlock = document.getElementById("attribute-details");
		  attributeDetailsBlock.innerHTML = "";
		  
		  
		  //PART 1: copy the value from the data-attributenumber-attribute on the button to the innerHTML of <span id="modal-attributenumber"></span> in the modal
		  var $target = $(e.target); // convert target (e.g. the button) to jquery object
		  var modalSelector = $target.data('target'); // modal targeted by the button
		  
		  // iterate over each possible data-* attribute
		  ATTRIBUTES.forEach(function (attributeName) {
			// retrieve the dom element corresponding to current attribute
			var $modalAttribute = $(modalSelector + ' #modal-' + attributeName);
			var dataValue = $target.data(attributeName);
			
			// if the attribute value is empty, $target.data() will return undefined. In JS boolean expressions return operands and are not coerced into booleans. That way is dataValue is undefined, the left part of the following Boolean expression evaluate to false and the empty string will be returned
			$modalAttribute.text(dataValue || '');
		  });
		
		
			//PART 2: load the suggestions into the modal
			//part 2.1 make an ajax request to the backend
			
			var attributenumber = $target.data('attributenumber');
			var url_components = window.location.href.split("/");
			var upload_id = url_components[url_components.length - 2]
			
			var xhttp = new XMLHttpRequest();       
			  xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
				
				  $("#attribute-options").html(this.responseText);
				
				  $("#selection-options").html("");
				  var selectionsOptionsDiv = document.getElementById("selection-options");
				  var attribute_options = JSON.parse(this.responseText);
				  for (var i = 0; i < attribute_options.length; i++) {
						var button = document.createElement("button");                     // Create <button class="btn btn-outline-secondary" type="button" onclick="inspectAttribute()">Attribute Name</button>
						button.setAttribute("class", "btn btn-outline-secondary");
						button.setAttribute("type", "button");
						button.setAttribute("onclick", "inspectAttribute(" + i + ")");
						button.setAttribute("scope", "col");
						button.innerHTML = attribute_options[i]["attribute_name"]          // Attribute Name
						selectionsOptionsDiv.appendChild(button);	
						
						var br = document.createElement("br"); 
						selectionsOptionsDiv.appendChild(br);	
					}


				}
			  };
		

			  xhttp.open("GET", "/tool/get_suggested_attributes?upload_id=" + upload_id + "&attributenumber=" + attributenumber , true);
			  xhttp.send();
		  });

	};
</script>


	
{% endblock %}
