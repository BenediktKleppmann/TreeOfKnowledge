{% extends 'layouts/base_tool.html' %}
{% load bootstrap3 %}
{% load staticfiles %}

{% block title %}
	Edit Simulation {{ model.name }}
{% endblock %}

{% block additionalcss %}


<style>
		
		.object-type-spec-box {
			border: solid 1px grey;
			height: calc(100vh - 315px);
		}
		
		#search-box, #search-box2, #object_name { 
			box-shadow:inset 0 0 4px #eee; 
			width:150px; 
			margin:0; 
			padding:6px 12px; 
			border-radius:4px; 
			border:1px solid silver; 
			font-size:1.1em;
		}

		
		/* ---  Object type info (on the right) -------------------------------------------- */
		
		.broad-col {
			padding-left:0px;
			padding-right:5px;
		}
		
		.info-panel {
			padding:10px;
			border-radius: 5px;
			background-color: rgb(234, 239, 242);
			border:1px solid rgb(201, 216, 224); 
		}
		
		h3 {
			margin-top:5px;
			margin-bottom:10px;
			text-align:center
		}
		
		#jstree-result {
			
		}
		
		#object-info {
			height:calc(100vh - 320px);
			overflow:auto;
		}
		
		.list-group-row {
			padding:0;
			margin:0; 
			border: 1px solid #ddd;
			border-radius: 4px;
		}
		
		.list-group-right-column {
			padding:0;
		}
		
		.list-group-left-column {
			padding:0;
			text-align:center;
		}
		
		.list-group-left-column > span {
			vertical-align: middle; 
			display: inline-block;
			line-height:normal;
			transform: rotate(270deg);
		}
		
		.list-group {
			margin-bottom:0;

		}
		
		.narrow {
			padding-top:4px;
			padding-bottom:4px;
		}
		
		.btn-outline-dark {
			border-color: rgb(185, 185, 185);
			color: rgb(85, 85, 85);
			background-color: rgb(225, 225, 225);
			padding-top:5px;
			padding-bottom:5px;
	
		}
		
		.choose-button {
			margin-top: 25px;
		}
		
		/* --- Additional Attribute Drop Down -------------------------------------------- */
		.dropdown-menu {
			padding:0;
		}
		
		.search {
			height:40px;
			border-radius:4px;
			border: 1px solid #999;
		}
		
		div.inline { 
			float:left; 
			margin-right: 5px;
		}
		
		.broad {
			padding-top: 5px;
			padding-bottom: 5px;
			height:48.23px;
		}
		
		.dropdown-item {
			padding: 6px 10px;
			border-radius:2px;
			width:150px
		}
		
		
		/* ---  Modal -------------------------------------------- */
		.modal-body {
			padding-top:5px;
			padding-bottom:0px;
		}
		
		.modal-dialog {
			width:90%;
		}	
		
		.modal-header {		
			margin-right: 0px;
			margin-left: 0px;
			padding-right: 0px;
			padding-left: 0px;
		}
		
		#modal-title {
			font-size:22px;
		}
		
		#search-box2 {
			margin-top:15px;
		}
		
		#object_name {
			border-color:#222;  
			/*margin-bottom:15px;*/
			 display: block;
			margin-right: auto;
			margin-left: auto;
		}
		
		#object_name::placeholder { 
			color:#222;
		}
		

		
		#save_object_type_button {
			margin-top:20px;
			display:none;
		}
		
</style>
{% endblock %}

{% block content %}

	<br>
	<h1>3 - What objects are described by the table?</h1>
	<br>
		{% for error in errors %}
			<div class="error">{{ error }}</div><br>
		{% endfor %}

	
	<div class="container-fluid">
		<div class="row">
			<div class="col-sm-7">
				<div class="form">
					<input type="text" value="" id="search-box" placeholder="Search" />
					<br>
					<br>
					<div class="object-type-spec-box">
						<div id="container-for-object-tree" ></div>
					</div>
					<div style="margin-top:7px;margin-left:7px;">
						Object Type not listed? &nbsp;<button id="create-object-type" type="button" class="btn btn-default" data-toggle="modal" data-target="#createObjectType">Create new Object Type</button>
					</div>
				</div>
			</div>
			<div class="col-sm-5 broad-col" >
				<form role="form" action="" method="post" class="form" enctype="multipart/form-data">
				{% csrf_token %}
					<div class="info-panel">
						<div id="jstree-result"></div>
					</div>
					<input type="hidden" id="entire_objectInfoHTMLString" name="entire_objectInfoHTMLString" value="">
					<input type="hidden" id="all_entry_counts" name="all_entry_counts" value="">
					<button type="submit" class="btn btn-primary pull-right choose-button">
						<span class="glyphicon glyphicon-star"></span> Choose >
					</button>
				</form> 
			</div>
			
		</div>
	  </div>
	

	

	
	
	




	
	
	
	<!-- Modal -->
	<div class="modal fade" id="createObjectType" tabindex="-1" role="dialog" aria-labelledby="chooseAttributeTitle" aria-hidden="true">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header row">
			<h5 class="modal-title col-md-11" id="modal-title">Create Object type</h5>
			<button type="button col-md-1" class="close" data-dismiss="modal" aria-label="Close" style="margin-top:2px; margin-right:19px;font-size:29px">
			  <span aria-hidden="true" >&times;</span>
			</button>
		  </div>
		  <div class="modal-body">
			  <div class="container-fluid">
				<div class="row">
					<div class="col-md-6">
						<div class="form">
							<input type="text" value="" id="search-box2" placeholder="Search" />
							<br>
							<br>
							<div class="object-type-spec-box2">
								<div id="container-for-object-tree2" ></div>
							</div>
							<br>	
							<div class="row">
									<button type="button" class="btn btn-success btn-sm" onclick="create_object_type();"><i class="glyphicon glyphicon-asterisk"></i> Create Child of Selection</button>
									<button type="button" class="btn btn-warning btn-sm" onclick="edit_object_type();"><i class="glyphicon glyphicon-pencil"></i> Edit Selection</button>
							</div>
						</div>
					</div>
					<div class="col-md-6">
						<div class="form">
							<div class="info-panel">
								<div id="jstree-result2">
								</div>
								<div class="row list-group-row" id="new_object_facts_box" style="display:none">  
									<div class="col-sm-1 list-group-left-column" id="new_object_facts" style="line-height:135px;"><span style="margin-left:-47px; width:130px">facts about the<br>new object type</span></div>
									<div class="col-sm-11 list-group-right-column">  
										<ul class="list-group" id="new_object_facts_list"> 
											<li class="list-group-item broad" > <!-- Object Attribute 101 -->
												<div>
													<div class="dropdown inline">
														<button class="btn btn-secondary dropdown-toggle" type="button" id="attributeMenu101" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Attribute &nbsp;<i class="fas fa-caret-down fa-sm"></i></button>
														<div class="dropdown-menu" aria-labelledby="attributeMenu101">
															<div id="attributeList101">
																<input type="text" class="search" id="dropDonwSearch101" onkeyup="filterAttributeDropDown(101)" placeholder=" Search">
																<ul id="drop-down-display101" class="list list-group drop-down-display"></ul>
															</div>
														</div>
													</div>
													<input type="hidden" id="attribute101" name="attribute101" value="">
													<div class="form-group inline">
														<select class="form-control form-control-lg" id="operator101" name="operator101">
															<option value="=" selected>=</option>
															<option value=">">></option>
															<option value="<"><</option>
														</select>
													</div> 
													<div class="form-group inline">
														<input type="text" class="form-control" id="value101" name="value101" value="" size="15">
													</div>
												</div>
											</li>
											<li class="list-group-item broad" > <!-- Object Attribute 102 -->
												<div style="position:absolute">
													<div class="dropdown inline" >
														<button class="btn btn-secondary dropdown-toggle" type="button" id="attributeMenu102" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Attribute &nbsp;<i class="fas fa-caret-down fa-sm"></i></button>
														<div class="dropdown-menu" aria-labelledby="attributeMenu102">
															<div id="attributeList102">
																<input type="text" class="search" id="dropDonwSearch102" onkeyup="filterAttributeDropDown(102)" placeholder=" Search">
																<ul id="drop-down-display102" class="list list-group drop-down-display"></ul>
															</div>
														</div>
													</div>
													<input type="hidden" id="attribute102" name="attribute102" value="">
													<div class="form-group inline">
														<select class="form-control form-control-lg" id="operator102" name="operator102">
															<option value="=" selected>=</option>
															<option value=">">></option>
															<option value="<"><</option>
														</select>
													</div> 
													<div class="form-group inline">
														<input type="text" class="form-control" id="value102" name="value102" value="" size="15">
													</div>
												</div>
											</li>
											<li class="list-group-item narrow" id="create-new-object-fact-button">  	<button id="make-new-additional-fact-button" type="button" class="btn btn-outline-dark" onclick="newAdditionalFactInput('all');" ><i class="fas fa-plus"></i></button> </li>
										</ul>  
									</div>  
								</div> 
								<button type="button" id="save_object_type_button" class="btn btn-primary pull-right" onclick="addObjectType()" >Add</button>
							</div>
						</div>
					</div>
				</div>
			  </div>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-dismiss="modal" >Cancel</button>
			<button type="button" class="btn btn-primary" onclick="closeModalAndSave()" data-dismiss="modal">Save</button>
			
			
		  </div>
		</div>
	  </div>
	</div>
	
<script src="{% static 'js/list.min.js' %}"></script>

<script>

	// GLOBAL VARIABLES:
	var object_hierachy_tree = [{"id":"n1", "text" : "Thing", "li_attr": {}, "parent":"#"},
							{"id":"n2", "text" : "Object" , "li_attr": {}, "parent":"n1"},
							{"id":"n3", "text": "Living thing", "li_attr": {}, "parent":"n2"},
							{"id":"n4", "text": "Plant", "li_attr": {"attribute_values": [{"attribute":"Kingdom", "operation":"=", "value":"Plantae"}, {"attribute":"Does photosynthesis", "operation": "=", "value":true}]}, "a_attr":{"scientific":["Plantae"]}, "parent":"n3"},
							{"id":"n5", "text": "Tree", "li_attr": {"attribute_values": [{"attribute":"Has woody tissue", "operation": "=", "value":true},{"attribute":"Age", "operation": "<", "value":"7000"}]},  "parent":"n4"},
							{"id":"n6", "text": "Oak", "li_attr": {"attribute_values": [{"attribute":"Produces nuts", "operation": "=", "value":true}, {"attribute":"Has leaves", "operation": "=", "value":true}, {"attribute":"Age", "operation": "<", "value":"700"}, {"attribute":"Age", "operation": "<", "value":"100"}, {"attribute":"Weight", "operation": "<", "value":"9000"}]}, "a_attr":{"synonyms": ["oak tree"], "scientific": ["Quercus"]}, "parent":"n5"},
							{"id":"n7", "text": "Chestnut", "li_attr": {"attribute_values": [{"attribute":"Produces nuts", "operation": "=", "value":true}, {"attribute":"Produces berries", "operation": "=", "value":false}, {"attribute":"Age", "operation": "<", "value":"400"}, {"attribute":"Height", "operation": "<", "value":"130"}, {"attribute":"Weight", "operation": "<", "value":"10000"}]}, "a_attr":{"scientific": ["Castanea"]}, "parent":"n5"},
							{"id":"n8", "text": "Flower", "li_attr": {"attribute_values": [{"attribute":"Has petals", "operation": "=", "value":true}]}, "parent":"n4"},
							{"id":"n9", "text": "Lily", "li_attr": {"attribute_values": [{"attribute":"Petal color", "operation": "=", "value":"yellow"}]}, "parent":"n8"},
							{"id":"n10", "text": "Animal", "li_attr": {"attribute_values": [{"attribute":"Kingdom", "operation": "=", "value":"Animalia"}]}, "a_attr":{"synonyms": ["Creature"], "scientific": ["Animalia"]}, "parent":"n2"}
						]
	
	var object_hierachy_tree2 = {{ object_hierachy_tree|safe }}
					

	/*========================================================================*/
	/*=====================    MAIN FUNCTIONS      ===========================*/
	/*========================================================================*/
	
		

	/*=============  MAKE HTML STRING FOR OBJECT-INFO (on the right)  ========================================================= */
	function get_objectInfoHTMLString(data, node_id, prefix) {
		
		var objectInfoHTMLString = 	'<div class="row list-group-row row-eq-height">' + 
										'<div class="col-sm-1 list-group-left-column" id="' + prefix + 'left_col_' + node_id + '"><span>' + data.instance.get_node(node_id).text + '</span></div>' + 
										'<div class="col-sm-11 list-group-right-column">' + 
											'<ul class="list-group">'; 
										
		var attribute_values = data.instance.get_node(node_id).li_attr["attribute_values"]
		for(var i = 0; i < attribute_values.length; i++) {
			objectInfoHTMLString +=         	'<li class="list-group-item">' + ' ' + attribute_values[i]['attribute'] + ' '+ attribute_values[i]['operation'] + ' <i>'+ attribute_values[i]['value'] + '</i></li>';
		} 
		
		objectInfoHTMLString += 			'</ul>' + 
										'</div>' + 
									'</div>'; 		
		return objectInfoHTMLString;	
	}
	
	
	function get_numberOfListEntries(data, node_id) {
	
		var entries_count = 0
		
		var attribute_values = data.instance.get_node(node_id).li_attr["attribute_values"]
		if (attribute_values) {
			entries_count += attribute_values.length
		}
		
		return entries_count
	}
	
	
	
	/*=============  MAKE NEW ADDITIONAL FACT LIST ITEM  ================================================================ */
	var number_of_additional_facts = 2
	var number_of_additional_object_facts = 2;
	
	function newAdditionalFactInput(object_type) { 
	

		number_of_additional_object_facts += 1;
		fact_number = 100 + number_of_additional_object_facts;
		var insert_before = '#create-new-object-fact-button';

		
		var additionalFactHTMLString = 	'<li class="list-group-item broad" >' +
											'<div style="position:absolute">' + 
												'<div class="dropdown inline" >' + 
													'<button class="btn btn-secondary dropdown-toggle" type="button" id="attributeMenu' + fact_number + '" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Attribute &nbsp;<i class="fas fa-caret-down fa-sm"></i></button>' + 
													'<div class="dropdown-menu" aria-labelledby="attributeMenu' + fact_number + '">' + 
														'<div id="attributeList' + fact_number + '">' + 
															'<input type="text" class="search" id="dropDonwSearch' + fact_number + '" onkeyup="filterAttributeDropDown(' + fact_number + ')" placeholder=" Search">' +
															'<ul id="drop-down-display' + fact_number + '" class="list list-group drop-down-display"></ul>' +
														'</div>' + 
													'</div>' + 
												'</div>' + 
												'<input type="hidden" id="attribute' + fact_number + '" name="attribute' + fact_number + '" value="">' + 
												'<div class="form-group inline">' + 
													'<select class="form-control form-control-lg" id="operator' + fact_number + '" name="operator' + fact_number + '">' + 
														'<option value="=" selected>=</option>' + 
														'<option value=">">></option>' + 
														'<option value="<"><</option>' + 
													'</select>' + 
												'</div> ' + 
												'<div class="form-group inline">' + 
													'<input type="text" class="form-control" id="value' + fact_number + '" name="value' + fact_number + '" size="15">' + 
												'</div>' + 
											'</div>' +
										'</li>';
										
		$(additionalFactHTMLString).insertBefore(insert_before);
		
		makeObjectsAdditionalAttributesDropdown(object_type, fact_number);
		
	}
	
	
	/*=============  POPULATE AdditionalAttribute-DROPDOWNS  ================================================================ */
	
	function makeObjectsAdditionalAttributesDropdown(object_type, attribute_number){
	
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {

				list_group_html_string = ""
				
				var possible_attributes = JSON.parse(this.responseText);
				
				for (var i = 0; i < possible_attributes.length; i++) {
					list_group_html_string += '<li class="list-group-item narrow"><button class="name dropdown-item btn btn-secondary" type="button" onclick="selectAdditionalAttribute(' + attribute_number + ', this.innerHTML)">' + possible_attributes[i] + '</button></li>'
					
				}
				
				$("#drop-down-display" + attribute_number).html(list_group_html_string);
				
			}
		};

		xhttp.open("GET", "/tool/get_possible_attributes?object_type=" + object_type , true);
		xhttp.send();
	}
	/*
	function makeObjectsAdditionalAttributesDropdown(object_type, attribute_number){
	
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {

				//the data
				var options = {
				  valueNames: [ 'name', 'points' ],
				  item: '<li class="list-group-item narrow"><button class="name dropdown-item btn btn-secondary" type="button" onclick="selectAdditionalAttribute(' + attribute_number + ', this.innerHTML)"></button></li>'
				};
				var possible_attributes = JSON.parse(this.responseText);
				
				//create list with possible_attributes in drop down and sort it 
				var attributeList = new List('attributeList' + attribute_number, options, possible_attributes);
				attributeList.sort('points', {order: "desc"});
				
			}
		};

		xhttp.open("GET", "/tool/get_possible_attributes?object_type=" + object_type , true);
		xhttp.send();
	}
	*/

	/*=============  SELECT DROPDOWN OPTION  ================================================================ */
	function selectAdditionalAttribute(attribute_number , attribute_name) {
		$('#attributeMenu' + attribute_number).html(attribute_name + ' &nbsp;<i class="fas fa-caret-down fa-sm"></i>');
		$('#attribute' + attribute_number).attr('value', attribute_name);									
	}
	
	
	
	
	/*========================================================================*/
	/*=====================    MODAL FUNCTIONS      ==========================*/
	/*========================================================================*/

	
	/*=============  AFTER PRESSING THE 'Create Child of Selection'-BUTTON  ================================================================ */
	function create_object_type() {
	
		var ref = $('#container-for-object-tree2').jstree(true),
			sel = ref.get_selected();
		if(!sel.length) { return false; }
		var parents_object_type = sel[0];
							
		$("#info-panel-head").html('<br><input type="text" class="form-control-plaintext centered" id="object_name" name="object_name" placeholder="New Object Name" value=""><br>');
		

		
		$("#new_object_facts_box").attr("style", "display:block");
		$("#save_object_type_button").attr("style", "display:block");
		
		//For all Attribute-dropdowns: load a list of possible_attributes (for the selected object_type)
		for (var i = 1; i <= number_of_additional_object_facts; i++) {
			makeObjectsAdditionalAttributesDropdown( parents_object_type , 100 + i);
		}
		
		//for the "+"-button change it so that the new attribute-drop-downs will list the object-types attributes
		$("#make-new-additional-fact-button").attr("onclick", "newAdditionalFactInput('" + parents_object_type + "');")

		/* WRITE THE NEW OBJECT NAME AT THE BOTTOM  */
		$('#object_name').change(function() {
			$('#new_object_facts').html('<span>' + $(this).val() + '</span>');
		});	
	};
	
	
	
	
	/*=============  AFTER PRESSING THE 'Save'-BUTTON  ================================================================ */
	function addObjectType() {
	
		// make new_object_dict
		var new_object_dict = {}
		new_object_dict['text'] = $('#object_name').val(); // <-- 'text'
		
		attribute_values_list = []  // <-- 'li_attr'
		
		//for every attribute-specification, get the attribute, operator and value and save to the object_dict
		for (var i = 1; i <= number_of_additional_object_facts; i++) {
			
			new_fact = {}
			fact_number = 100 + i
			new_fact['attribute'] = $("#attribute" + fact_number).val();
			new_fact['operation'] = $("#operator" + fact_number).val();
			new_fact['value'] = $("#value" + fact_number).val();
			
			if (new_fact['attribute'] != "" && new_fact['value'] != "") {
				attribute_values_list.push(new_fact)
			}
		}
		var attribute_values_dict = {}
		attribute_values_dict['attribute_values'] = attribute_values_list
		new_object_dict['li_attr'] = attribute_values_dict
		
		var parent_id = $('#parent_node_id').val(); // <-- 'parent'
		
		
		$('#container-for-object-tree2').jstree(true).create_node(parent_id, new_object_dict);
		$('#container-for-object-tree').jstree(true).create_node(parent_id, new_object_dict);


		//reset the dropdown fields for the next new object type
		for (var i = 1; i <= number_of_additional_object_facts; i++) {
			fact_number = 100 + i
			$("#attributeMenu" + fact_number).html('Attribute &nbsp;');
			$("#value" + fact_number).val("");
		}
		
		$("#new_object_facts_box").attr("style", "display:none");
		$("#save_object_type_button").attr("style", "display:none");
		$("#new_object_facts").html('<span style="margin-left:-47px; width:130px">facts about the<br>new object type</span>');
	
	}
	
	/*=============  WHEN CLOSING THE MODAL  ================================================================ */
	function closeModalAndSave() {
	
	
		object_hierachy_tree = $('#container-for-object-tree2').jstree(true).get_json('#', {flat:true});
		
		//redraw JSTree wit new object_hierachy_tree
		$('#container-for-object-tree').jstree({
			'core' : {
				"animation" : 0,
				"check_callback" : true,
				'force_text' : true,
				"themes" : { "stripes" : false },	
				'data' : object_hierachy_tree
			},
			"types" : {
				"root" : { "icon" : "/static/3.3.7/assets/images/tree_icon.png", "valid_children" : ["default"] },
				"default" : { "valid_children" : ["default","file"] },
				"file" : { "icon" : "glyphicon glyphicon-file", "valid_children" : [] }
			},
			"plugins" : [ "contextmenu", "dnd", "search", "state", "types", "wholerow" ]
		});	
		
		//select the node that was selected in the modal
		var ref = $('#container-for-object-tree2').jstree(true),
			sel = ref.get_selected();
		if(sel.length) {
			sel = sel[0];
			$('#container-for-object-tree').jstree(true).deselect_all();
			$('#container-for-object-tree').jstree('select_node', sel);
		}
		
		//send the new object_hierachy_tree to the backend
		var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance 
		xmlhttp.open("POST", "/tool/save_new_object_hierachy_tree/");
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		xmlhttp.send(JSON.stringify(new_object_dict));
		
	}
	
	

										
										
	
/*	
	function demo_create() {
		var ref = $('#container-for-object-tree2').jstree(true),
			sel = ref.get_selected();
		if(!sel.length) { return false; }
		var selected_node_id = sel[0]
		object_hierachy_tree.push({"id":"waa", "text": "Waaaaaah", "li_attr": {"known_attribute_values": {"Has woody tissue":true}, "known_attribute_ranges": {"Age":"0-7000"}, "intersting_attributes": ["Genus", "Leaf coverage"]},  "parent":selected_node_id});
		ref.settings.core.data = object_hierachy_tree;
		ref.refresh();
	};
	
	function demo_delete() {
		var ref = $('#container-for-object-tree2').jstree(true),
			sel = ref.get_selected();
		if(!sel.length) { return false; }
		ref.delete_node(sel);
	};
*/


	

	window.onload = function() {
	
	//========================================================================
	//=========================      MAIN      ===============================
	//========================================================================
	
		
		//============= CREATE JSTREE    ================================================================================== 
				
		// search box
		var to = false;
		$('#search-box').keyup(function () {
			if(to) { clearTimeout(to); }
			to = setTimeout(function () {
				var v = $('#search-box').val();
				$('#container-for-object-tree').jstree(true).search(v);
			}, 250);
		});
		

		$('#container-for-object-tree').jstree({
			'core' : {
				"animation" : 0,
				"check_callback" : true,
				'force_text' : true,
				"themes" : { "stripes" : false },	
				'data' : object_hierachy_tree
			},
			"types" : {
				"root" : { "icon" : "/static/3.3.7/assets/images/tree_icon.png", "valid_children" : ["default"] },
				"default" : { "valid_children" : ["default","file"] },
				"file" : { "icon" : "glyphicon glyphicon-file", "valid_children" : [] }
			},
			"themes":{"icons":false},
			"plugins" : [ "contextmenu", "dnd", "search", "state", "types", "wholerow" ]
		});	
	
		
				
		//============= JSTREE - SELECT ELEMENT   ================================================================================== 
		
		// if an element of tree is selected, display it's information on the right
		$('#container-for-object-tree')
		  .on('select_node.jstree', function (e, data) {
		  
			//=====  PART 1: display the object-info on the right  ============
		
			//make a list of parent nodes
			var node_id = data.selected[0];
			var parent_nodes = [data.selected[0]];
			var current_node = data.selected;
			while (data.instance.get_parent(current_node) !== "#") {
				current_node = data.instance.get_parent(current_node);
				parent_nodes.unshift(current_node);
			}
			
			//loop through the parent nodes and add the info about the known_attribute_values and known_attribute_ranges
			var entire_objectInfoHTMLString = '<h3>' + data.instance.get_node(node_id).text + '</h3><input type="hidden" id="object_type" name="object_type" value="' + data.instance.get_node(node_id).text + '"><div id="object-info">';
			var all_entry_counts = {};
			for (var i = 0; i < parent_nodes.length; i++) {
				var node_id = parent_nodes[i];
				
				var entries_count = get_numberOfListEntries(data, node_id);
				if (entries_count > 0) {
					all_entry_counts[node_id] = entries_count;
					entire_objectInfoHTMLString += get_objectInfoHTMLString(data, node_id, '');
				}
			}
			
			entire_objectInfoHTMLString += '</div>'
			
		  	$('#jstree-result').html(entire_objectInfoHTMLString);                         //<- most important line
			$('#entire_objectInfoHTMLString').attr('value', entire_objectInfoHTMLString);   //<- other most important lines (for sending the info with the form)
			$('#all_entry_counts').attr('value', JSON.stringify(all_entry_counts));              //<- other most important lines (for sending the info with the form)
			
			//set the line-heights so that the object-type labels are at the right height in the left_cols
			for(var key in all_entry_counts) {
				$("#left_col_" + key ).css("line-height", 40 * all_entry_counts[key] + "px");
			} 
			
			//scroll the object-info box to the bottom
			var objectInfoBox = document.getElementById("object-info");
			objectInfoBox.scrollTop = objectInfoBox.scrollHeight;
		
		/*
			//=====  PART 2: display the "additional facts on the objects" section   ====================
			$("#additional_facts").css("display", "block");
			
			//For all Attribute-dropdowns: load a list of possible_attributes (for the selected object_type)
			for (var i = 1; i <= number_of_additional_facts; i++) {
				makeObjectsAdditionalAttributesDropdown( data.instance.get_node(node_id).text , i);
			}
		*/
		  
		  });
		
	
		
		//========================================================================
		//========================      MODAL      ===============================
		//========================================================================
		
		//when modal is opened
		$('[data-toggle="modal"]').on('click', function (e) {
		
			//============= CREATE JSTREE2    ================================================================================== 
			// search box
			var to = false;
			$('#search-box2').keyup(function () {
				if(to) { clearTimeout(to); }
				to = setTimeout(function () {
					var v = $('#search-box2').val();
					$('#container-for-object-tree2').jstree(true).search(v);
				}, 250);
			});
			
			
			$('#container-for-object-tree2').jstree({
				'core' : {
					"animation" : 0,
					"check_callback" : true,
					'force_text' : true,
					"themes" : { "stripes" : false },	
					'data' : object_hierachy_tree
				},
				"types" : {
					"root" : { "icon" : "/static/3.3.7/assets/images/tree_icon.png", "valid_children" : ["default"] },
					"default" : { "valid_children" : ["default","file"] },
					"file" : { "icon" : "glyphicon glyphicon-file", "valid_children" : [] }
				},
				"plugins" : [ "contextmenu", "dnd", "search", "state", "types", "wholerow" ]
			});	
			
			//SELECT THE SELECTED NODE 
			var ref = $('#container-for-object-tree').jstree(true),
				sel = ref.get_selected();
			if(sel.length) {
				sel = sel[0];
				$('#container-for-object-tree2').jstree(true).deselect_all();
				$('#container-for-object-tree2').jstree('select_node', sel);
			}
		
		});
		
		
		
		//============= JSTREE - SELECT ELEMENT   ================================================================================== 
		
		// if an element of tree is selected, display it's information on the right
		$('#container-for-object-tree2').on('select_node.jstree', function (e, data) {
		  
			//=====  PART 1: display the object-info on the right  ============
		
			//make a list of parent nodes
			var node_id = data.selected[0];
			var parent_nodes = [data.selected[0]];
			var current_node = data.selected;
			while (data.instance.get_parent(current_node) != "#") {
				current_node = data.instance.get_parent(current_node);
				parent_nodes.unshift(current_node);
			}
			
			//loop through the parent nodes and add the info about the known_attribute_values and known_attribute_ranges
			var entire_objectInfoHTMLString = '<div id="info-panel-head"><h3 id="object_type_name">' + data.instance.get_node(node_id).text + '</h3></div><input type="hidden" id="parent_node_id" value="' + node_id + '">';
			var all_entry_counts = {};
			for (var i = 0; i < parent_nodes.length; i++) {
				var node_id = parent_nodes[i];
				
				var entries_count = get_numberOfListEntries(data, node_id);
				if (entries_count > 0) {
					all_entry_counts[node_id] = entries_count;
					entire_objectInfoHTMLString += get_objectInfoHTMLString(data, node_id, 'object_');
				}
			}

		  	$('#jstree-result2').html(entire_objectInfoHTMLString);  //<- most important line
			
			
			//set the line-heights so that the object-type labels are at the right height in the left_cols
			for(var key in all_entry_counts) {
				$("#object_left_col_" + key ).css("line-height", 40 * all_entry_counts[key] + "px");
			} 
		
		
			//=====  PART 2: display the "additional facts on the objects" section   ====================
			$("#additional_facts").css("display", "block");
			
			//For all Attribute-dropdowns: load a list of possible_attributes (for the selected object_type)
			for (var i = 1; i <= number_of_additional_facts; i++) {
				makeObjectsAdditionalAttributesDropdown( data.instance.get_node(node_id).text , i);
			}
		
		  
		  });
		
		


	};
	

</script>


	
{% endblock %}
