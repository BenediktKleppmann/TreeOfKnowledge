<!--                 EDIT ATTRIBUTE MODAL                   -->
<!-- This is used in upload_data3, upload_data4, upload_data5 -->

{% load staticfiles %}
<!--<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" />-->
<link href="{% static 'css/contextmenu.min.css' %}" rel="stylesheet" />

<!--<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script> -->
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
<script src="{% static 'js/contextmenu.js' %}"></script>

<script src="{% static 'js/bootstrap.min.js' %}"></script>
		
		
		
		
<style>	

	@font-face { font-family: 'Aileron-Light'; src: url('{% static 'fonts/Aileron-Light.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-Thin'; src: url('{% static 'fonts/Aileron-Thin.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-UltraLightItalic'; src: url('{% static 'fonts/Aileron-UltraLightItalic.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-Black'; src: url('{% static 'fonts/Aileron-Black.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-BlackItalic'; src: url('{% static 'fonts/Aileron-BlackItalic.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-Bold'; src: url('{% static 'fonts/Aileron-Bold.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-BoldItalic'; src: url('{% static 'fonts/Aileron-BoldItalic.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-Heavy'; src: url('{% static 'fonts/Aileron-Heavy.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-HeavyItalic'; src: url('{% static 'fonts/Aileron-HeavyItalic.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-Light'; src: url('{% static 'fonts/Aileron-Light.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-LightItalic'; src: url('{% static 'fonts/Aileron-LightItalic.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-Regular'; src: url('{% static 'fonts/Aileron-Regular.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-SemiBold'; src: url('{% static 'fonts/Aileron-SemiBold.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-SemiBoldItalic'; src: url('{% static 'fonts/Aileron-SemiBoldItalic.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-Thin'; src: url('{% static 'fonts/Aileron-Thin.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-ThinItalic'; src: url('{% static 'fonts/Aileron-ThinItalic.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-UltraLight'; src: url('{% static 'fonts/Aileron-UltraLight.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-UltraLightItalic'; src: url('{% static 'fonts/Aileron-UltraLightItalic.otf'%}') format('truetype'); }

	/* --- Context Menu -------------------------------------------- */
	
	.contextmenu-menu {
		z-index: 2060 !important;
	}
	/* --- Edit Attribute Modal -------------------------------------------- */
	
	#editObjectTypeModal .modal-dialog {
		width: 1000px;
	}

	#editObjectTypeModal .modal-header.row {
		margin-right: 0px;
		margin-left:0px;
		padding:9px;
		/*background: rgb(226, 226, 226);*/
	}
	
	#editObjectTypeModal .modal-body {
		padding-top: 17px;
		padding-left: 25px;
		padding-right:25px;
		padding-bottom: 0px;
		height: calc(100vh - 230px);
	}
	
	#editObjectTypeModal .modal-footer {
		padding: 8px;
		margin-top: 23px;
	}
	
	#editObjectTypeModal #modal-title {
		display: inline-block;
		font-size: 22px;
		margin-top: 16px;
		margin-left: 19px;
	}



	/* ---------------------------------------------------------------------------*/
	/*  Modal Header  ------------------------------------------------------------*/
	/* ---------------------------------------------------------------------------*/
	
	/* Object Icon Popover -----------------------------------------*/
	#editObjectTypeModal #object-icon-button {
		display: inline-block;
		margin-top: 7px;
		margin-bottom: 6px;
		
	}
	
	#editObjectTypeModal.object-icon-box {
		height: 400px;
		overflow: auto;
		width: 265px;
	}
	
	#editObjectTypeModal .small-object-icon {
		height: 25px;
		width: 25px;
		background: rgb(249, 249, 249);
		border: 1px solid rgb(210, 210, 210);
		border-radius: 2px;
		box-shadow: -1px 1px 0px 2px rgba(0, 0, 0, 0.05);
		margin-top: 3px;
		margin-left: 1px;
		padding-top: 2px;
		padding-left: 2px;
		padding-right: 1px;
	}
	
	
	 #editObjectTypeModal .small-object-icon:hover {
		background: rgb(235, 235, 235);
	}
	
	#editObjectTypeModal  #x-button {
		display: inline-block;
		float: right;
		margin-top:14px; 
		margin-right:24px;
		font-size:29px
	}
	

	/* ---------------------------------------------------------------------------*/
	/*  Behaviour Rules --------------------------------------------------------------*/
	/* ---------------------------------------------------------------------------*/
	
	#behaviour-rule-block {}
	
	
							
	/* LEFT -----------------------------------------*/
	#behaviour-left-panel {
		display: inline-block;
		float: left;
	}
	
	#editObjectTypeModal #available-variable-frame {
		border: 1px solid rgb(202, 202, 202);
		border-radius: 4px;
		width: 100%;
		height: calc(100vh - 260px);
		overflow: auto;
	}
	
	#editObjectTypeModal .list-group-item.avail-var-item{
		border-bottom: 1px solid rgb(202, 202, 202);
		margin-bottom: 0px;
		padding:0px;
	}

	#editObjectTypeModal .avail-var-button {
		background: white;
	}
	
	
	
	/* MIDDLE -----------------------------------------*/
	
	#behaviour-middle-panel {
		display: inline-block;	
		margin-left: 10px;
	}
	
	#behaviour-middle-panel h4 {
	    margin-left: 11px;
	}
	
	/* -- Rule Panels --*/
	#b-rule-panel-body {
		width: 700px;
		height:calc(100vh - 260px);
		overflow-y: auto;
		padding: 2px;
		-webkit-box-shadow: inset 1px 1px 9px 5px rgba(0,0,0,0.2);
		-moz-box-shadow: inset 1px 1px 59px 5px rgba(0,0,0,0.2);
		box-shadow: inset 1px 1px 9px 5px rgba(0,0,0,0.2);
		background-color: rgb(190, 190, 190);
		/* slightly darker:
		border-left: 6px solid rgb(240, 240, 240);
		border-top: 6px solid rgb(220, 220, 220);
		border-right: 6px solid rgb(245, 245, 245);
		border-bottom: 6px solid rgb(250, 250, 250);
		*/
		border-left: 5px solid rgb( 230, 230, 230);
		border-top: 5px solid rgb( 218, 218, 218);
		border-right: 5px solid rgb(250, 250, 250);
		border-bottom: 5px solid rgb(250, 250, 250);
	}
	
	#b-rules-list > .list-group-item {
		height: 84px;
		border-left: 9px solid rgb(252, 252, 252);
		border-top: 9px solid rgb(255, 255, 255);
		border-right: 9px solid rgb( 242, 242, 242);
		border-bottom: 9px solid rgb( 235, 235, 235);
		margin-bottom: 3px;
		border-radius: 3px;
		padding: 0px;
		-webkit-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		-moz-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		background-color: rgb(252, 252, 252);
	}
	

	
	#plus-button {
		-webkit-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.3);
		-moz-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.3);
		box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.3);
	}
	
	/* -- b-rule Panel Content --*/
	#plus-button-list-group-item {
		background-color: rgba(256, 256, 256, 0);
		padding: 17px;
		padding-left: 25px;
	}
	
	.b-rule-description {
		width: 560px;
		height: 46px;
		display: inline-block;
		float: left;
	}
	
	.b-rule-text.form-control {
		height: 47px;
		width: 180px;
		border: 1px solid rgb(242,242,242);
		display: inline-block;
	}
	
	.if-block {
		float: left;
		display: inline-block;
		border: 1px solid rgb(220,220,220);
		border-radius: 7px;
		padding: 2px;
		margin-left: 1px;
		background-color: rgb(250, 250, 250);
	}
	.then-block {
		display: inline-block;
		margin-left: 20px;
		border: 1px solid rgb(220,220,220);
		border-radius: 7px;
		padding: 2px;
		margin-left: 5px;
		background-color: rgb(250, 250, 250);
	}
	
	.if-then-text {
		font-size: 14px;
		font-weight: 600;
		text-align: center;
		margin-top: -4px;
		margin-bottom: -2px;
		font-family: Garamond;
	}
	
	.then-fomula-left {
		display: inline-block;
		font-size: 13px;
		margin-right: 3px;
		margin-left: 3px;
		max-width: 160px;
		float: left;
	}
													
	
	.remove-b-rule-button {
		display: inline-block;
		float: right;
		height: 18px;
		width: 18px;
		padding: 0px;
		margin-top: 3px;
		margin-right: 2px;
		border-radius: 3px;
		background-color: rgb(242, 242, 242);
	}

	.remove-b-rule-button-text {
		margin-left: -1px;
		margin-top: -2px;
	}
	
	
		/*  Disabled  --------------------------------------------------------------------*/
	

	
	#b-rules-list > .list-group-item.disabled {
		background-color: rgb(240, 240, 240);
		color: rgb(160, 160, 160);
		border-right: 9px solid rgb(227, 227, 227);
		border-bottom: 9px solid rgb(230, 230, 230);
		border-left: 9px solid rgb( 242, 242, 242);
		border-top: 9px solid rgb( 247, 247, 247);
	}
	
	.disabled .b-rule-text 
	{
		background-color: rgb(252, 252, 252);
		color: rgb(160, 160, 160);
	}

	
	.disabled .p-value-number {
		background-color: rgb(240, 240, 240);
		border-color: rgb(240, 240, 240);
		color: rgb(160, 160, 160);
	}
</style>


	
	<!-- Edit Object Type Modal -->
	<div class="modal fade" id="editObjectTypeModal" tabindex="-1" role="dialog" aria-labelledby="chooseAttributeTitle" aria-hidden="true">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header row">
			<button type="button" id="object-icon-button" class="btn pull-left" style="display:inline-block;" data-container="body" data-toggle="popover" data-placement="bottom" data-html="true" title="Choose icon" data-content=''>
				<img src="{% static "images/object_icons/" %}si-glyph-mustache.svg">
			</button>
			<div class="modal-title object-type-name" id="modal-title"></div>
			<button id="x-button" type="button col-md-1" class="close" data-dismiss="modal" aria-label="Close"  onclick="closeObjectTypeModal()">
			  <span aria-hidden="true" >&times;</span>
			</button>
		  </div>
		  <div class="modal-body">
			  <div class="container-fluid">
				<div class="form">
					<div id="behaviour-rule-block">
						<div id="behaviour-left-panel">
							<div id="available-variable-frame">
								<ul id="available-variables" class="input-group list-group"></ul>
							</div>
						</div>
						<div id="behaviour-middle-panel">

						</div>
					</div>
				</div>
			</div>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-secondary" onclick="closeObjectTypeModal()" id="editAttributeCloseButton" data-dismiss="modal">Cancel</button>
			<button type="button" class="btn btn-primary" onclick="saveChanges()">Save Changes</button>
			<button type="button" class="btn btn-danger" onclick="deleteAttribute()">Delete Attribute</button>
		  </div>
		  
		</div>
	  </div>
	</div>
	
	
<script>

//GLOBAL VARIABLES
var selected_object_type_id = "n1";
var maximum_b_rule_number = 0;
var b_rules = {};

	
	
	/*========================================================================*/
	/*======================    BUILD THE MODAL     ==========================*/
	/*========================================================================*/
	
	function openEditObjectTypeModal(object_type_id){
	
		$("#editObjectTypeModal").modal('show');


		var object_type_name = available_object_types[object_type_id]['name'];
		var object_icon = available_object_types[object_type_id]['object_icon'];
		
		$(".object-type-name").each(function( index ) {
			$(this).html(object_type_name);
		});
		$("#object-icon-button > img").attr('src','{% static "images/object_icons/" %}' + object_icon + '.svg');
		
		// draw the Icon Popover 
		popover_content = 	'<div class="object-icon-box">' +
								'<table>';
		for (var row = 0; row < Math.ceil(object_icons.length/8) ; row++) {
			popover_content += 	'<tr>';
			for (var column = 0; column < 8 ; column++) {
				icon_number = row*8 + column;
				if (icon_number < object_icons.length) {
					popover_content += '<td>' + 
											'<div class="small-object-icon" onclick="changeObjectTypeIcon(' + object_type_id + ', &#39;' + object_icons[icon_number] + '&#39;)">' +
												'<img src="{% static "images/object_icons/" %}' + object_icons[icon_number] + '.svg" %}">' +
											'</div>' +
										'</td>';
				}
			}
			popover_content += 		'</tr>';
		}
		popover_content += 	'</table>' +
						'</div>';
		$("#object-icon-button").attr('data-content',popover_content);
			
			
		
		// LEFT: List Variables	
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {

				available_variables = JSON.parse(this.responseText);
				
				available_variables_html_string = '';
				for (var i = 0; i < available_variables.length ; i++) {
					var attribute_id = available_variables[i]['id'];
					var attribute_name = available_variables[i]['name'];
					available_variables_html_string += 	'<li class="list-group-item avail-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="inspectBehaviourRulesForAttribute(\'' + attribute_id + '\',\'' + attribute_name + '\')" scope="col">' + attribute_name + '</button></li>';
					
				}
				
				$('#available-variables').html(available_variables_html_string);	

			}
		};
		xhttp.open('GET', '/tool/get_available_variables?object_type_id=' + object_type_id , true);
		xhttp.send();
		
		
			


		
	
	}
	
	/*========================================================================*/
	/*=====================    MODAL FUNCTIONS     ===========================*/
	/*========================================================================*/
	
	
	$("#b-rules-list").sortable();
	
	// select variable on the left
	function inspectBehaviourRulesForAttribute(attribute_id, attribute_name) {
	
		// draw rule panel
		rule_panel_html = 		'<h4>Rules that change the ' + attribute_name + '</h4>' +
								'<div id="b-rule-panel-body">' +
								'<ul id="b-rules-list" class="list-group">' +
									'<li id="plus-button-list-group-item">' +
										'<button id="plus-button" type="button" class="btn btn-outline-dark" onclick="newBehariourRule()" >' +
											'<i class="fas fa-plus"></i>' +
										'</button>' +
									'</li>'
								'</ul>' +
							'</div>';
		$("#behaviour-middle-panel").html(rule_panel_html);
		
		/*
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {

				b_rules = JSON.parse(this.responseText);
				
				available_variables_html_string = '';
				for (var i = 0; i < available_variables.length ; i++) {
					var attribute_id = available_variables[i]['id'];
					var attribute_name = available_variables[i]['name'];
					available_variables_html_string += 	'<li class="list-group-item avail-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="inspectBehaviourRulesForAttribute(\'' + attribute_id + '\',\'' + attribute_name + '\')" scope="col">' + attribute_name + '</button></li>';
					
				}
				
				$('#available-variables').html(available_variables_html_string);	

			}
		};
		xhttp.open('GET', '/tool/get_b_rules?attribute_id=' + attribute_id , true);
		xhttp.send();
	*/
	
	
		additional_b_rule_html_string = 	'<li class="list-group-item new" id="b-rule0">' +
												'<div class="b-rule-description">' +
													'<div class="if-block">' +
														'<div class="if-then-text">IF</div>' +
														'<textarea class="b-rule-text form-control" id="b-rule-text-if0" cols="20" rows="3" class="form-control" onclick="rememberCursorPostion(0)" onchange="checkBehaviourRule()"></textarea>' +
													'</div>' +
													'<div class="then-block">' +
														'<div class="if-then-text">THEN</div>' +
														'<div class="then-fomula-left">' + attribute_name + ' = </div>' +
														'<textarea class="b-rule-text form-control" id="b-rule-text-then0" cols="20" rows="3" class="form-control" onclick="rememberCursorPostion(0)" onchange="checkBehaviourRule()"></textarea>' +
													'</div>' +
												'</div>' +
												'<button type="button" class="btn btn-secondary remove-b-rule-button" onclick="removeBehaviourRule(0)"><div class="remove-b-rule-button-text">&times;</div></button>' +
											'</li>';
		
		$(additional_b_rule_html_string).insertBefore('#plus-button-list-group-item');
			

	
	}
	



	// X - Button
	function removeBehaviourRule(b_rule_number) {
		if (factor_number in specified_factors) {
			if ('score' in specified_factors[factor_number]) {
				 overall_score -= specified_factors[factor_number]['score'];
			}
		}

		//remove from specified_factors
		delete specified_factors[factor_number];

		//remove from sorted_factor_numbers
		var index = sorted_factor_numbers.indexOf(factor_number);
		if (index > -1) {
		   sorted_factor_numbers.splice(index, 1);
		}
	
	
		
		//remove from html
		var selected_factor = document.getElementById('factor' + factor_number);
		selected_factor.parentNode.removeChild(selected_factor);
		
		
		displayLearnedRuleAndScore();
	}



	
	// the '+'-Button
	function newFactor() {
	
		new_factor_number = 0;
		var factor_numbers = Object.keys(specified_factors);
		if (factor_numbers.length > 0) {
			new_factor_number = Math.max(...factor_numbers) + 1;
		}
		
		additional_factor_html_string = '<li class="list-group-item new" id="factor' + new_factor_number + '">' +
											'<div class="factor-description">' +
												'<textarea class="factor-text form-control" id="factor-text' + new_factor_number + '" cols="20" rows="3" class="form-control" onclick="rememberCursorPostion(' + new_factor_number + ')" onchange="checkFactor()"></textarea>' +
											'</div>' +
											'<button type="button" class="btn btn-secondary remove-factor-button" onclick="removeFactor(' + new_factor_number + ')"><div class="remove-factor-button-text">&times;</div></button>' +
										'</li>';
	
		$(additional_factor_html_string).insertBefore('#plus-button-list-group-item');
		
		specified_factors[new_factor_number] = {'factor_text': '',
											    'factor_transformation': ''};
		sorted_factor_numbers.push(new_factor_number);
	}
		
	
	
	
	
	
	
	
	
	
	
	
	
	
	
		
	/*=============  ICON CHANGE  ================================================================ */
	function changeObjectTypeIcon(object_number, object_icon) {
		//change in Right Sidebar
		$("#object-icon-button > img").attr('src','{% static "images/object_icons/" %}' + object_icon + '.svg');
		
		//change in Object_Dict
		objects_dict[object_number]['object_icon'] = object_icon;
		
		//change on Paper
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			
				var svg_text = this.responseText.replace(/\n/g, '');
				cell = graph.getCell(object_number); 
				cell.attr('image/xlink:href', 'data:image/svg+xml;utf8,' + encodeURIComponent(svg_text));
			}
		};
		xhttp.open('GET', '{% static "images/object_icons/" %}' + object_icon + '.svg', true);
		xhttp.send();
	}	
		
		
		
		
	
	
	/*=============  'Save Changes' BUTTON  ================================================================ */	
	function saveChanges() {
		
		var attribute_id = $("#attribute_id").val();
		var name = $("#editAttributeModal #name").val();
		var description = $("#editAttributeModal #description").val();
		var expected_valid_period = $("#editAttributeModal #expected_valid_period").val();
		var first_applicable_object_type = $("#editAttributeModal #first_applicable_object_type").val();
		var type = $("#editAttributeModal #type_edit").val();
		var min = $("#editAttributeModal #min").val();
		var max = $("#editAttributeModal #max").val();
		var min_length = $("#editAttributeModal #min_length").val();
		var max_length = $("#editAttributeModal #max_length").val();
		var allowed_values = $("#editAttributeModal #allowed_values").val();
		
		message_body = {} 
		message_body['attribute_id'] = parseInt(attribute_id);
		message_body['name'] = name;
		message_body['data_type'] = type;
		message_body['description'] = description;
		message_body['expected_valid_period'] = expected_valid_period;
		message_body['first_applicable_object_type'] = first_applicable_object_type;
		message_body['format_specification'] = {}
		message_body['format_specification']['fields'] = {}
		message_body['format_specification']['fields']['column'] = {}
		message_body['format_specification']['fields']['column']['type'] = type;
		
		if (name.length < 2) {
			alert("Attribute Name too short");
			return;
		}
		
		if (expected_valid_period=="") {
			alert("Please specify an estimated valid time (from the dropdown beneath 'Description')");
			return;		
		}
		
		
		if (type == "") {
			alert("Data Type required");
			return;
		}
		
		
		if (type == "string") {
			if (isNaN(min_length) || min_length[0] == " " || min_length == ""){
				alert("Min Length - this must be populated with an integer number");
				return;
			}
			if (isNaN(max_length) || max_length[0] == " " || max_length == ""){
				alert("Max Length - this must be populated with an integer number");
				return;
			}

			min_length = parseInt(min_length);
			max_length = parseInt(max_length);
			
			if (max_length <= min_length) {
				alert("'Maximum string length' must be bigger than 'Minimum string length'");
				return;
			}
			
			message_body['format_specification']['fields']['column']['min_length'] = min_length;
			message_body['format_specification']['fields']['column']['max_length'] = max_length;
			
			if (($("#allowed-values-group").attr("style")=="display:block;") && (allowed_values_list != "")) {
				try {
					allowed_values_list  = JSON.parse(allowed_values)
					if (!Array.isArray(allowed_values_list)) {
						alert("Allowed Values - the value submitted here is not a list");
						return;
					} else {
						message_body['format_specification']['fields']['column']['allowed_values'] = allowed_values;
					}
				}
				catch(err) {
					alert("Allowed Values - the value submitted here is not a list");
					return;
				}
			}
		}
		
		if (["int", "real", "date"].includes(type)) {
			if (type == "int"){
				if(isNaN(min) || min[0] == " " || min == ""){
					alert("Min - this must be populated with an integer number");
					return;
				}
				if (isNaN(max) || max[0] == " " || max == ""){
					alert("Max - this must be populated with an integer number");
					return;
				}
				
				min = parseInt(min);
				max = parseInt(max);
				
				if (max <= min) {
					alert("Max must be bigger than Min");
					return;
				}
				
				message_body['format_specification']['fields']['column']['min'] = min;
				message_body['format_specification']['fields']['column']['max'] = max;
			}

			if (type == "real"){
				if(isNaN(min) || min[0] == " " || min == ""){
					alert("Min - this must be populated with a decimal number");
					return;
				}
				if (isNaN(max) || max[0] == " " || max == ""){
					alert("Max - this must be populated with a decimal number");
					return;
				}
				
				min = parseFloat(min);
				max = parseFloat(max);
				
				if (max <= min) {
					alert("Max must be bigger than Min");
					return;
				}
				
				message_body['format_specification']['fields']['column']['min'] = min;
				message_body['format_specification']['fields']['column']['max'] = max;
				
			}
			
		}

		var xmlhttp = new XMLHttpRequest();  
		xmlhttp.open("POST", "/tool/save_changed_attribute/");
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		xmlhttp.send(JSON.stringify(message_body));
	
		// CLEAN UP -------------------------
		// empty the input fields
		$("#name").val("");
		$("#description").val("");
		$("#expected_valid_period").val("");
		$("#type_edit").val("");
		$("#edited-attribute-further-fields").html("");
		
		//close the modal
		document.getElementById("editAttributeCloseButton").click();
		
		redrawAttributeSelections();
	}
	
	
	/*=============  'Delete Attribute' BUTTON  ================================================================ */	
	function deleteAttribute() {
		var attribute_id = $("#attribute_id").val();
		
		var xmlhttp = new XMLHttpRequest();  
		xmlhttp.open("POST", "/tool/delete_attribute/");
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		xmlhttp.send(JSON.stringify({'attribute_id':parseInt(attribute_id)}));
	
	}
	
	/*=============  'Cancel' BUTTON (or the X) ================================================================ */	
	function closeObjectTypeModal() {
	
		$("#editAttributeModal #name").val("");
		$("#editAttributeModal #attribute_id").val("");
		$("#editAttributeModal #description").html("");
		$("#editAttributeModal #expected_valid_period").val("");
		$("#editAttributeModal #first_applicable_object_type").val("");
		$("#editAttributeModal #type_edit").val("");		
		$("#edited-attribute-further-fields").html("");

	}
	
	
	
	/*=============  CHEDKBOX "CATEGORICAL" -> TOGGLE ALLOWED VALUES  ================================================================ */
	function toggleCategoricalField() {
		var displayed = $("#allowed-values-group").attr("style")=="display:block;";
		if (displayed) {
			$("#allowed-values-group").attr("style","display:none;");
			document.getElementById("allowed-values").disabled = true;
		} else {
			$("#allowed-values-group").attr("style","display:block;");
			document.getElementById("allowed-values").disabled = false;
		}
	
	}
	
	
	
	/*========================================================================*/
	/*============================    MAIN     ===============================*/
	/*========================================================================*/
	
	
jQuery(document).ready(function($){
    
	// activate the Object Icon Popover
	$('#object-icon-button').popover();   

	
	
    /*--------------------------------------------------*\
     * Context Menus for opening Edit Attribute Modals
    \*--------------------------------------------------*/

	
	$(document).on("contextmenu", "[data-object-type-id]" , function() {
		selected_object_type_id = $(this).attr("data-object-type-id");
	});
	/*
	$('[data-attribute-id]').focusin(function() {
	  selected_attribute_id = $(this).attr("data-attribute-id");
	  alert(selected_attribute_id)
	});*/

    $('html').contextMenu({
		selector: '[data-object-type-id]', 
		autoHide: 500,
        items: [
            {type: 'item', 
			 text: 'Edit Object Type',
			 click: function(e) {
				openEditObjectTypeModal(selected_object_type_id);
            }}
        ]
    });
	
    
});
</script>

