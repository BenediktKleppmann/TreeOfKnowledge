<!--                 EDIT OBJECT TYPE BEHAVIOUR MODAL                   -->
<!-- This is used in edit_simulation -->

{% load staticfiles %}
<!--<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" />-->
<link href="{% static 'css/contextmenu.min.css' %}" rel="stylesheet" />

<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
<script src="{% static 'js/contextmenu.js' %}"></script>

<script src="{% static 'js/bootstrap.min.js' %}"></script>

	
		
		
<style>	


	/* --- Context Menu -------------------------------------------- */
	
	.contextmenu-menu {
		z-index: 2060 !important;
	}
	/* --- Edit Attribute Modal -------------------------------------------- */
	
	#editObjectTypeModal .modal-dialog {
		width: 1200px;
	}

	#editObjectTypeModal .modal-header.row {
		margin-right: 0px;
		margin-left:0px;
		padding:9px;
		/*background: rgb(226, 226, 226);*/
	}
	
	#editObjectTypeModal .modal-body {
		padding-top: 12px;
		padding-left: 20px;
		padding-right:25px;
		padding-bottom: 0px;
		height: calc(100vh - 230px);
	}
	
	#editObjectTypeModal .modal-footer {
		padding: 8px;
		margin-top: 23px;
	}
	
	#editObjectTypeModal #modal-title {
		display: inline-block;
		font-size: 22px;
		margin-top: 16px;
		margin-left: 19px;
	}



	/* ---------------------------------------------------------------------------*/
	/*  Modal Header  ------------------------------------------------------------*/
	/* ---------------------------------------------------------------------------*/
	
	/* Object Icon Popover -----------------------------------------*/
	.popover {
		z-index: 1050;
	}
	
	
	#object-type-icon-button {
		display: inline-block;
		margin-top: 5px;
		margin-left: 22px;
		margin-bottom: 8px;
		height: 49px;
		width: 49px;		
		//background: rgb(235, 235, 235);
		border: 1px solid rgb(183, 183, 183);
		border-radius: 4px;
		padding-top: 5px;
		padding-left: 5px;
		padding-right: 3px;
	}
	
	.object-type-icon-box {
		height: 400px;
		overflow: auto;
		width: 265px;
	}
	
	.small-object-type-icon {
		height: 25px;
		width: 25px;
		background: rgb(249, 249, 249);
		border: 1px solid rgb(210, 210, 210);
		border-radius: 2px;
		box-shadow: -1px 1px 0px 2px rgba(0, 0, 0, 0.05);
		margin-top: 3px;
		margin-left: 1px;
		padding-top: 2px;
		padding-left: 2px;
		padding-right: 1px;
	}
	
	
	 #editObjectTypeModal .small-object-type-icon:hover {
		background: rgb(235, 235, 235);
	}
	
	#editObjectTypeModal  #x-button {
		display: inline-block;
		float: right;
		margin-top:14px; 
		margin-right:24px;
		font-size:29px
	}
	

	/* ---------------------------------------------------------------------------*/
	/*  Rules --------------------------------------------------------------*/
	/* ---------------------------------------------------------------------------*/
	
	#rule-block {}
	
	
							
	/* LEFT -----------------------------------------*/
	#rule-left-panel {
		display: inline-block;
		float: left;
	}

	.rule-left-block-header {
	    font-size: 16px;
		margin-bottom: 3px;
		margin-left: 5px;
	}
	
	#editObjectTypeModal #included-variables {
		border: 1px solid rgb(202, 202, 202);
		border-radius: 4px;
		width: 100%;
		height: calc(100vh - 380px);
		overflow: auto;
	}
	
	#editObjectTypeModal #remaining-variables {
		border: 1px solid rgb(202, 202, 202);
		border-radius: 4px;
		width: 100%;
		height: 140px;
		overflow: auto;
	}

	
	#editObjectTypeModal .list-group-item.listed-var-item{
		border-bottom: 1px solid rgb(202, 202, 202);
		margin-bottom: 0px;
		padding:0px;
	}

	#editObjectTypeModal .listed-var-button {
		background: white;
		padding-left: 0px;
		margin-left: 6px;
		min-width: 255px;
		text-align: left;
	}
	
	#editObjectTypeModal .listed-var-item > img {
		height: 18px;
		width: 12px;
		margin-left: 4px;
	}
	

	
	
	/* MIDDLE -----------------------------------------*/
	
	#rule-middle-panel {
		display: inline-block;	
		margin-left: 10px;
	}
	
	#rule-middle-panel h4 {
		display: inline-block;
	    margin-left: 11px;
		width: 500px;
	}
	
	#rule-block .learn-rule-title {
	    display: inline-block;
		float: right;
		margin-right: 39px;
		font-size: 16px;
		font-weight: 600;
		margin-top: 8px;
	}
	
	
	/* -- Rule Panels --*/
	#rule-panel-body {
		width: 700px;
		height:calc(100vh - 260px);
		overflow-y: auto;
		padding: 2px;
		-webkit-box-shadow: inset 1px 1px 9px 5px rgba(0,0,0,0.2);
		-moz-box-shadow: inset 1px 1px 59px 5px rgba(0,0,0,0.2);
		box-shadow: inset 1px 1px 9px 5px rgba(0,0,0,0.2);
		background-color: rgb(190, 190, 190);
		border-left: 5px solid rgb( 230, 230, 230);
		border-top: 5px solid rgb( 218, 218, 218);
		border-right: 5px solid rgb(250, 250, 250);
		border-bottom: 5px solid rgb(250, 250, 250);
	}
	
	#rules-list > .list-group-item {
		height: 57px;
		border-left: 9px solid rgb(252, 252, 252);
		border-top: 9px solid rgb(255, 255, 255);
		border-right: 9px solid rgb( 242, 242, 242);
		border-bottom: 9px solid rgb( 235, 235, 235);
		margin-bottom: 3px;
		border-radius: 3px;
		padding: 0px;
		-webkit-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		-moz-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		background-color: rgb(252, 252, 252);
	}
	

	
	#plus-button {
		-webkit-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.3);
		-moz-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.3);
		box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.3);
	}
	
	/* -- rule Panel Content --*/
	#plus-button-list-group-item {
		background-color: rgba(256, 256, 256, 0);
		padding: 17px;
		padding-left: 25px;
	}
	
	.rule-description {
		width: 620px;
		height: 46px;
		display: inline-block;
		float: left;
	}
	
	
	.rule-description .btn {
		display: inline-block;
		background-color: rgb(252, 252, 252);
		float: left;
		padding-bottom: 11px;
		width: 476px;
	}
	
	.rule-description .rule-probability {
		display: inline-block;
		margin-left: 15px;
		padding-top: 6px;
		float: left;
	}
	
	.rule-description .learn-probabililty-checkbox {
		display: inline-block;
		margin-left: 40px;
	}
	
	.rule-description .learn-probabililty-checkbox > input{
		margin-top: 10px;
	}
	
	
	
	
	.rule-text.form-control {
		height: 47px;
		width: 180px;
		border: 1px solid rgb(242,242,242);
		display: inline-block;
	}
	
	.if-block {
		float: left;
		display: inline-block;
		border: 1px solid rgb(220,220,220);
		border-radius: 7px;
		padding: 2px;
		margin-left: 1px;
		background-color: rgb(250, 250, 250);
	}
	.then-block {
		display: inline-block;
		margin-left: 20px;
		border: 1px solid rgb(220,220,220);
		border-radius: 7px;
		padding: 2px;
		margin-left: 5px;
		background-color: rgb(250, 250, 250);
	}
	
	.if-then-text {
		font-size: 14px;
		font-weight: 600;
		text-align: center;
		margin-top: -4px;
		margin-bottom: -2px;
		font-family: Garamond;
	}
	
	.then-fomula-left {
		display: inline-block;
		font-size: 13px;
		margin-right: 3px;
		margin-left: 3px;
		max-width: 160px;
		float: left;
	}
													
	
	.remove-rule-button {
		display: inline-block;
		float: right;
		height: 18px;
		width: 18px;
		padding: 0px;
		margin-top: 3px;
		margin-right: 2px;
		border-radius: 3px;
		background-color: rgb(242, 242, 242);
	}

	.remove-rule-button-text {
		margin-left: -1px;
		margin-top: -2px;
	}
	
	
		/*  Disabled  --------------------------------------------------------------------*/
	

	
	#rules-list > .list-group-item.disabled {
		background-color: rgb(240, 240, 240);
		color: rgb(160, 160, 160);
		border-right: 9px solid rgb(227, 227, 227);
		border-bottom: 9px solid rgb(230, 230, 230);
		border-left: 9px solid rgb( 242, 242, 242);
		border-top: 9px solid rgb( 247, 247, 247);
	}
	
	.disabled .rule-text 
	{
		background-color: rgb(252, 252, 252);
		color: rgb(160, 160, 160);
	}

	
	.disabled .p-value-number {
		background-color: rgb(240, 240, 240);
		border-color: rgb(240, 240, 240);
		color: rgb(160, 160, 160);
	}
</style>


	
	<!-- Edit Object Type Modal -->
	<div class="modal fade" id="editObjectTypeModal" tabindex="-1" role="dialog" aria-labelledby="chooseAttributeTitle" aria-hidden="true">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header row">
			<button type="button" id="object-type-icon-button" class="btn pull-left" style="display:inline-block;" data-container="body" data-toggle="popover" data-placement="bottom" data-html="true" title="Choose icon" data-content=''>
				<img src="{% static "images/object_icons/" %}si-glyph-mustache.svg">
			</button>
			<div class="modal-title object-type-name" id="modal-title"></div>
			<button id="x-button" type="button col-md-1" class="close" data-dismiss="modal" aria-label="Close"  onclick="closeObjectTypeModal()">
			  <span aria-hidden="true" >&times;</span>
			</button>
		  </div>
		  <div class="modal-body">
			  <div class="container-fluid">
				<div class="form">
					<div id="rule-block">
						<div id="rule-left-panel">
							<div class="rule-left-block-header">Use in Simulation:</div>
							<ul id="included-variables" class="list-group object-type-variable-selection"></ul>
							<div class="rule-left-block-header">Not Used:</div>
							<ul id="remaining-variables" class="list-group object-type-variable-selection"></ul>


						</div>
						<div id="rule-middle-panel">

						</div>
					</div>
				</div>
			</div>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-secondary" onclick="closeObjectTypeModal()" id="editAttributeCloseButton" data-dismiss="modal">Cancel</button>
			<button type="button" class="btn btn-primary" onclick="saveChanges()">Save Changes</button>
			<button type="button" class="btn btn-danger" onclick="deleteAttribute()">Delete Attribute</button>
		  </div>
		  
		</div>
	  </div>
	</div>
	
	
<script>

//GLOBAL VARIABLES
var selected_object_type_id = "n1";
var maximum_b_rule_number = 0;
var b_rules = {};

	
	
	/*========================================================================*/
	/*======================    BUILD THE MODAL     ==========================*/
	/*========================================================================*/
	
	function openEditObjectTypeModal(object_type_id){
	
		$("#editObjectTypeModal").modal('show');


		var object_type_name = available_object_types[object_type_id]['name'];
		var object_type_icon = available_object_types[object_type_id]['object_type_icon'];
		
		$(".object-type-name").each(function( index ) {
			$(this).html(object_type_name);
		});
		$("#object-type-icon-button > img").attr('src','{% static "images/object_icons/" %}' + object_type_icon + '.svg');
		
		// draw the Icon Popover 
		popover_content = 	'<div class="object-type-icon-box">' +
								'<table>';
		for (var row = 0; row < Math.ceil(object_icons.length/8) ; row++) {
			popover_content += 	'<tr>';
			for (var column = 0; column < 8 ; column++) {
				icon_number = row*8 + column;
				if (icon_number < object_icons.length) {
					popover_content += '<td>' + 
											'<div class="small-object-type-icon" onclick="changeObjectTypeIcon(\'' + object_type_id + '\', &#39;' + object_icons[icon_number] + '&#39;)">' +
												'<img src="{% static "images/object_icons/" %}' + object_icons[icon_number] + '.svg" %}">' +
											'</div>' +
										'</td>';
				}
			}
			popover_content += 		'</tr>';
		}
		popover_content += 	'</table>' +
						'</div>';
		$("#object-type-icon-button").attr('data-content',popover_content);
			
			
		
		// LEFT: List Variables	
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {

				included_variables = JSON.parse(this.responseText);
				
				included_variables_html_string = '';
				for (var i = 0; i < included_variables.length ; i++) {
					var attribute_id = included_variables[i]['id'];
					var attribute_name = included_variables[i]['name'];
					included_variables_html_string += 	'<li class="list-group-item listed-var-item"><img src="{% static "images/drag-grip2.png" %}"><button class="btn btn-outline-secondary listed-var-button" type="button" onclick="inspectBehaviourRulesForAttribute(\'' + object_type_id + '\', \'' + attribute_id + '\',\'' + attribute_name + '\')" scope="col">' + attribute_name + '</button></li>';
					
				}
				
				$('#included-variables').html(included_variables_html_string);	

			}
		};
		xhttp.open('GET', '/tool/get_available_variables?object_type_id=' + object_type_id , true);
		xhttp.send();
		
		
			


		
	
	}
	
	/*========================================================================*/
	/*=====================    MODAL FUNCTIONS     ===========================*/
	/*========================================================================*/
	
	

	
	// select variable on the left
	function inspectBehaviourRulesForAttribute(object_type_id, attribute_id, attribute_name) {
	
		// draw rule panel
		rule_panel_html = 		'<h4>Rules that change the ' + attribute_name + '</h4>' +
								'<div class="learn-rule-title">Learn Rule</div>' +
								'<div id="rule-panel-body">' +
								'<ul id="rules-list" class="list-group">' +
									'<li id="plus-button-list-group-item">' +
										'<button id="plus-button" type="button" class="btn btn-outline-dark" onclick="newBehariourRule()" >' +
											'<i class="fas fa-plus"></i>' +
										'</button>' +
									'</li>'
								'</ul>' +
							'</div>';
		$("#rule-middle-panel").html(rule_panel_html);
		
		
		request_body = {
			'filter_facts': '[]',
			'attribute_id': attribute_id,
			'object_type_id': object_type_id
		}
		 
		var xmlhttp = new XMLHttpRequest();       
		xmlhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				
				rules = JSON.parse(this.responseText);
				
				for (var i = 0; i < rules.length ; i++) {
					//var attribute_id = rules[i]['id'];
					//var attribute_name = rules[i]['name'];
					if (rules[i]['is_conditionless']) {
						rule_text = "At every timestep: [" + attribute_name + "] = " + rules[i]['effect_text'];
					} else {
						rule_text = "IF " +  rules[i]['condition_text'] + " THEN [" + attribute_name + "] = " + rules[i]['effect_text'];
					}
					
					if (rule_text.length > 75) {
						rule_text = rule_text.substring(0, 72) + '...';
					}
					
					if (rules[i]['has_probability_1']) {
						probability_text = " known fact";
					} else if (!has_probability_1 && typeof rules[i]['probability'] == 'undefined') {
						probability_text = " unknown";
					} else {
						probability_text =  Math.round(rules[i]['probability'] * 100) + " ±" + Math.round(rules[i]['standard_dev'] * 100) + " %";
					}
					
					/*
					var changed_var_attribute_id = rules[i]['id'];
					var condition_text = ;
					var condition_exec = rules[i]['id'];
					var effect_text = rules[i]['id'];
					var effect_exec = rules[i]['id'];
					var effect_is_calculation = rules[i]['id'];
					var used_attribute_ids = rules[i]['id'];
					var used_attribute_names = rules[i]['id'];
					var has_probability_1  = rules[i]['id'];*/
					
					
					rules_list_html_string = '<li class="list-group-item new" id="rule0">' +
												'<div class="rule-description">' +
													'<button class="btn btn-outline-secondary" onclick="inspectRule(' + rules[i]['id'] + ')" >' + rule_text + '</button>' +
													'<div class="rule-probability">' + probability_text + '</div>' + 
													'<div class="learn-probabililty-checkbox">' +
														'<input type="checkbox" id="learn-probabililty--rule' + rules[i]['id'] + '" name="learn-probabililty--rule' + rules[i]['id'] + '">' +
													'</div>' +
												'</div>' +
												'<button type="button" class="btn btn-secondary remove-rule-button" onclick="removeBehaviourRule(0)"><div class="remove-rule-button-text">&times;</div></button>' +
											'</li>';
											
											
										
					$(rules_list_html_string).insertBefore('#plus-button-list-group-item');
				}
				
				
				

			}
		};
		
		xmlhttp.open("POST", "/tool/get_attribute_rules/");
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		xmlhttp.send(JSON.stringify(request_body));	
		
		
		
		/*
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {

				b_rules = JSON.parse(this.responseText);
				
				included_variables_html_string = '';
				for (var i = 0; i < included_variables.length ; i++) {
					var attribute_id = included_variables[i]['id'];
					var attribute_name = included_variables[i]['name'];
					included_variables_html_string += 	'<li class="list-group-item listed-var-item"><button class="btn btn-outline-secondary listed-var-button" type="button" onclick="inspectBehaviourRulesForAttribute(\'' + attribute_id + '\',\'' + attribute_name + '\')" scope="col">' + attribute_name + '</button></li>';
					
				}
				
				$('#included-variables').html(included_variables_html_string);	

			}
		};
		xhttp.open('GET', '/tool/get_b_rules?attribute_id=' + attribute_id , true);
		xhttp.send();


		additional_b_rule_html_string = 	'<li class="list-group-item new" id="rule0">' +
												'<div class="rule-description">' +
													'<div class="if-block">' +
														'<div class="if-then-text">IF</div>' +
														'<textarea class="rule-text form-control" id="rule-text-if0" cols="20" rows="3" class="form-control" onclick="rememberCursorPostion(0)" onchange="checkBehaviourRule()"></textarea>' +
													'</div>' +
													'<div class="then-block">' +
														'<div class="if-then-text">THEN</div>' +
														'<div class="then-fomula-left">' + attribute_name + ' = </div>' +
														'<textarea class="rule-text form-control" id="rule-text-then0" cols="20" rows="3" class="form-control" onclick="rememberCursorPostion(0)" onchange="checkBehaviourRule()"></textarea>' +
													'</div>' +
												'</div>' +
												'<button type="button" class="btn btn-secondary remove-rule-button" onclick="removeBehaviourRule(0)"><div class="remove-rule-button-text">&times;</div></button>' +
											'</li>';
		
		$(additional_b_rule_html_string).insertBefore('#plus-button-list-group-item');
			
	*/
	
	}
	



	// X - Button
	function removeBehaviourRule(b_rule_number) {
		if (factor_number in specified_factors) {
			if ('score' in specified_factors[factor_number]) {
				 overall_score -= specified_factors[factor_number]['score'];
			}
		}

		//remove from specified_factors
		delete specified_factors[factor_number];

		//remove from sorted_factor_numbers
		var index = sorted_factor_numbers.indexOf(factor_number);
		if (index > -1) {
		   sorted_factor_numbers.splice(index, 1);
		}
	
	
		
		//remove from html
		var selected_factor = document.getElementById('factor' + factor_number);
		selected_factor.parentNode.removeChild(selected_factor);
		
		
		displayLearnedRuleAndScore();
	}



	
	// the '+'-Button
	function newFactor() {
	
		new_factor_number = 0;
		var factor_numbers = Object.keys(specified_factors);
		if (factor_numbers.length > 0) {
			new_factor_number = Math.max(...factor_numbers) + 1;
		}
		
		additional_factor_html_string = '<li class="list-group-item new" id="factor' + new_factor_number + '">' +
											'<div class="factor-description">' +
												'<textarea class="factor-text form-control" id="factor-text' + new_factor_number + '" cols="20" rows="3" class="form-control" onclick="rememberCursorPostion(' + new_factor_number + ')" onchange="checkFactor()"></textarea>' +
											'</div>' +
											'<button type="button" class="btn btn-secondary remove-factor-button" onclick="removeFactor(' + new_factor_number + ')"><div class="remove-factor-button-text">&times;</div></button>' +
										'</li>';
	
		$(additional_factor_html_string).insertBefore('#plus-button-list-group-item');
		
		specified_factors[new_factor_number] = {'factor_text': '',
											    'factor_transformation': ''};
		sorted_factor_numbers.push(new_factor_number);
	}
		
	
	
	
	
	
	
	
	
	
	
	
	
	
	
		
	/*=============  ICON CHANGE  ================================================================ */
	function changeObjectTypeIcon(object_type_id, object_type_icon) {
		//change in Modal Header
		$("#object-type-icon-button > img").attr('src','{% static "images/object_icons/" %}' + object_type_icon + '.svg');
		
		//change in available_object_types
		available_object_types[object_type_id]['object_type_icon'] = object_type_icon;
		
		//change on Left Toolbar
		$("#objects-table .object-icon ").each(function( index ) {
			if ($(this).attr('data-object-type-id') == object_type_id) {
				$(this).children().attr('src','{% static "images/object_icons/" %}' + object_type_icon + '.svg')
			}
		});
		
		
		// Change the Object-Type's Icon in the backend
		request_body = {'object_type_id': object_type_id,
						'object_type_icon': object_type_icon}

		var xmlhttp = new XMLHttpRequest();  
		xmlhttp.open("POST", "/tool/save_changed_object_type_icon/");
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		xmlhttp.send(JSON.stringify(request_body));
		//change on Paper
		/*
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			
				var svg_text = this.responseText.replace(/\n/g, '');
				cell = graph.getCell(object_number); 
				cell.attr('image/xlink:href', 'data:image/svg+xml;utf8,' + encodeURIComponent(svg_text));
			}
		};
		xhttp.open('GET', '{% static "images/object_icons/" %}' + object_type_icon + '.svg', true);
		xhttp.send();
		*/
	}	
		
		
		
		
	
	
	/*=============  'Save Changes' BUTTON  ================================================================ */	
	function saveChanges() {
		
		var attribute_id = $("#attribute_id").val();
		var name = $("#editAttributeModal #name").val();
		var description = $("#editAttributeModal #description").val();
		var expected_valid_period = $("#editAttributeModal #expected_valid_period").val();
		var first_applicable_object_type = $("#editAttributeModal #first_applicable_object_type").val();
		var type = $("#editAttributeModal #type_edit").val();
		var min = $("#editAttributeModal #min").val();
		var max = $("#editAttributeModal #max").val();
		var min_length = $("#editAttributeModal #min_length").val();
		var max_length = $("#editAttributeModal #max_length").val();
		var allowed_values = $("#editAttributeModal #allowed_values").val();
		
		message_body = {} 
		message_body['attribute_id'] = parseInt(attribute_id);
		message_body['name'] = name;
		message_body['data_type'] = type;
		message_body['description'] = description;
		message_body['expected_valid_period'] = expected_valid_period;
		message_body['first_applicable_object_type'] = first_applicable_object_type;
		message_body['format_specification'] = {}
		message_body['format_specification']['fields'] = {}
		message_body['format_specification']['fields']['column'] = {}
		message_body['format_specification']['fields']['column']['type'] = type;
		
		if (name.length < 2) {
			alert("Attribute Name too short");
			return;
		}
		
		if (expected_valid_period=="") {
			alert("Please specify an estimated valid time (from the dropdown beneath 'Description')");
			return;		
		}
		
		
		if (type == "") {
			alert("Data Type required");
			return;
		}
		
		
		if (type == "string") {
			if (isNaN(min_length) || min_length[0] == " " || min_length == ""){
				alert("Min Length - this must be populated with an integer number");
				return;
			}
			if (isNaN(max_length) || max_length[0] == " " || max_length == ""){
				alert("Max Length - this must be populated with an integer number");
				return;
			}

			min_length = parseInt(min_length);
			max_length = parseInt(max_length);
			
			if (max_length <= min_length) {
				alert("'Maximum string length' must be bigger than 'Minimum string length'");
				return;
			}
			
			message_body['format_specification']['fields']['column']['min_length'] = min_length;
			message_body['format_specification']['fields']['column']['max_length'] = max_length;
			
			if (($("#allowed-values-group").attr("style")=="display:block;") && (allowed_values_list != "")) {
				try {
					allowed_values_list  = JSON.parse(allowed_values)
					if (!Array.isArray(allowed_values_list)) {
						alert("Allowed Values - the value submitted here is not a list");
						return;
					} else {
						message_body['format_specification']['fields']['column']['allowed_values'] = allowed_values;
					}
				}
				catch(err) {
					alert("Allowed Values - the value submitted here is not a list");
					return;
				}
			}
		}
		
		if (["int", "real", "date"].includes(type)) {
			if (type == "int"){
				if(isNaN(min) || min[0] == " " || min == ""){
					alert("Min - this must be populated with an integer number");
					return;
				}
				if (isNaN(max) || max[0] == " " || max == ""){
					alert("Max - this must be populated with an integer number");
					return;
				}
				
				min = parseInt(min);
				max = parseInt(max);
				
				if (max <= min) {
					alert("Max must be bigger than Min");
					return;
				}
				
				message_body['format_specification']['fields']['column']['min'] = min;
				message_body['format_specification']['fields']['column']['max'] = max;
			}

			if (type == "real"){
				if(isNaN(min) || min[0] == " " || min == ""){
					alert("Min - this must be populated with a decimal number");
					return;
				}
				if (isNaN(max) || max[0] == " " || max == ""){
					alert("Max - this must be populated with a decimal number");
					return;
				}
				
				min = parseFloat(min);
				max = parseFloat(max);
				
				if (max <= min) {
					alert("Max must be bigger than Min");
					return;
				}
				
				message_body['format_specification']['fields']['column']['min'] = min;
				message_body['format_specification']['fields']['column']['max'] = max;
				
			}
			
		}

		var xmlhttp = new XMLHttpRequest();  
		xmlhttp.open("POST", "/tool/save_changed_attribute/");
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		xmlhttp.send(JSON.stringify(message_body));
	
		// CLEAN UP -------------------------
		// empty the input fields
		$("#name").val("");
		$("#description").val("");
		$("#expected_valid_period").val("");
		$("#type_edit").val("");
		$("#edited-attribute-further-fields").html("");
		
		//close the modal
		document.getElementById("editAttributeCloseButton").click();
		
		redrawAttributeSelections();
	}
	
	
	/*=============  'Delete Attribute' BUTTON  ================================================================ */	
	function deleteAttribute() {
		var attribute_id = $("#attribute_id").val();
		
		var xmlhttp = new XMLHttpRequest();  
		xmlhttp.open("POST", "/tool/delete_attribute/");
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		xmlhttp.send(JSON.stringify({'attribute_id':parseInt(attribute_id)}));
	
	}
	
	/*=============  'Cancel' BUTTON (or the X) ================================================================ */	
	function closeObjectTypeModal() {
	
		$("#editAttributeModal #name").val("");
		$("#editAttributeModal #attribute_id").val("");
		$("#editAttributeModal #description").html("");
		$("#editAttributeModal #expected_valid_period").val("");
		$("#editAttributeModal #first_applicable_object_type").val("");
		$("#editAttributeModal #type_edit").val("");		
		$("#edited-attribute-further-fields").html("");

	}
	
	
	
	/*=============  CHEDKBOX "CATEGORICAL" -> TOGGLE ALLOWED VALUES  ================================================================ */
	function toggleCategoricalField() {
		var displayed = $("#allowed-values-group").attr("style")=="display:block;";
		if (displayed) {
			$("#allowed-values-group").attr("style","display:none;");
			document.getElementById("allowed-values").disabled = true;
		} else {
			$("#allowed-values-group").attr("style","display:block;");
			document.getElementById("allowed-values").disabled = false;
		}
	
	}
	
	
	
	/*========================================================================*/
	/*============================    MAIN     ===============================*/
	/*========================================================================*/
	
	
jQuery(document).ready(function($){
    
	// activate the Object Icon Popover
	$('#object-type-icon-button').popover();   

	
	
    /*--------------------------------------------------*\
     * Context Menus for opening Edit Attribute Modals
    \*--------------------------------------------------*/

	
	$(document).on("contextmenu", "[data-object-type-id]" , function() {
		selected_object_type_id = $(this).attr("data-object-type-id");
	});
	/*
	$('[data-attribute-id]').focusin(function() {
	  selected_attribute_id = $(this).attr("data-attribute-id");
	  alert(selected_attribute_id)
	});*/

    $('html').contextMenu({
		selector: '[data-object-type-id]', 
		autoHide: 500,
        items: [
            {type: 'item', 
			 text: 'Edit Object Type',
			 click: function(e) {
				openEditObjectTypeModal(selected_object_type_id);
            }}
        ]
    });
	
    
});
</script>




<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.0/jquery-ui.js"></script>

<script>
	jQuery(document).ready(function($){
		
		/*---------------------------------------------------------------*\
		 * Drag & Drop  - for Variable selection/sorting in left panel
		\*---------------------------------------------------------------*/
		$(function() {
			$( ".object-type-variable-selection" ).sortable({
				connectWith: ".object-type-variable-selection",
				/*stop: function(event, ui) {
					var item_sortable_list_id = $(this).attr('id');
					console.log(ui);
					//alert($(ui.sender).attr('id'))
				},*/
				receive: function(event, ui) {
					alert("dropped on = "+this.id); // Where the item is dropped
					  alert("sender = "+ui.sender[0].id); // Where it came from
					  alert("item = "+ui.item[0].innerHTML); //Which item (or ui.item[0].id)
				}         
			}).disableSelection();
		});
		
		
	});
</script>
