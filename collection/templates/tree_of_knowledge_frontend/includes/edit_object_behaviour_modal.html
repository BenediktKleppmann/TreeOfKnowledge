<!--                 EDIT  OBJECT BEHAVIOUR MODAL                     -->
<!-- This is used in edit_simulation -->

{% load staticfiles %}
	
		
		
<style>	
	#editObjectBehaviourModal .modal-dialog {
		width: 1471px;
	}

	#editObjectBehaviourModal #modal-title {
		display: inline-block;
		font-size: 22px;
		margin-top: 16px;
		margin-left: 19px;
	}
	
	/* RULE PANELS -----------------------------------------*/
	#editObjectBehaviourModal .learn-rule-title {
	    margin-left: 569px;
		margin-bottom: 3px;
		font-weight: 700;
	}
	
	#editObjectBehaviourModal #rule-panel {
		display: inline-block;
	}
	
	.rule-panel-body {
		width: 700px;
		height:calc(100vh - 260px);
		overflow-y: auto;
		padding: 2px;
		-webkit-box-shadow: inset 1px 1px 9px 5px rgba(0,0,0,0.2);
		-moz-box-shadow: inset 1px 1px 59px 5px rgba(0,0,0,0.2);
		box-shadow: inset 1px 1px 9px 5px rgba(0,0,0,0.2);
		background-color: rgb(190, 190, 190);
		border-left: 5px solid rgb( 230, 230, 230);
		border-top: 5px solid rgb( 218, 218, 218);
		border-right: 5px solid rgb(250, 250, 250);
		border-bottom: 5px solid rgb(250, 250, 250);
	}
	
	#editObjectBehaviourModal #rules-list {
		height: 340px;
	}
	
	#editObjectBehaviourModal #not-used-rules-list {
		height: 150px;
	}
	
	#editObjectBehaviourModal #not-used-rules-title {
		font-size: 15px;
		margin-left: 5px;
	}
	
	/* RULE PANEL ITEMS -----------------------------------------*/
	
	#editObjectBehaviourModal .rule-panel-body > .list-group-item {
		height: 57px;
		border-left: 9px solid rgb(252, 252, 252);
		border-top: 9px solid rgb(255, 255, 255);
		border-right: 9px solid rgb( 242, 242, 242);
		border-bottom: 9px solid rgb( 235, 235, 235);
		margin-bottom: 3px;
		border-radius: 3px;
		padding: 0px;
		-webkit-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		-moz-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		background-color: rgb(252, 252, 252);
	}
	
	#editObjectBehaviourModal .rule-panel-body  img {
		height: 33px;
		width: 20px;
		float: left;
		margin-top: 2px;
		display: inline-block;
	}
	
	#editObjectBehaviourModal .rule-description {
		width: 470px;
	}
	
	#editObjectBehaviourModal .rule-description .btn {
		display: inline-block;
		background-color: rgb(252, 252, 252);
		float: left;
		padding-bottom: 11px;
		width: 476px;
		text-align: left;
	}
	
	#editObjectBehaviourModal .rule-probability {
		display: inline-block;
		margin-top: 7px;
		margin-left: 18px;
	}
	
	#editObjectBehaviourModal .learn-probabililty-checkbox {
		display: inline-block;
		margin-left: 26px;
	}
	
	#editObjectBehaviourModal #is_certain_fact {
	    margin-right: 7px;
	}
	/* RULE DETAILS -----------------------------------------*/
	#editObjectBehaviourModal #rule-info {
		display: inline-block;
		float: right;
	}
	
	#editObjectBehaviourModal #rule-details {
		display: inline-block;
		float: left;
		width: 430px;
		margin-right: 22px;
		margin-top: 11px;
	}
	

	
	#editObjectBehaviourModal #rule_type {
	   width: 200px;
		margin-bottom: 20px;
	}
	
	#editObjectBehaviourModal #is-certain-fact-field {
		margin-top: 10px
	}
	
	#editObjectBehaviourModal #rule-details .form-control {
		border-radius: 5px;
	}
	
	#editObjectBehaviourModal #chooseRuleSaveButton {
		margin-left: 5px;
	}
	
	/* AVAILABLE VARIABLES -----------------------------------------*/
	#editObjectBehaviourModal #available-variable-frame {
	    height: 420px;
		width: 219px;
	}
	
	
	#editObjectBehaviourModal #available-variables-block {
		display: inline-block;
	}


</style>


	
	<!-- Edit Object Behaviour Modal -->
	<div class="modal fade" id="editObjectBehaviourModal" tabindex="-1" role="dialog" aria-labelledby="chooseAttributeTitle" aria-hidden="true">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header row">
			<div class="modal-title object-type-name" id="modal-title"></div>
			<button id="x-button" type="button col-md-1" class="close" data-dismiss="modal" aria-label="Close"  onclick="closeObjectTypeModal()">
			  <span aria-hidden="true" >&times;</span>
			</button>
		  </div>
		  <div class="modal-body">
			  <div class="container-fluid">
				<div class="form">

					<div id="rule-panel">
						<div class="learn-rule-title">Learn Probability</div>
						<ul id="rules-list" class="list-group rule-panel-body"></ul>
						<div id="not-used-rules-title">Not Used Rules</div>
						<ul id="not-used-rules-list" class="list-group rule-panel-body"></ul>
					</div>
					<div id="rule-info">
						<div id="rule-info-top">
							<div id="rule-details"></div>
							<div id="available-variables-block"></div>
						</div>
						<div id="save-cancel-rule-buttons"></div>
					</div>
						
				</div>
			</div>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-primary" onclick="closeObjectTypeModal()" id="editAttributeCloseButton" data-dismiss="modal">Close</button>

		  </div>
		  
		</div>
	  </div>
	</div>
	
	

	
<script>

//GLOBAL VARIABLES
var new_rule_cursor_position = {};
var new_rule_cursor_textarea = '';
	
	
	/*========================================================================*/
	/*======================    BUILD THE MODAL     ==========================*/
	/*========================================================================*/
	
	
	
	function openEditObjectBehaviourModal(object_number, rules_attribute_id, rules_attribute_name){
		$("#editObjectBehaviourModal").modal('show');

		var object_name = objects_dict[object_number]['object_name'];
		$("#editObjectBehaviourModal #modal-title").html('Rules for ' + rules_attribute_name + ' of ' + object_name);
	
		populateTheRulePanels(object_number, rules_attribute_id, rules_attribute_name);
	}
	
	
	
	
	
	
	function populateTheRulePanels(object_number, rules_attribute_id, rules_attribute_name) {
		
		
		// populate rules-list -------------------------------------------------------------
		rules_list_html_string = '';
		
		var rule_ids = Object.keys(objects_dict[object_number]['object_rules'][rules_attribute_id]['used_rules'])
		for (var i = 0; i < rule_ids.length ; i++) {
			var rule_id = rule_ids[i];
			var rule = objects_dict[object_number]['object_rules'][rules_attribute_id]['used_rules'][rule_id];
			
			if (rule['is_conditionless']) {
				rule_text = "At every timestep: [" + rules_attribute_name + "] = " + rule['effect_text'];
			} else {
				rule_text = "IF " +  rule['condition_text'] + " THEN [" + rules_attribute_name + "] = " + rule['effect_text'];
			}
			
			if (rule_text.length > 75) {
				rule_text = rule_text.substring(0, 72) + '...';
			}
			
			checked_string = '';
			if (objects_dict[object_number]['object_rules'][rules_attribute_id]['used_rules'][rule_id]['learn_posterior'] == true) {checked_string = 'checked';}
			
			if (rule['has_probability_1']) {
				rule_info =	'<div class="rule-probability"> known fact</div>';
				
			} else if (!rule['has_probability_1'] && rule['probability'] == null) {
			
				rule_info =	'<div class="rule-probability"> unknown</div>' + 
							'<div class="learn-probabililty-checkbox">' +
								'<input type="checkbox" id="learn-probabililty--rule' + rule_id + '" name="learn-probabililty--rule' + rule_id + '" onchange="learnProbabilityChange(' + object_number + ',' + rules_attribute_id + ',' + rule_id + ')" ' + checked_string + '>' +
							'</div>';		
			} else {
				rule_info =	'<div class="rule-probability"> ' + Math.round(rule['probability'] * 100) + ' Â±' + Math.round(rule['standard_dev'] * 100) + ' %</div>' + 
							'<div class="learn-probabililty-checkbox">' +
								'<input type="checkbox" id="learn-probabililty--rule' + rule_id + '" name="learn-probabililty--rule' + rule_id + '" onchange="learnProbabilityChange(' + object_number + ',' + rules_attribute_id + ',' + rule_id + ')" ' + checked_string + '>' +
							'</div>';
			}
			

			
			
			rules_list_html_string +=	'<li class="list-group-item new" id="rule' + rule_id + '" data-object-number=' + object_number + ' data-attribute-id=' + rules_attribute_id + ' data-rule-id=' + rule_id + '>' +
											'<img src="{% static "images/drag-grip1.png" %}">' +
											'<div class="rule-description">' +
												'<button class="btn btn-outline-secondary" onclick="inspectRule(' + object_number + ',' + rules_attribute_id + ',\'' + rules_attribute_name + '\',' + rule_id +')" >' + rule_text + '</button>' +
											'</div>' +
											rule_info +
											'<button type="button" class="btn btn-secondary remove-rule-button" onclick="removeBehaviourRule(' + object_number + ', ' + rules_attribute_id + ', ' + rule_id + ')"><div class="remove-rule-button-text">&times;</div></button>' +
										'</li>';
									
		}
		
		rules_list_html_string += 	'<li id="plus-button-list-group-item">' +
										'<button id="plus-button" type="button" class="btn btn-outline-dark" onclick="newBehaviourRule(' + object_number + ',' + rules_attribute_id + ',\'' + rules_attribute_name + '\')" >' +
											'<i class="fas fa-plus"></i>' +
										'</button>'
									'</li>'
		
		$('#rules-list').html(rules_list_html_string);
		
		// populate not-used-rules-list -------------------------------------------------------------
		
		not_used_rules_list_html_string = ""
		var not_used_rule_ids = Object.keys(objects_dict[object_number]['object_rules'][rules_attribute_id]['not_used_rules'])
		for (var i = 0; i < not_used_rule_ids.length ; i++) {
			var rule_id = not_used_rule_ids[i];
			var rule = objects_dict[object_number]['object_rules'][rules_attribute_id]['not_used_rules'][rule_id];
			
			if (rule['is_conditionless']) {
				rule_text = "At every timestep: [" + rules_attribute_name + "] = " + rule['effect_text'];
			} else {
				rule_text = "IF " +  rule['condition_text'] + " THEN [" + rules_attribute_name + "] = " + rule['effect_text'];
			}
			
			if (rule_text.length > 75) {
				rule_text = rule_text.substring(0, 72) + '...';
			}
			
			if (rule['has_probability_1']) {
				rule_info =	'<div class="rule-probability"> known fact</div>';
				
			} else if (!rule['has_probability_1'] && rule['probability'] == null) {
			
				rule_info =	'<div class="rule-probability"> unknown</div>' + 
							'<div class="learn-probabililty-checkbox">' +
								'<input type="checkbox" id="learn-probabililty--rule' + rule_id + '" name="learn-probabililty--rule' + rule_id + '" onchange="learnProbabilityChange(' + object_number + ',' + rules_attribute_id + ',' + rule_id + ')" checked>' +
							'</div>';

			} else {
				rule_info =	'<div class="rule-probability"> ' + Math.round(rule['probability'] * 100) + ' Â±' + Math.round(rule['standard_dev'] * 100) + ' %</div>' + 
							'<div class="learn-probabililty-checkbox">' +
								'<input type="checkbox" id="learn-probabililty--rule' + rule_id + '" name="learn-probabililty--rule' + rule_id + '" onchange="learnProbabilityChange(' + object_number + ',' + rules_attribute_id + ',' + rule_id + ')" checked>' +
							'</div>';
			}
			

			
			
			not_used_rules_list_html_string +=	'<li class="list-group-item new" id="rule' + rule_id + '" data-object-number=' + object_number + ' data-attribute-id=' + rules_attribute_id + ' data-rule-id=' + rule_id + '>' +
											'<img src="{% static "images/drag-grip1.png" %}">' +
											'<div class="rule-description">' +
												'<button class="btn btn-outline-secondary" onclick="inspectRule(' + object_number + ',' + rules_attribute_id + ',\'' + rules_attribute_name + '\',' + rule_id +')" >' + rule_text + '</button>' +
											'</div>' +
											rule_info +
											'<button type="button" class="btn btn-secondary remove-rule-button" onclick="removeBehaviourRule(' + object_number + ', ' + rules_attribute_id + ', ' + rule_id + ')"><div class="remove-rule-button-text">&times;</div></button>' +
										'</li>';
									
		}
		

		
		$('#not-used-rules-list').html(not_used_rules_list_html_string);
	
			
	
			
	}
	
	
	

	
	
	
	
	
	/*========================================================================*/
	/*======================       RULE PANEL       ==========================*/
	/*========================================================================*/
	
	
	
	
	
	function inspectRule(object_number, rules_attribute_id, rules_attribute_name, rule_id) {
		$("#editObjectBehaviourModal").modal('show');


		// Populate the Modal
		if (Object.keys(objects_dict[object_number]['object_rules'][rules_attribute_id]['used_rules']).includes(String(rule_id))) {
			rule = objects_dict[object_number]['object_rules'][rules_attribute_id]['used_rules'][rule_id];
		} else {
			rule = objects_dict[object_number]['object_rules'][rules_attribute_id]['not_used_rules'][rule_id];
		}
		
		certain_fact_checked_string = rule['has_probability_1'] ? 'checked': '';
		
		if (rule['is_conditionless']) {	

			rule_details_html = '<div class="form-group">' +
									'<label for="rule_type">Rule Type</label>' +
									'<select id="rule_type" class="form-control" onchange="changeRuleType(\'' + rules_attribute_name + '\')">' +
										'<option>Conditional Rule</option>' +
										'<option selected>Continuous Change</option>' +
									'</select>' +
								'</div>' + 
								'<div id="rule-details-main">' + 
									'<div class="form-group">' + 
										'<label for="rule-effect-text">' + rules_attribute_name + ' = </label>' +
										'<textarea cols="20" rows="5" class="form-control" id="rule-effect-text" onclick="rememberCursorPostion(\'rule-effect-text\')">' + rule['effect_text'] + '</textarea>' +
									'</div>' +
									'<div id="is-certain-fact-field">' +
										'<input type="checkbox" class="form-check-input" id="is_certain_fact" ' + certain_fact_checked_string + '>' +
										'<label class="form-check-label" for="is_certain_fact">Is Known Fact</label>' +
									'</div>' +
								'</div>';
		} else {

			rule_details_html = '<div class="form-group">' +
									'<label for="rule_type">Rule Type</label>' +
									'<select id="rule_type" class="form-control" onchange="changeRuleType(\'' + rules_attribute_name + '\')">' +
										'<option selected>Conditional Rule</option>' +
										'<option>Continuous Change</option>' +
									'</select>' +
								'</div>' + 
								'<div id="rule-details-main">' + 
									'<div class="form-group">' + 
										'<label for="rule-condition-text">IF</label>' +
										'<textarea cols="20" rows="5" class="form-control" id="rule-condition-text" onclick="rememberCursorPostion(\'rule-condition-text\')">' + rule['condition_text'] + '</textarea>' +
									'</div>' +
									'<div class="form-group">' + 
										'<label for="rule-effect-text">THEN ' + rules_attribute_name + ' = </label>' +
										'<textarea cols="20" rows="5" class="form-control" id="rule-effect-text" onclick="rememberCursorPostion(\'rule-effect-text\')">' + rule['effect_text'] + '</textarea>' +
									'</div>' +
									'<div id="is-certain-fact-field">' +
										'<input type="checkbox" class="form-check-input" id="is_certain_fact" ' + certain_fact_checked_string + '>' +
										'<label class="form-check-label" for="is_certain_fact">Is Known Fact</label>' +
									'</div>' +
								'</div>';
		}
							
		
		
		$('#rule-details').html(rule_details_html);
		

		available_variables_html = 	'<div class="available-variables-label">Available Variables:</div>' + 
											'<input type="text" class="form-control" id="selectAvailableVariable" onkeyup="filterAvailableVariables();" placeholder=" Search">' + 
											'<div id="available-variable-frame">' + 
												'<ul id="available-variables" class="input-group list-group">';
			
		var object_attributes = objects_dict[object_number]['object_attributes'];
		var attribute_ids = Object.keys(object_attributes);
		for (var i = 0; i < attribute_ids.length ; i++) {
			var attribute_id = attribute_ids[i];
			var attribute_name = object_attributes[attribute_id]['attribute_name']
			available_variables_html += 		'<li class="list-group-item avail-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="selectAvailableVariable(' + object_number + ',\'' + attribute_name + '\')" scope="col">' + attribute_name + '</button></li>';
		}
		for (var i = 0; i < delta_t_list.length ; i++) {
			var delta_t_name = delta_t_list[i];
			available_variables_html += 		'<li class="list-group-item avail-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="selectAvailableVariable(' + object_number + ',\'' + delta_t_name + '\')" scope="col">' + delta_t_name + '</button></li>';
		}
		
		
		available_variables_html += 		'</ul>' + 
											'</div>';

		$('#available-variables-block').html(available_variables_html);
		
		
		var save_button_html_string =  	'<button type="button" class="btn btn-secondary" id="cancelNewRuleButton" onclick="cancelRuleCreation()">Cancel</button>' +
										'<button type="button" class="btn btn-primary" id="chooseRuleSaveButton" onclick="saveBehaviourRule(' + rule_id + ', ' + rules_attribute_id + ',\'' + rules_attribute_name + '\',' + object_number + ')">Save Rule</button>';
		
		$('#save-cancel-rule-buttons').html(save_button_html_string);		
	
	}
	
	
	
	
	// the '+'-Button
	function newBehaviourRule(object_number, rules_attribute_id, rules_attribute_name) {


		// Populate the Modal
		rule_details_html = '<div class="form-group">' +
								'<label for="rule_type">Rule Type</label>' +
								'<select id="rule_type" class="form-control" onchange="changeRuleType(\'' + rules_attribute_name + '\')">' +
									'<option selected>Conditional Rule</option>' +
									'<option>Continuous Change</option>' +
								'</select>' +
							'</div>' + 
							'<div id="rule-details-main"></div>';

		
		$('#rule-details').html(rule_details_html);
		changeRuleType(rules_attribute_name);
		

		available_variables_html = 	'<div class="available-variables-label">Available Variables:</div>' + 
											'<input type="text" class="form-control" id="selectAvailableVariable" onkeyup="filterAvailableVariables();" placeholder=" Search">' + 
											'<div id="available-variable-frame">' + 
												'<ul id="available-variables" class="input-group list-group">';
			
		var object_attributes = objects_dict[object_number]['object_attributes'];
		var attribute_ids = Object.keys(object_attributes);
		for (var i = 0; i < attribute_ids.length ; i++) {
			var attribute_id = attribute_ids[i];
			var attribute_name = object_attributes[attribute_id]['attribute_name']
			available_variables_html += 		'<li class="list-group-item avail-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="selectAvailableVariable(' + object_number + ',\'' + attribute_name + '\')" scope="col">' + attribute_name + '</button></li>';
		}
		for (var i = 0; i < delta_t_list.length ; i++) {
			var delta_t_name = delta_t_list[i];
			available_variables_html += 		'<li class="list-group-item avail-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="selectAvailableVariable(' + object_number + ',\'' + delta_t_name + '\')" scope="col">' + delta_t_name + '</button></li>';
		}
		
		
		available_variables_html += 		'</ul>' + 
											'</div>';

		$('#available-variables-block').html(available_variables_html);
		
		
		
		var save_button_html_string =  	'<button type="button" class="btn btn-secondary" id="cancelNewRuleButton" onclick="cancelRuleCreation()">Cancel</button>' +
										'<button type="button" class="btn btn-primary" id="chooseRuleSaveButton" onclick="saveBehaviourRule(null, ' + rules_attribute_id + ',\'' + rules_attribute_name + '\',' + object_number + ')">Save Rule</button>';
		
		$('#save-cancel-rule-buttons').html(save_button_html_string);
	}
	
	
	
	// X - Button  - when pressed from rules-list
	function removeBehaviourRule(object_number, attribute_id, rule_id) {
		
		// if the Rule Item is in the rules-list, then move it to the not-used-rules-list
		if (Object.keys(objects_dict[object_number]['object_rules'][attribute_id]['used_rules']).includes(String(rule_id))){
			// move it in the data
			objects_dict[object_number]['object_rules'][attribute_id]['not_used_rules'][rule_id] = objects_dict[object_number]['object_rules'][attribute_id]['used_rules'][rule_id];
			delete objects_dict[object_number]['object_rules'][attribute_id]['used_rules'][rule_id];

			// move it on the html
			not_used_rules_list = document.getElementById('not-used-rules-list');
			the_deleted_item = document.getElementById('rule' + rule_id);
			not_used_rules_list.appendChild(the_deleted_item);
		}
		
		// if the Rule Item is in the not-used-rules-list, delete it permanently
		else {
			var ok_given = confirm("Permanently delete this rule?");
			if (ok_given == false){return;}
			
			// delete it from the backend
			var xmlhttp = new XMLHttpRequest();  
			xmlhttp.open("POST", "/tool/delete_rule/");
			xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
			xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
			xmlhttp.send(JSON.stringify({'rule_id':rule_id}));
			
			// delete it from the frontend
			delete objects_dict[object_number]['object_rules'][attribute_id]['not_used_rules'][rule_id];
			the_deleted_item = document.getElementById('rule' + rule_id).remove();
		}
	}
	
	
	
	// Learn-Probability Checkbox
	function learnProbabilityChange(object_number,attribute_id, rule_id) {
		var learn_posterior  = document.getElementById("learn-probabililty--rule" + rule_id).checked;
		objects_dict[object_number]['object_rules'][attribute_id]['used_rules'][rule_id]['learn_posterior'] = learn_posterior;
	}
	
	
	
	
	
	/*========================================================================*/
	/*======================       RULE DETAILS       ==========================*/
	/*========================================================================*/
	
	
	
	

	
	
	function changeRuleType(attribute_name) {
		var rule_type = $('#rule_type').find(":selected").text();
		if (rule_type == 'Continuous Change'){
			rule_details_main_html = 	'<div class="form-group">' + 
											'<label for="rule-effect-text">' + attribute_name + ' = </label>' +
											'<textarea id="rule-effect-text" cols="20" rows="5" class="form-control" onclick="rememberCursorPostion(\'rule-effect-text\')"></textarea>' +
										'</div>' +
										'<div id="is-certain-fact-field">' +
											'<input type="checkbox" class="form-check-input" id="is_certain_fact">' +
											'<label class="form-check-label" for="is_certain_fact">Is Known Fact</label>' +
										'</div>';
				$('#rule-details-main').html(rule_details_main_html);
		} else if (rule_type == 'Conditional Rule'){
			rule_details_main_html = 	'<div class="form-group">' + 
											'<label for="rule-condition-text">IF</label>' +
											'<textarea id="rule-condition-text" cols="20" rows="5" class="form-control" onclick="rememberCursorPostion(\'rule-condition-text\')"></textarea>' +
										'</div>' +
										'<div class="form-group">' + 
											'<label for="rule-effect-text">THEN ' + attribute_name + ' = </label>' +
											'<textarea id="rule-effect-text" cols="20" rows="5" class="form-control" onclick="rememberCursorPostion(\'rule-effect-text\')"></textarea>' +
										'</div>' +
										'<div id="is-certain-fact-field">' +
											'<input type="checkbox" class="form-check-input" id="is_certain_fact" >' +
											'<label class="form-check-label" for="is_certain_fact">Is Known Fact</label>' +
										'</div>';
			$('#rule-details-main').html(rule_details_main_html);
		}
	}
	
	
	function cancelRuleCreation() {
		$('#rule-details').html('');
		$('#available-variables-block').html('');
		$('#save-cancel-rule-buttons').html('');		
	}
	
	
	
	function rememberCursorPostion(text_area_id) {
		var myElement = document.getElementById(text_area_id);
		var startPosition = myElement.selectionStart;
		var endPosition = myElement.selectionEnd;
		
		new_rule_cursor_position = {'startPosition':startPosition, 'endPosition':endPosition};	
		new_rule_cursor_textarea = text_area_id;
	}
	
	function selectAvailableVariable(object_number, attribute_name) {
		var rule_text = document.getElementById(new_rule_cursor_textarea).value;
		var new_rule_text = rule_text.substring(0, new_rule_cursor_position['startPosition']) + '[' + attribute_name + ']' + rule_text.substring(new_rule_cursor_position['endPosition'], rule_text.length);
		document.getElementById(new_rule_cursor_textarea).value = new_rule_text;
	}
	
	
	
	
	
	
	

	
		
		
		
	/*========================================================================*/
	/*=======================    SAVE RULE     ===============================*/
	/*========================================================================*/
	
	
	function make_executable(rule_text, object_number) {
		var has_error = false;
		var error_message = ""
		var used_attribute_ids = []
		
		
		// 0 CHECKS
		// I know it is idiotic to do security checks on the client side - I'll move this to the backend asap
		if (rule_text.length == 0) {
			error_message += 'Rule text missing; ';
			has_error = true;
		} else if (rule_text.length >= 500) {
			error_message += 'The Rule is ' + rule_text.length + ' characters long. Maximally 500 are allowed; ';
			has_error = true;
		}
		
		// Checking the Rule Text - only the commands in permitted_substrings are allowed==================
		//1 - REMOVING/REPLACING DELTA_T
		var executable = rule_text;
		var stripped_rule_text = rule_text;
		for (var i = 0; i < delta_t_list.length; i++) {
			var search_value = '[' + delta_t_list[i] + ']';
			executable = executable.split(search_value).join('(df.delta_t/' + timestep_units[i] +')');
			stripped_rule_text = stripped_rule_text.split(search_value).join(' ');
		}
		
		//2 - REMOVING/REPLACING VARIABLES
		var available_attribute_ids = Object.keys(objects_dict[object_number]['object_attributes']);
		var available_attribute_names = [];
		for (var i = 0; i < available_attribute_ids.length; i++) {
			available_attribute_names.push(objects_dict[object_number]['object_attributes'][available_attribute_ids[i]]['attribute_name'])
		}
		for (var i = 0; i < available_attribute_ids.length; i++) {
			var search_value = '[' + available_attribute_names[i] + ']';
			if (executable.indexOf(search_value)>=0){
				var data_type = objects_dict[object_number]['object_attributes'][available_attribute_ids[i]]['attribute_data_type'];
				if (['string', 'date'].includes(data_type)){
					var replacement = '"df.attr' + String(available_attribute_ids[i]) + '"';
				} else {
					var replacement = 'df.attr' + String(available_attribute_ids[i]);
				}
				executable = executable.split(search_value).join(replacement);
				stripped_rule_text = stripped_rule_text.split(search_value).join(' ');
				
				used_attribute_ids.push(available_attribute_ids[i])
			}	
		}
		
		
		//3 - REMOVING THE REST
		//function-characters
		var permitted_characters = ['\\(','\\)','\\[','\\]','\\{','\\}','\\+','\\*','\\.','-','/','%','.',',',':'] 
		for (var i = 0; i < permitted_characters.length; i++) {
			stripped_rule_text = stripped_rule_text.replace(new RegExp(permitted_characters[i], 'g'), ' ');
		}		
		//removing permitted commands
		var permitted_substrings = ['if','and','or']
		for (var i = 0; i < permitted_substrings.length; i++) {
			stripped_rule_text = stripped_rule_text.replace(new RegExp(permitted_substrings[i], 'g'), '');
		}
		//removing empyt spaces
		stripped_rule__remaining_words = stripped_rule_text.split(" ");
		for (var i =0; i < stripped_rule__remaining_words.length; i++){
			if (stripped_rule__remaining_words[i] == ''){
				stripped_rule__remaining_words.splice(i, );
			}
		}
		//if there's still something remaining: ERROR
		if (stripped_rule__remaining_words.length > 0) {
			error_message += 'The following commands are not permitted in the Rule: ' + stripped_rule__remaining_words.join(',') + '; ';
			has_error = true;
		}
		
		
		
		executable_dict = { 'has_error':has_error,
						'error_message': error_message,
						'executable':executable,
						'used_attribute_ids':used_attribute_ids};
		return executable_dict;
	}
	
	
	
	function saveBehaviourRule(rule_id, attribute_id, attribute_name, object_number) {
		rule_dict = {}
		
		// setting: id, changed_var_attribute_id, has_probability_1, probability, standard_dev
		rule_dict['id'] = rule_id;
		rule_dict['changed_var_attribute_id'] = attribute_id;
		rule_dict['has_probability_1'] = $('#is_certain_fact').is(':checked');
		rule_dict['probability'] = null;
		rule_dict['standard_dev'] = null;
		rule_dict['learn_posterior'] = !rule_dict['has_probability_1'];
		
		
		// setting: condition_text, condition_exec, is_conditionless
		var used_attribute_ids = []
		var rule_type = $('#rule_type').find(":selected").text();
		if (rule_type == 'Conditional Rule'){
			var condition_text = $('#rule-condition-text').val();
			executable_dict = make_executable(condition_text, object_number);
			if (executable_dict['has_error']) {
				alert('Error with IF: ' + executable_dict['error_message']);
				return;
			}
			used_attribute_ids = executable_dict['used_attribute_ids'];
			rule_dict['condition_text'] = condition_text;
			rule_dict['condition_exec'] = executable_dict['executable'];
			rule_dict['is_conditionless'] = false;
	
		} else if (rule_type == 'Continuous Change'){	
			rule_dict['condition_text'] = '';
			rule_dict['condition_exec'] = '';
			rule_dict['is_conditionless'] = true;
		}
		
		
		// setting: effect_text, effect_exec
		var effect_text = $('#rule-effect-text').val().trim();
		executable_dict = make_executable(effect_text, object_number);
		if (executable_dict['has_error']) {
			alert('Error with THEN: ' + executable_dict['error_message']);
			return;
		}
		var effect_exec = executable_dict['executable']
		if (objects_dict[object_number]['object_attributes'][attribute_id]['attribute_data_type'] == 'int'){
			effect_exec = 'int(' + effect_exec + ')'
		} else if (objects_dict[object_number]['object_attributes'][attribute_id]['attribute_data_type'] == 'real'){
			effect_exec = 'float(' + effect_exec + ')'
		}
		rule_dict['effect_text'] = effect_text;
		rule_dict['effect_exec'] = effect_exec;
		
		
		// setting: used_attribute_ids
		$.each(executable_dict['used_attribute_ids'], function(i, el){   // append the new used_attribute_ids, if not found already in the list
			if($.inArray(el, used_attribute_ids) === -1) used_attribute_ids.push(el);
		});
		rule_dict['used_attribute_ids'] = used_attribute_ids;
		

		// setting: effect_is_calculation
		if (executable_dict['executable'].indexOf('df.') >=0) {
			rule_dict['effect_is_calculation'] = true;
		} else {
			rule_dict['effect_is_calculation'] = false;
			var effect_exec = rule_dict['effect_exec'];
			if (effect_exec[0] == "'" || effect_exec[0] == '"') {
				effect_exec = effect_exec.substring(1, effect_exec.length - 1);
			} else if (effect_exec.includes('.')){
				effect_exec = parseFloat(effect_exec);
			} else {
				effect_exec = parseInt(effect_exec);
			}
			rule_dict['effect_exec'] = JSON.stringify(effect_exec);
			
		}
		


		var xmlhttp = new XMLHttpRequest();  
		xmlhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			
				var new_rule_id = this.responseText;
				if (rule_id == null){
					objects_dict[object_number]['object_rules'][attribute_id]['execution_order'].push(new_rule_id);
				}
				
				objects_dict[object_number]['object_rules'][attribute_id]['used_rules'][new_rule_id] = rule_dict;
				populateTheRulePanels(object_number, attribute_id, attribute_name);	
			}
		};
		xmlhttp.open("POST", "/tool/save_rule/");
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		xmlhttp.send(JSON.stringify(rule_dict));
		
		// empty the right part of the modal
		cancelRuleCreation();
	}
	
	
	
	
	


</script>



<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.0/jquery-ui.js"></script>

<script>
	
	// in array, move element from one position to another
	function move(arr, old_index, new_index) {
		while (old_index < 0) {
			old_index += arr.length;
		}
		while (new_index < 0) {
			new_index += arr.length;
		}
		if (new_index >= arr.length) {
			var k = new_index - arr.length;
			while ((k--) + 1) {
				arr.push(undefined);
			}
		}
		 arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);  
	   return arr;
	}
	

	jQuery(document).ready(function($){
		
		/*---------------------------------------------------------------*\
		 * Drag & Drop  - for Variable selection/sorting in left panel
		\*---------------------------------------------------------------*/
		$(function() {
			$( ".rule-panel-body" ).sortable({
				connectWith: ".list-group",
				update: function(event, ui) {
					if (ui.sender == null && this.id == 'rules-list') {
						// move the + button to the bottom
						document.getElementById('rules-list').appendChild(document.getElementById('plus-button-list-group-item'));
					
						// move within rules-list
						var object_number = parseInt(ui.item[0].getAttribute('data-object-number'));
						var	attribute_id = parseInt(ui.item[0].getAttribute('data-attribute-id'));
						var	rule_id = parseInt(ui.item[0].getAttribute('data-rule-id'));
						
						execution_order = objects_dict[object_number]['object_rules'][attribute_id]['execution_order'];
						old_index = execution_order.indexOf(rule_id);
						new_index = ui.item.index();
						objects_dict[object_number]['object_rules'][attribute_id]['execution_order'] = move(execution_order, old_index, new_index);
					}
				},
				receive: function(event, ui) {					
					var object_number = parseInt(ui.item[0].getAttribute('data-object-number'));
					var	attribute_id = parseInt(ui.item[0].getAttribute('data-attribute-id'));
					var	rule_id = parseInt(ui.item[0].getAttribute('data-rule-id'));
					var sender = ui.sender[0].id;
					var receiver = this.id;
					
					if (receiver == 'not-used-rules-list' && sender == 'rules-list') {
						objects_dict[object_number]['object_rules'][attribute_id]['not_used_rules'][rule_id] = objects_dict[object_number]['object_rules'][attribute_id]['used_rules'][rule_id];
						delete objects_dict[object_number]['object_rules'][attribute_id]['used_rules'][rule_id];
						
						// update the execution_order
						var execution_order = objects_dict[object_number]['object_rules'][attribute_id]['execution_order'];
						old_index = execution_order.indexOf(rule_id);
						execution_order.splice(old_index,1);
						objects_dict[object_number]['object_rules'][attribute_id]['execution_order'] = execution_order;
					}
					
					if (receiver == 'rules-list' && sender == 'not-used-rules-list') {
						objects_dict[object_number]['object_rules'][attribute_id]['used_rules'][rule_id] = objects_dict[object_number]['object_rules'][attribute_id]['not_used_rules'][rule_id];
						delete objects_dict[object_number]['object_rules'][attribute_id]['not_used_rules'][rule_id];
						
						// move the + button to the bottom
						document.getElementById('rules-list').appendChild(document.getElementById('plus-button-list-group-item'));
						
						// update the execution_order
						new_index = ui.item.index();
						var execution_order = objects_dict[object_number]['object_rules'][attribute_id]['execution_order'];
						objects_dict[object_number]['object_rules'][attribute_id]['execution_order'] = execution_order.splice(new_index, 0, rule_id);
						
						
					}
				}         
			}).disableSelection();
		});
		
		
	});
</script>
