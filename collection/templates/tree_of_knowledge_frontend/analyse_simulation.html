{% extends 'layouts/base_tool.html' %}'
{% load staticfiles %}

{% block title %}
	Tree of Knowledge - Main Menu
{% endblock %}

{% block additionalcss %}
  <link href="https://cdn.anychart.com/releases/v8/css/anychart-ui.min.css?hcode=be5162d915534272a57d0bb781d27f2b" rel="stylesheet" type="text/css">
  <link href="https://cdn.anychart.com/releases/v8/fonts/css/anychart-font.min.css?hcode=be5162d915534272a57d0bb781d27f2b" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="{% static 'css/bootstrap-3.4.0.min.css' %}" />
	
<style>


	.content {
		padding: 0px;
	}

	/* --------------------------------------------------------------------------*/
	/* Panels -------------------------------------------------------------------*/
	/* --------------------------------------------------------------------------*/
	.left-panel {
		float:left;
		display: inline-block;
		width: 256px;
		height:calc(100vh - 59px);
		background: rgb(226, 226, 226);
	}
	
	.right-panel-container {
		display: inline-block;
		display: flex;
		flex-direction: column;
		border: 1px solid silver;
		overflow: hidden;
		xtouch-action: none; /* avoid browser level touch actions */
		height:calc(100vh - 59px);
	}

	#top-panel {
	  flex: 0 0 auto;  /* only manually resize */
	  height: 55%;
	  min-height: 150px;
	  width: 100%;
	  //white-space: nowrap;
	}

	#splitter {
	  flex: 0 0 auto;
	  height: 4px;  
	  background: rgb(225, 225, 225);
	  border: 1px solid rgb(200, 200, 200);
	  cursor: row-resize; 
	  box-shadow: 3px  0 6px 0 rgba(0, 0, 0, 0.19);
	  z-index: 1;
	}

	#bottom-panel {
	  flex: 1 1 auto;   /* resizable */
	  padding-right: 10px;
	  min-height: 200px;
	  width: 100%;
	  height: 100%;
	  overflow-x: scroll;
	}
	
	
	/* --------------------------------------------------------------------------*/
	/* Left Panel ---------------------------------------------------------------*/
	/* --------------------------------------------------------------------------*/
	
	.simulation-selection-area {
	    margin-top: 34px;
		margin-left: 15px;
		width: 217px;
	}
	
	
	#initial-state-simulation-selection-buttons {
		margin-top: 26px;
		max-height: 132px;
		overflow-y: auto;
	}
	
	#individual-simulation-selection-buttons {
		margin-top: 26px;
		max-height: calc(100vh - 400px);
		overflow-y: auto;
	}
	
	.simulation-selection-button {
		width: 100%;
		background: rgb(248, 248, 248);
		border: 1px solid rgb(210, 210, 210);
	}
	
	.simulation-selection-button.active {
		background: rgb(219, 219, 219)
	}
	
	/* --------------------------------------------------------------------------*/
	/* Bottom Panel ---------------------------------------------------------------*/
	/* --------------------------------------------------------------------------*/

	#bottom-object-items {
		list-style-type: none;
	}
 
	#bottom-object-items li {
		float: left;
	}
	
	.bottom-object-outer-box {
		background: rgb(220, 227, 250);
		padding-left: 9px;
		border: 1px solid rgb(100, 100, 100);
	}
	
	.collapse-triangle {
		padding: 6px;
		font-size: 10px;
	}
	
	.bottom-object-inner-box {
	    margin-left: 4px;
		margin-top: 3px;
		background: rgb(255,255,255);
		border-top: 1px solid rgb(100,100,100);
		border-left: 1px solid rgb(100,100,100);
		overflow: hidden;
	}
	
	.bottom-object-data-row {
		border-bottom: 1px solid rgb(190, 190, 190);
		display: block;
	}
	
	.bottom-attribute-name {
		display: inline-block;
		padding: 1px 5px 1px 5px;
		background: rgb(242, 242, 242);
		height: 100%;
		border-right: 1px solid rgb(190, 190, 190);
		border-bottom: 1px solid rgb(190, 190, 190);
		width: 175px;
	}
	
	.bottom-attribute-values {
		display: inline-block;	
	}
	
	.attribute-value {
		width: 55px;
		display: inline-block;
		text-align: center;
		border-right: 1px solid rgb(190, 190, 190);
		padding: 1px 0px 1px 0px;
		color: rgb(95, 95, 95);
	}
	
</style>	



{% endblock %}	

{% block content %}
<div class="left-panel">
	<div class="simulation-selection-area">
		<div class="simulation-selection-box">
			<button class="btn btn-light simulation-selection-button" type="button" onclick="selectAllSimulations()">All Simulations</button>
			<button class="btn btn-light simulation-selection-button" type="button" onclick="selectCorrectSimulations()">Correct Simulations</button>
			<button class="btn btn-light simulation-selection-button" type="button" onclick="selectFalseSimulations()">False Simulations</button>
		</div>
		<div id="initial-state-simulation-selection-buttons" class="simulation-selection-box"></div>
		<div id="individual-simulation-selection-buttons" class="simulation-selection-box"></div>
	</div>
</div>
<div class="right-panel-container">
	<div id="top-panel">
		<div id="linegraph-container"></div>
			<!--<div id="top-left-menu-bar">
				<div id="vertically-centered">
					<div class="inlude-zero-menu">
						<input type="checkbox" class="custom-control-input" id="inlcude-zero" onchange="displayNumericalAttribute(' + object_number + ', \'' + object_name + '\', \'' + attribute_name + '\', ' + object_id + ',' + attribute_id + ')">
						<label class="custom-control-label" for="inlcude-zero">&nbsp;Include 0 in Linegraph</label>
					</div>
					error_values_html_string 
					<button id="run-button" class="btn btn-primary pull-right" type="button" onclick="run()">Re-Run Simulation</button>
				</div>
			</div>-->
		</div>
	</div>

	<div id="splitter"></div>
	<div id="bottom-panel">	
		<ul id="bottom-object-items"></ul>
	</div>
</div>





<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
<script type="text/javascript" src="https://rawgit.com/RickStrahl/jquery-resizable/master/src/jquery-resizable.js"></script>


 
<script type="text/javascript">
	// GLOBAL VARIABLES:
	objects_dict = {{ simulation_model.objects_dict|safe }};
	just_learned_rules = {{ simulation_model.just_learned_rules|safe }};
	rule_infos = {{ simulation_model.rule_infos|safe }};
	triggered_rules = {{ simulation_model.triggered_rules|safe }};
	simulation_data = {{ simulation_model.simulation_data|safe }};
	errors = {{ simulation_model.errors|safe }};
	
	is_timeseries_analysis = {{ simulation_model.is_timeseries_analysis|yesno:"true,false" }};
	simulation_start_time = {{ simulation_model.simulation_start_time }};
    simulation_end_time = {{ simulation_model.simulation_end_time }};
    timestep_size = {{ simulation_model.timestep_size }};
	
	var number_of_periods;
	if (is_timeseries_analysis) {
		number_of_periods = Math.floor((simulation_end_time - simulation_start_time)/timestep_size) + 1;
	} else {
		number_of_periods = 1;
	}


	
	var selected_simulations = new Set(); 

			
	var clicked_selection_buttons = {'select_all_clicked': false, 'select_correct_clicked': false, 'select_false_clicked': false}
	
	/*


	
	var rules_list = {};	
	var new_rule_cursor_position = {};
	var new_rule_used_attribute_names = [];
	var new_rule_used_attribute_ids = [];
	var highlighted_words_dict = {};
	var delta_t_list = ['delta_t (years)', 'delta_t (months)', 'delta_t (days)', 'delta_t (hours)', 'delta_t (minutes)', 'delta_t (seconds)'];
	var timestep_units = [31622400, 2635200, 604800, 86400, 3600, 60, 1];
	var inlcude_zero = false;
	*/




	//==================================================================================================
	//==============================   LEFT PANEL      ===============================================
	//==================================================================================================

	

	//== draw buttons ================================================================================================
	function drawLeftPanel() {
	
		initial_state_ids = []; 
		var all_simulation_numbers = Object.keys(simulation_data);
		for (var i = 0; i < all_simulation_numbers.length; i++) {
			var initial_state_id = all_simulation_numbers[i].split('-')[0];
			if (!initial_state_ids.includes(initial_state_id)) {
				initial_state_ids.push(initial_state_id);
			}
		}	
		
		var initial_state_selection_buttons = '';
		for (var i = 0; i < initial_state_ids.length; i++) {
			initial_state_selection_buttons += '<button class="btn btn-light simulation-selection-button" type="button" onclick="selectSimulationsWithInitialState(' + initial_state_ids[i] + ')">All with Intital State ' + initial_state_ids[i] + '</button>';
		}	
		$('#initial-state-simulation-selection-buttons').html(initial_state_selection_buttons);
		
		var individual_selection_buttons = '';
		for (var i = 0; i < all_simulation_numbers.length; i++) {
			individual_selection_buttons += '<button id="selection-button-' + all_simulation_numbers[i] + '" class="btn btn-light simulation-selection-button simulation-toggle" type="button" onclick="selectSimulation(\'' + all_simulation_numbers[i] + '\')">Simulation ' + i + '</button>'
		}	
		$('#individual-simulation-selection-buttons').html(individual_selection_buttons);
	} 


	
	
	//All Simulations -------------------------------  
	
	function selectAllSimulations() {	
		if (clicked_selection_buttons['select_all_clicked']) {
			clicked_selection_buttons['select_all_clicked'] = false;
			
			selected_simulations = new Set()		
			$('.simulation-toggle').removeClass('active');
			$('#bottom-object-items').html('');
		} else {
			clicked_selection_buttons['select_all_clicked'] = true;
			
			all_simulation_numbers = Object.keys(simulation_data);
			for (var i = 0; i < all_simulation_numbers.length; i++) {
				selected_simulations.add(all_simulation_numbers[i]);
			}		
			$('.simulation-toggle').addClass('active');
			
			drawBottomPanel();
			fillBottomPanel('mean');
		}
	}
	
	//Correct Simulations  -------------------------------
	function selectCorrectSimulations() {
		if (clicked_selection_buttons['select_correct_clicked']) {
			clicked_selection_buttons['select_correct_clicked'] = false;
			
			for (var i = 0; i < errors['correct_simulations'].length; i++) {
				var simulation_number = errors['correct_simulations'][i];
				selected_simulations.delete(simulation_number);
				$('#selection-button-' + simulation_number).removeClass('active');
			}
				
		} else {
			clicked_selection_buttons['select_correct_clicked'] = true;
			
			for (var i = 0; i < errors['correct_simulations'].length; i++) {
				var simulation_number = errors['correct_simulations'][i];
				selected_simulations.add(simulation_number);
				$('#selection-button-' + simulation_number).addClass('active');
			}
		}
		drawBottomPanel();
		fillBottomPanel('mean');
	}
	
	//False Simulations  -------------------------------
	function selectFalseSimulations() {
		if (clicked_selection_buttons['select_false_clicked']) {
			clicked_selection_buttons['select_false_clicked'] = false;
			
			for (var i = 0; i < errors['false_simulations'].length; i++) {
				var simulation_number = errors['false_simulations'][i];
				selected_simulations.delete(simulation_number);
				$('#selection-button-' + simulation_number).removeClass('active');
			}
				
		} else {
			clicked_selection_buttons['select_false_clicked'] = true;
			
			for (var i = 0; i < errors['false_simulations'].length; i++) {
				var simulation_number = errors['false_simulations'][i];
				selected_simulations.add(simulation_number);
				$('#selection-button-' + simulation_number).addClass('active');
			}
		}
		drawBottomPanel();
		fillBottomPanel('mean');
	}
	
	//All with Initial State X  -------------------------------
	function selectSimulationsWithInitialState(initial_state_id) {
		if (clicked_selection_buttons['select_initial_state' + initial_state_id +'_clicked']) {
			clicked_selection_buttons['select_initial_state' + initial_state_id +'_clicked'] = false;
			
			var all_simulation_numbers = Object.keys(simulation_data);
			for (var i = 0; i < all_simulation_numbers.length; i++) {
				if (all_simulation_numbers[i].split('-')[0] == String(initial_state_id)) {
					selected_simulations.delete(all_simulation_numbers[i]);
					$('#selection-button-' + all_simulation_numbers[i]).removeClass('active');
				}
			}		
		} else {
			clicked_selection_buttons['select_initial_state' + initial_state_id +'_clicked'] = true;
			
			var all_simulation_numbers = Object.keys(simulation_data);
			for (var i = 0; i < all_simulation_numbers.length; i++) {
				if (all_simulation_numbers[i].split('-')[0] == String(initial_state_id)) {
					selected_simulations.add(all_simulation_numbers[i]);
					$('#selection-button-' + all_simulation_numbers[i]).addClass('active');
				}
			}	
		}
		drawBottomPanel();
		fillBottomPanel('mean');
	}
	
	//Simulation X  -------------------------------
	function selectSimulation(simulation_number) {
		if ($('#selection-button-' + simulation_number).hasClass('active')) {
			selected_simulations.delete(simulation_number);
			$('#selection-button-' + simulation_number).removeClass('active');
		} else {
			selected_simulations.add(simulation_number);
			$('#selection-button-' + simulation_number).addClass('active');
		}
		drawBottomPanel();
		fillBottomPanel('mean');
	}
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	//========================================================================
	//=====================    BOTTOM PANEL      =============================
	//========================================================================
	
	
	// Draw Object Boxes  -------------------------------
	function drawBottomPanel() {
		var object_items_html = '';
		
		var selected_simulations_list = Array.from(selected_simulations);
		if (selected_simulations_list.length > 0) {
			var object_numbers = Object.keys(objects_dict);
			for (var i = 0; i < object_numbers.length; i++) {
				var object_number = object_numbers[i];
				object_items_html = '<li class="bottom-object-item">' +
										'<div class="bottom-object-outer-box">' + objects_dict[object_number]['object_name'] + 
											'<span id="object-box-triangle-' + object_number + '" class="glyphicon glyphicon-triangle-top collapse-triangle" onclick="collapseExpandObjectInnerBox(' + object_number + ');"></span>' +
											'<div id="object-inner-box' + object_number + '" class="bottom-object-inner-box">';
				
				attribute_ids = Object.keys(objects_dict[object_number]['object_attributes']);
				for (var j = 0; j < attribute_ids.length; j++) {
					var attribute_id = attribute_ids[j];
					
					object_items_html += 		'<div class="bottom-object-data-row" style="width:' + String(178 + 57*(number_of_periods)) + 'px;">' +
													'<div class="bottom-attribute-name" onclick="displayLineGraph(' + object_number + ',' + attribute_id + ')">' + objects_dict[object_number]['object_attributes'][attribute_id]['attribute_name'] + '</div>' +
													'<div class="bottom-attribute-values">';
						
					for (var period_number = 0; period_number < number_of_periods; period_number++) {
						object_items_html += 			'<div id="' + object_number + '-' + attribute_id + '-' + period_number + '" class="attribute-value"></div>';
					}
					object_items_html += 			'</div>	' +
												'</div>';
				}
				object_items_html += 		'</div>	' +
										'</div>' + 						
									'</li>';
			}
		}
		
		$('#bottom-object-items').html(object_items_html);
	}
	
	
	

	
	// Fill in Values  -------------------------------
	function fillBottomPanel(metric) {
		
		var selected_simulations_list = Array.from(selected_simulations);
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			var object_number = object_numbers[i];
			
			var attribute_ids = Object.keys(objects_dict[object_number]['object_attributes']);
			for (var j = 0; j < attribute_ids.length; j++) {
				var attribute_id = attribute_ids[j];
				
				for (var period_number = 0; period_number < number_of_periods; period_number++) {
					
					// values
					var values = []
					for (var k = 0; k < selected_simulations_list.length; k++) {
						var simulation_number = selected_simulations_list[k];
						var column_name = 'obj' + String(object_number) + 'attr' + String(attribute_id);
						console.log(String(k) + '-' + simulation_number + '-' + column_name + '-' + period_number);
						values.push(simulation_data[simulation_number][column_name][period_number]);
					}
					
					// calculate the resulting value
					var resulting_value;
					var datatype = objects_dict[object_number]['object_attributes'][attribute_id]['attribute_data_type'];
					if (['real','int'].includes(datatype) && metric=='mean') { // -> average value
						sum_of_values = 0
						for (var l = 0; l < values.length; l++) {
							sum_of_values += values[l];
						}
						resulting_value = sum_of_values/selected_simulations_list.length;
					}
					
					if (['string', 'relation', 'bool'].includes(datatype)) {  // -> most common value
						var value_occurences = {}
						for (var l = 0; l < values.length; l++) {
							var value = values[l];
							if (Object.keys(value_occurences).includes(value)) {
								value_occurences[value] += 1;
							} else {
								value_occurences[value] = 0;
							}
						}
						
						var max_count = 0;
						var distinct_values = Object.keys(value_occurences);
						for (var l = 0; l < distinct_values.length; l++) {
							if (distinct_values[distinct_values[l]] > max_count) {
								resulting_value = distinct_values[l];
								max_count = distinct_values[distinct_values[l]];
							}
						}
					}
					
					// insert the resulting value
					$('#' + object_number + '-' + attribute_id + '-' + period_number).html(resulting_value);
						
				}
			}
		}
	}
		
		
		
	// Expand/Collapse Triangle -------------------------------
	function collapseExpandObjectInnerBox(object_number) {
		var span = $('#object-box-triangle-' + object_number)
		if (span.hasClass('glyphicon-triangle-top')) {
			span.removeClass('glyphicon-triangle-top');
			span.addClass('glyphicon-triangle-bottom');
			$('#object-inner-box' + object_number).animate({height: '0px'}, 200, 'linear');
			$('#object-inner-box' + object_number).css('border-width', '0px');
		} else {
			span.removeClass('glyphicon-triangle-bottom');
			span.addClass('glyphicon-triangle-top');
			$('#object-inner-box' + object_number).css('height', 'auto');
			$('#object-inner-box' + object_number).css('border-width', '1px');
		}
	}
	
		
	//========================================================================
	//========================   TOP PANEL   =================================
	//========================================================================
		
	function displayLineGraph(object_number, attribute_id) {
		
	}
	
	

	//========================================================================
	//========================    MAIN      ==================================
	//========================================================================
	
	drawLeftPanel();


	// make the Top Panel resizable
	 $("#top-panel").resizable({
	   handleSelector: "#splitter",
	   resizeHeight: true
	 });

	 $("#bottom-panel").resizable({
	   handleSelector: ".splitter-horizontal",
	   resizeWidth: true
	 });
	 
	
	 
</script>


<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.0/jquery-ui.js"></script>
<!--
<script>
	jQuery(document).ready(function($){
		
		/*---------------------------------------------------------------*\
		 * Drag & Drop  - for Variable selection/sorting in left panel
		\*---------------------------------------------------------------*/
		$(function() {
			$( "#bottom-object-items" ).sortable({
				connectWith: ".object-type-variable-selection",
				/*stop: function(event, ui) {
					var item_sortable_list_id = $(this).attr('id');
					console.log(ui);
					//alert($(ui.sender).attr('id'))
				},*/
				receive: function(event, ui) {
					//alert("dropped on = "+this.id); // Where the item is dropped
					//alert("sender = "+ui.sender[0].id); // Where it came from
					//alert("item = "+ui.item[0].innerHTML); //Which item (or ui.item[0].id)
				}         
			}).disableSelection();
		});
		
		
	});
</script>

-->


<script>
	jQuery(document).ready(function($){
		 $(function () {
			$("#bottom-object-items").sortable({
					/*start: function (event, ui) {
							ui.item.toggleClass("highlight");
					},
					stop: function (event, ui) {
							ui.item.toggleClass("highlight");
					}*/
			});
			$("#bottom-object-items").disableSelection();
		});
	});
</script>
	 

{% endblock %}



