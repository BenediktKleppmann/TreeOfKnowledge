{% extends 'layouts/base_tool.html' %}'
{% load staticfiles %}

{% block title %}
	Tree of Knowledge - Main Menu
{% endblock %}

{% block additionalcss %}

<style>

	@font-face { font-family: 'Aileron-Light'; src: url('{% static 'fonts/Aileron-Light.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-Thin'; src: url('{% static 'fonts/Aileron-Thin.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-UltraLightItalic'; src: url('{% static 'fonts/Aileron-UltraLightItalic.otf'%}') format('truetype'); }
/*
	@font-face { font-family: 'Aileron-Black'; src: url('{% static 'fonts/Aileron-Black.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-BlackItalic'; src: url('{% static 'fonts/Aileron-BlackItalic.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-Bold'; src: url('{% static 'fonts/Aileron-Bold.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-BoldItalic'; src: url('{% static 'fonts/Aileron-BoldItalic.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-Heavy'; src: url('{% static 'fonts/Aileron-Heavy.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-HeavyItalic'; src: url('{% static 'fonts/Aileron-HeavyItalic.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-Light'; src: url('{% static 'fonts/Aileron-Light.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-LightItalic'; src: url('{% static 'fonts/Aileron-LightItalic.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-Regular'; src: url('{% static 'fonts/Aileron-Regular.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-SemiBold'; src: url('{% static 'fonts/Aileron-SemiBold.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-SemiBoldItalic'; src: url('{% static 'fonts/Aileron-SemiBoldItalic.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-Thin'; src: url('{% static 'fonts/Aileron-Thin.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-ThinItalic'; src: url('{% static 'fonts/Aileron-ThinItalic.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-UltraLight'; src: url('{% static 'fonts/Aileron-UltraLight.otf'%}') format('truetype'); }
	@font-face { font-family: 'Aileron-UltraLightItalic'; src: url('{% static 'fonts/Aileron-UltraLightItalic.otf'%}') format('truetype'); }
*/
		 
	.content {
		padding: 0px;
	}
	
	
	#overall-score-label {
		position: absolute;
		top: 68px;
		right: 15px;
		font-family: 'Aileron-Thin';
		font-size: 20px;
		border: 1px solid rgb(190, 190, 190);
		border-radius: 3px;
		border-radius: 4px;
		padding: 2px 6px;
	}
	
	#overall-score {
		font-size: 22px;
		display: inline-block;
		color: rgb(104, 144, 255);
		text-shadow: 0px 0px 2px rgba(104, 144, 255, 0.4);
	}
	
	
	/* --------------------------------------------------------------------------*/
	/*  Left Panel --------------------------------------------------------------*/
	/* --------------------------------------------------------------------------*/
	
	#left-panel {
		margin-left: 19px;
		width: 300px;
		height: 100%;
		display: inline-block;
		float: left;
	}
	
	#add-plain-variables-as-factor-button {
		margin-top: 118px;
	}
	
	/* --------------------------------------------------------------------------*/
	/* --- Factor Panel --------------------------------------------------------------*/
	/* --------------------------------------------------------------------------*/
		
	#factor-panel {
		display: inline-block;
	}
	
	/* --- Head -----------------------------------------------------------------------*/
	
	#factor-panel-header {
		margin-top: 30px;
	}
	
	h3 {
		text-align: center;
		display: inline-block;
		float: left;
		margin-top: 39px;
		margin-left: -29px;
		margin-right: 21px;
		font-size: 25px;
	}
	
	#contribution-header {
		width: 200px;
		display: inline-block;

		text-align: center;
	}
	
	.header-text {
		font-size: 19px;
		font-family: 'Aileron-Light';
		color: rgb(50, 50, 50);
		margin-bottom: 5px;
	}
	
	#p-value-header {
		display: inline-block;
		text-align: center;
		margin-left: 7px;
	}
	
	.p-value-header-text {
		margin-bottom: 10px;
		margin-left: -12px;
	}
	
	.header-settings {
		font-size: 13px;
	}
	
	
	#min-score-contribution {
		display: inline-block;
		width: 56px;
		padding: 2px 0px 0px 4px;
		height: 22px;
		margin-bottom: 4px;
		margin-left: 1px;
		margin-right: 2px;
		font-size: 12px;
	}
	
	#max-p-value {
		display: inline-block;
		width: 56px;
		padding: 2px 0px 0px 4px;
		height: 22px;
		margin-bottom: 4px;
		margin-left: 1px;
		margin-right: 2px;
		font-size: 12px;
	}
			
	
	/* --- Body -----------------------------------------------------------------------*/
	
	/* -- Factor Panels --*/
	#factor-panel-body {
		width: 805px;
		height:calc(100vh - 260px);
		overflow-y: auto;
		padding: 2px;
		-webkit-box-shadow: inset 1px 1px 9px 5px rgba(0,0,0,0.2);
		-moz-box-shadow: inset 1px 1px 59px 5px rgba(0,0,0,0.2);
		box-shadow: inset 1px 1px 9px 5px rgba(0,0,0,0.2);
		background-color: rgb(190, 190, 190);
		/* slightly darker:
		border-left: 6px solid rgb(240, 240, 240);
		border-top: 6px solid rgb(220, 220, 220);
		border-right: 6px solid rgb(245, 245, 245);
		border-bottom: 6px solid rgb(250, 250, 250);
		*/
		border-left: 5px solid rgb( 230, 230, 230);
		border-top: 5px solid rgb( 218, 218, 218);
		border-right: 5px solid rgb(250, 250, 250);
		border-bottom: 5px solid rgb(250, 250, 250);
	}
	
	#factors-list > .list-group-item {
		height: 84px;
		border-left: 9px solid rgb(252, 252, 252);
		border-top: 9px solid rgb(255, 255, 255);
		border-right: 9px solid rgb( 242, 242, 242);
		border-bottom: 9px solid rgb( 235, 235, 235);
		margin-bottom: 3px;
		border-radius: 3px;
		padding: 0px;
		-webkit-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		-moz-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		background-color: rgb(252, 252, 252);
	}
	

	
	#plus-button {
		-webkit-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.3);
		-moz-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.3);
		box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.3);
	}
	
	/* -- Factor Panel Content --*/
	#plus-button-list-group-item {
		background-color: rgba(256, 256, 256, 0);
		padding: 17px;
		padding-left: 25px;
	}
	
	.factor-description {
		width: 426px;
		height: 69px;
		display: inline-block;
		float: left;
	}
	
	.factor-text {
		height: 66px;
		width: 100%;
		border: 1px solid rgb(235,235,235);
	}
	
	textarea.form-control {
		height: 66px;
	}
	
	.score-box {
		display: inline-block;
		text-align: center;
		float: left;
		padding-top: 17px;
		width: 170px;
		font-family: 'Aileron-Thin';
		font-size: 19px;
	}
	
	
	.p-value {
		margin-top: 18px;
		margin-left: 33px;
		color: rgb(50, 84, 173);
		display: inline-block;
	}
	
	.p-value-number {
		display: inline-block;
		margin-top: 3px;
		margin-left: 1px;
		padding-left: 3px;
		width: 105px;
		border: 1px solid rgb(252, 252, 252);
		font-size: 14px;
		font-family: 'Aileron-Light';
		background-color: rgb(252, 252, 252);
		color: rgb(80, 80, 80);
	}
	

	.remove-factor-button {
		display: inline-block;
		float: right;
		height: 18px;
		width: 18px;
		padding: 0px;
		margin-top: 3px;
		margin-right: 2px;
		border-radius: 3px;
		background-color: rgb(242, 242, 242);
	}

	.remove-factor-button-text {
		margin-left: -1px;
		margin-top: -2px;
	}
	
	
	/*  Disabled  --------------------------------------------------------------------*/
	

	
	#factors-list > .list-group-item.disabled {
		background-color: rgb(240, 240, 240);
		color: rgb(160, 160, 160);
		border-right: 9px solid rgb(227, 227, 227);
		border-bottom: 9px solid rgb(230, 230, 230);
		border-left: 9px solid rgb( 242, 242, 242);
		border-top: 9px solid rgb( 247, 247, 247);
	}
	
	.disabled .factor-text{
		background-color: rgb(252, 252, 252);
		color: rgb(160, 160, 160);
	}

	
	.disabled .p-value-number {
		background-color: rgb(240, 240, 240);
		border-color: rgb(240, 240, 240);
		color: rgb(160, 160, 160);
	}



	/* ---------------------------------------------------------------------------*/
	/*  Right Panel --------------------------------------------------------------*/
	/* ---------------------------------------------------------------------------*/
	
	#right-panel {
		margin-right: 40px;
		width: 250px;
		height: 100%;
		display: inline-block;
		float: right;
		margin-top: 82px;
	}
	
	.available-variables-label {
		margin-top: 19px;
		font-weight: 700;
		font-size: 15px;
		color: rgb(110, 110, 110);
	} 
	
	#select-available-variable {
		width: 179px;
		margin-top: 2px;
		margin-bottom: 5px;
	}
	
	#available-variable-frame {
		border: 1px solid rgb(202, 202, 202);
		border-radius: 4px;
		width: 100%;
		height: calc(100vh - 377px);
		overflow: auto;
	}
	
	.list-group-item.avail-var-item{
		border-bottom: 1px solid rgb(202, 202, 202);
		margin-bottom: 0px;
		padding:0px;
	}

	.avail-var-button {
		background: white;
	}
	
	#learn-button {
		margin-top: 28px;
		margin-left: 108px;
	}
	
	/* --------------------------------------------------------------------------*/
	/* -----  Footer Panel  -----------------------------------------------------*/
	/* --------------------------------------------------------------------------*/

	#footer-panel {
		margin-top: 10px;
		height: 71px;
		background-color: rgb(250, 250, 250);
		border: 1px solid rgb(240, 240, 240);
	}
	

	
	#learned-rule-header {
		display: inline-block;
		float: left;
		font-size: 20px;
		margin-left: 6px;
		margin-top: 3px;
	}
	
	#left-side-of-equation {
		display: inline-block;
		float: left;
		margin-left: 67px;
		margin-top: 23px;
		margin-right: 7px;
	}
	
	#right-side-of-equation {
		display: inline-block;
	}
	
	#rule-text {
		height: 53px;
		margin-top: 5px;
		width: 625px;
	}
	
	
	#cancel-and-save-buttons {
		display: inline-block;
		float: right;
		margin-top: 18px;
		margin-right: 36px;
	}
		
	#cancel-button {
		display: inline-block;
	}
	
	#save-button {
		display: inline-block;
		margin-left: 4px;
	}
	
	
	
</style>
{% endblock %}

{% block content %}

<div>
	<div id="overall-score-label"> 
		Overall Score: <div id="overall-score"></div>
	</div>

	<div id="left-panel">
		<button id="add-plain-variables-as-factor-button" class="btn btn-secondary " type="button" onclick="addAllPlainVariablesAsFactor()">Test the individual Attributes > </button>
	</div>

	<div id="factor-panel">
		<div id="factor-panel-header">
			<h3>Possible reasons for a high {{ learned_rule.attribute_name }}:</h3>
			<div id="contribution-header">
				<div class="header-text">Contributions to the Overall Score</div>
				<div class="header-settings">min: <input class="form-control" id="min-score-contribution" type="number" value="{{ learned_rule.min_score_contribution }}" min="0" max="100" step="0.01" onchange="filterFactors()">%</div>
			</div>
			<div id="p-value-header">
				<div class="header-text p-value-header-text">P-values</div>
				<div class="header-settings">max: <input class="form-control" id="max-p-value" type="number" value="{{ learned_rule.max_p_value }}" min="0" max="100" step="0.01" onchange="filterFactors()">%</div>
			</div>
		</div>
		<div id="factor-panel-body">	
			<ul id="factors-list" class="list-group">
			</ul>
		</div>
	</div>

	<div id="right-panel">
		<div class="available-variables-label">Available Variables:</div>
		<input type="text" class="form-control" id="select-available-variable" onkeyup="filterAvailableVariables();" placeholder=" Search">
		<div id="available-variable-frame">
			<ul id="available-variables" class="input-group list-group"></ul>
		</div>
		<button id="learn-button" class="btn btn-success " type="button" onclick="learn()">Learn Rule</button>
	</div>
</div>
<div id="footer-panel">
	<div id="learned-rule-header">Learned Rule</div>
	<div id="left-side-of-equation">{{ learned_rule.attribute_name }} (t + &Delta;t) = </div>
	<div id="right-side-of-equation"><textarea class="form-control" id="rule-text" cols="20" rows="3" ></textarea></div>
	<div id="cancel-and-save-buttons">
		<button id="cancel-button" class="btn btn-secondary " type="button" onclick="Cancel()">Cancel</button>
		<button id="save-button" class="btn btn-primary " type="button" onclick="saveAndClose()">Save Rule</button>
	</div>
</div>



<script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-ui.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-exports.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-gantt.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-data-adapter.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
 		
<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>

<script type="text/javascript">
	// GLOBAL VARIABLES:
	var object_type_id = '{{ learned_rule.object_type_id|safe }}';
	var attribute_id = {{ learned_rule.attribute_id }};
	var object_filter_facts = {{ learned_rule.object_filter_facts|safe }};
	var available_attributes = {{ available_attributes|safe }}
	var specified_factors = {{ learned_rule.specified_factors|safe }};
	var sorted_factor_numbers = {{ learned_rule.sorted_factor_numbers|safe }};
	var overall_score = {{ learned_rule.overall_score|default:"null" }};
	
	var number_of_factors = 0;
	var results_data = {};
	var selected_factor = null;
	var selected_factor_cursor_position = {};
	
	


	
	//========================================================================
	//====================  LEFT PANEL  ======================================
	//========================================================================


	function addAllPlainVariablesAsFactor() {
	
		var factor_numbers = Object.keys(specified_factors);
		new_factor_number = Math.max(...factor_numbers) + 1;
		
	
		for (var i = 0; i < available_attributes.length ; i++) {
			specified_factors[new_factor_number] = {'factor_text': '[' + available_attributes[i]['name'] + ']',
													'factor_transformation': 'attr' + String(available_attributes[i]['id'])};
													
			sorted_factor_numbers.push(new_factor_number);
			new_factor_number++;
		}
		
		displayFactors()
	}
	
	//========================================================================
	//====================  CENTRAL PANEL   ================================
	//========================================================================
	
	// Change min_score_contribution or max_p_value =================================================================
	function filterFactors() {
		var min_score_contribution = parseFloat(document.getElementById('min-score-contribution').value);
		var max_p_value = parseFloat(document.getElementById('max-p-value').value);
		
		factor_numbers = Object.keys(specified_factors);
		for (var i = 0; i < factor_numbers.length; i++) {
			factor_number = factor_numbers[i]
			if (! $("#factor" + factor_number ).hasClass("new")) {
				if ((specified_factors[factor_number]['score'] < min_score_contribution) || (specified_factors[factor_number]['pvalue'] > max_p_value)){
					specified_factors[factor_number]['disabled'] = true;
					$("#factor" + factor_number ).addClass("disabled");
				} else {
					specified_factors[factor_number]['disabled'] = false;
					$("#factor" + factor_number ).removeClass("disabled");
				}
				
				if ((isNaN(specified_factors[factor_number]['score'])) || (isNaN(specified_factors[factor_number]['pvalue']))) {
					specified_factors[factor_number]['disabled'] = true;
					$("#factor" + factor_number ).addClass("disabled");
				}
			}
		}
		
		displayLearnedRuleAndScore();
	}
	
	
	// =========================================   FACTORS   ====================================================================
	
	// Display -------
	function displayFactors() {	
		// remove the old stuff
		$("#factors-list").html('<li id="plus-button-list-group-item"><button id="plus-button" type="button" class="btn btn-outline-dark" onclick="newFactor()" ><i class="fas fa-plus"></i></button></li>');

		// if there are specified_factors: display them
		if (sorted_factor_numbers.length > 0) {	
			factor_html_string = ""
			for (var i = 0; i < sorted_factor_numbers.length; i++) {
				factor_number = sorted_factor_numbers[i];
				score_text = "";
				if ('score' in specified_factors[factor_number]) {
					 score = specified_factors[factor_number]['score'] * 100;
					 nb_of_decimal_places = Math.max(1-Math.floor(Math.log(score)/Math.log(10)) ,1);
					 score_text = String(Math.floor(score * (10**nb_of_decimal_places))/ (10**nb_of_decimal_places)) + '%';
				}
			
				pvalue_text = "";
				var pvalue = specified_factors[factor_number]['pvalue'];
				if (!isNaN(pvalue)) {
					pvalue_text = pvalue.toFixed(1-Math.floor(Math.log(pvalue)/Math.log(10)))
				}
				
				factor_html_string += 	'<li class="list-group-item" id="factor' + factor_number + '">' +
											'<div class="factor-description">' +
												'<textarea class="factor-text form-control" id="factor-text' + factor_number + '" cols="20" rows="3" class="form-control" onclick="rememberCursorPostion(' + factor_number + ')" onchange="checkFactor()">' + specified_factors[factor_number]['factor_text'] + '</textarea>' +
											'</div>' +
											'<div id="score' + factor_number + '" class="score-box">' + score_text + '</div>' + 
											'<div class="p-value"><input class="p-value-number" type="text" value="' + pvalue_text + '"></div>' +
											'<button type="button" class="btn btn-secondary remove-factor-button" onclick="removeFactor(' + factor_number + ')"><div class="remove-factor-button-text">&times;</div></button>' +
										'</li>';
			}
			$(factor_html_string).insertBefore('#plus-button-list-group-item');	

		} else {
					
			additional_factor_html_string = '<li class="list-group-item new" id="factor0">' +
												'<div class="factor-description">' +
													'<textarea class="factor-text form-control" id="factor-text0" cols="20" rows="3" class="form-control" onclick="rememberCursorPostion(0)" onchange="checkFactor()"></textarea>' +
												'</div>' +
												'<button type="button" class="btn btn-secondary remove-factor-button" onclick="removeFactor(0)"><div class="remove-factor-button-text">&times;</div></button>' +
											'</li>';
		
			$(additional_factor_html_string).insertBefore('#plus-button-list-group-item');
			
			specified_factors[0] = {'factor_text': '',
									'factor_transformation': ''};
			sorted_factor_numbers.push(0);
		}
		
	}
	
	// Check -------
	function checkFactor() {}
	
	// Remove -------
	function removeFactor(factor_number) {
		if (factor_number in specified_factors) {
			if ('score' in specified_factors[factor_number]) {
				 overall_score -= specified_factors[factor_number]['score'];
			}
		}

		//remove from specified_factors
		delete specified_factors[factor_number];

		//remove from sorted_factor_numbers
		var index = sorted_factor_numbers.indexOf(factor_number);
		if (index > -1) {
		   sorted_factor_numbers.splice(index, 1);
		}
	
	
		
		//remove from html
		var selected_factor = document.getElementById('factor' + factor_number);
		selected_factor.parentNode.removeChild(selected_factor);
		
		
		displayLearnedRuleAndScore();
		
	}

	
	// the '+'-Button
	function newFactor() {
	
		new_factor_number = 0;
		var factor_numbers = Object.keys(specified_factors);
		if (factor_numbers.length > 0) {
			new_factor_number = Math.max(...factor_numbers) + 1;
		}
		
		additional_factor_html_string = '<li class="list-group-item new" id="factor' + new_factor_number + '">' +
											'<div class="factor-description">' +
												'<textarea class="factor-text form-control" id="factor-text' + new_factor_number + '" cols="20" rows="3" class="form-control" onclick="rememberCursorPostion(' + new_factor_number + ')" onchange="checkFactor()"></textarea>' +
											'</div>' +
											'<button type="button" class="btn btn-secondary remove-factor-button" onclick="removeFactor(' + new_factor_number + ')"><div class="remove-factor-button-text">&times;</div></button>' +
										'</li>';
	
		$(additional_factor_html_string).insertBefore('#plus-button-list-group-item');
		
		specified_factors[new_factor_number] = {'factor_text': '',
											    'factor_transformation': ''};
		sorted_factor_numbers.push(new_factor_number);
	}
	
	



	
	//=================================================================================
	//=====================    RIGHT PANEL      =======================================
	//=================================================================================
			
	// Search-Field ================================================================================
	function filterAvailableVariables() {
		var current_query = $('#select-available-variable').val().toLowerCase();
		if (current_query !== "") {
			$("#available-variables li").hide();
			$("#available-variables li").each(function(){
				var current_keyword = $(this).text().toLowerCase();
				if (current_keyword.indexOf(current_query) >=0) {
					$(this).show();    	 	
				};
			});    	
		} else {
			$("#available-variables li").show();
		};
	}
	
	// Select an Available Variable ================================================================================
	function rememberCursorPostion(factor_number) {
		selected_factor = factor_number;
	
		var myElement = document.getElementById('rule-text');
		var startPosition = myElement.selectionStart;
		var endPosition = myElement.selectionEnd;	
		selected_factor_cursor_position = {'startPosition':startPosition, 'endPosition':endPosition};	
	}
	
	
	function selectAvailableVariable(attribute_name) {
		if (selected_factor) {
			var rule_text = document.getElementById('factor-text' + selected_factor).value;
			var new_rule_text = rule_text.substring(0, selected_factor_cursor_position['startPosition']) + '[' + attribute_name + ']' + rule_text.substring(selected_factor_cursor_position['endPosition'], rule_text.length);
			document.getElementById('factor-text' + selected_factor).value = new_rule_text;
			
			checkFactor();
		}
	}
	
	
	
	// Learn-Button  =====================================================================================
	function learn() {
		saveSpecifications();
				
		var url_components = window.location.href.split("/");
		var learned_rule_id = url_components[url_components.length - 2]
		
		
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				results_data = JSON.parse(this.responseText);
				specified_factors = results_data['specified_factors']
				overall_score = results_data['overall_score']
				sorted_factor_numbers = results_data['sorted_factor_numbers']
				
				displayFactors()
				displayLearnedRuleAndScore();	
			}
		};
		xhttp.open("GET", "/tool/learn_rule_from_factors?learned_rule_id=" + learned_rule_id , true);
		xhttp.send();	
	}
	

	// Save ---------
	function saveSpecifications() {
		var url_components = window.location.href.split("/");
		var learned_rule_id = url_components[url_components.length - 2]
		
		factor_numbers = Object.keys(specified_factors);
		for (var i = 0; i < factor_numbers; i++) {	
			factor_number = factor_numbers[i];
			factor_text = document.getElementById('factor-text' + factor_number).value;
			
			var passes_tests = true;
			if (factor_text.length == 0) {
				passes_tests = false;
			}
			
			if (passes_tests) {
				factor_transformation = factor_text;
				
				//replacing variable_names
				for (var j = 0; j < available_attributes.length; j++) {
					var search_value = '[' + available_attributes[j]['name'] + ']';
					if (['string', 'date'].includes(available_attributes[j]['data_type'])){
						var replacement = '"attr' + String(available_attributes[j]['id']) + '"';
					} else {
						var replacement = 'attr' + String(available_attributes[j]['id']);
					}
					factor_transformation = factor_transformation.split(search_value).join(replacement);
				}	
				specified_factors[factor_number] = {'factor_text': factor_text,
												   'factor_transformation': factor_transformation}
			}
		}
		
		request_body = {
			'learned_rule_id': learned_rule_id,
			'object_type_id': object_type_id,
			'object_filter_facts': object_filter_facts,
			'specified_factors':specified_factors
		}
		
		var xmlhttp = new XMLHttpRequest();       
		xmlhttp.open("POST", "/tool/save_learned_rule/");
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		xmlhttp.send(JSON.stringify(request_body));		
	}
	
	
	
	
	//=================================================================================
	//====================    FOOTER PANEL      =======================================
	//=================================================================================

	function displayLearnedRuleAndScore() {
		
		// Overall Score
		score_text = String(Math.floor(overall_score * 1000)/10) + '%';
		if (overall_score) {
			$("#overall-score").html(score_text);
		}
		
		//Learned Rule
		var learned_rule_text = '';
		factor_numbers = Object.keys(specified_factors);
		for (var i = 0; i < factor_numbers.length; i++) {
			factor_number = factor_numbers[i];
			if (specified_factors[factor_number]['disabled'] == false) {
				if (i > 0) {
					learned_rule_text += ' + ';
				}
				coefficient = specified_factors[factor_number]['coefficient'];
				order_of_magnitutde = Math.log10(Math.abs(coefficient));
				order_of_magnitutde = Math.floor(order_of_magnitutde);
				factor = Math.pow(10, order_of_magnitutde - 3);
				coefficient_rounded = Math.round(coefficient/Math.pow(10, order_of_magnitutde - 3)) * Math.pow(10, order_of_magnitutde - 3);
				learned_rule_text +=  String(coefficient_rounded) + ' * ' + specified_factors[factor_number]['factor_text'];
			}
		}
		$("#rule-text").html(learned_rule_text);
		
	}	
	




	//========================================================================
	//======================  MAIN  ==========================================
	//========================================================================
	
	// Set up the Screem
	displayFactors()
	displayLearnedRuleAndScore()
	filterFactors()
	
	// Available Varialbes	
	available_variables_html_string = '';
	for (var i = 0; i < available_attributes.length ; i++) {
		var attribute_id = available_attributes[i]['id'];
		var attribute_name = available_attributes[i]['name'];
		available_variables_html_string += 	'<li class="list-group-item avail-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="selectAvailableVariable(\'' + attribute_name + '\')" scope="col">' + attribute_name + '</button></li>';
		
	}
	
	$('#available-variables').html(available_variables_html_string);


</script>


{% endblock %}



