{% extends 'layouts/base_tool.html' %}'
{% load staticfiles %}

<!-- 
####################################################################
# This file is part of the Tree of Knowledge project.
# Copyright (c) 2019-2040 Benedikt Kleppmann

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version - see http://www.gnu.org/licenses/.
#####################################################################
-->

{% block title %}
	Analyse Learned Parameters
{% endblock %}

{% block additionalcss %}
  <link href="https://cdn.anychart.com/releases/v8/css/anychart-ui.min.css?hcode=be5162d915534272a57d0bb781d27f2b" rel="stylesheet" type="text/css">
  <link href="https://cdn.anychart.com/releases/v8/fonts/css/anychart-font.min.css?hcode=be5162d915534272a57d0bb781d27f2b" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="{% static 'css/bootstrap-3.4.0.min.css' %}" />
	
	
<style>
	.content {
		padding: 0px;
	}
					
	/* --------------------------------------------------------------------------*/
	/* Left Panel ---------------------------------------------------------------*/
	/* --------------------------------------------------------------------------*/
	
	#outer-left-panel {
		float: left;
		display: inline-block;
		margin-top: 2px;
		width: 256px;
		height: calc(100vh - 59px);
		background: rgb(226, 226, 226);
		border-right: 1px solid silver;
		box-shadow: 5px 0px 10px 0px rgba(0,0,0,0.30);
		position: relative;
	}
	
	.card-header {
		border-top: 1px solid rgb(180, 180, 180);
		border-bottom: 1px solid rgb(180, 180, 180);
	}
	
	.left-panel-header {
		font-size: 15.5px;
		background: rgb(226, 226, 226);
		width: 100%;
		padding-left: 20px;
		text-align: left;
		overflow: hidden;
	}
	
	.card-body {
		padding: 14px;
		background-color: rgb(244, 244, 244);
	}

	/* Info ------------------------------------------------------------------------ */
	
	#bottom-from-group {
		margin-bottom: 0px;
	}

	/* Parameter Distributions ------------------------------------------------------- */
	
	/* Inspect Simulations --------------------------------------------------------- */
	
	.parameter-selection-area {
		width: 217px;
	}
	
	#learned-parameter-selection-buttons {
		max-height: calc(100vh - 236px);
		overflow-y: auto;
	}

	#learned-parameter-selection-buttons .selection-button, #new-parameter-selection-buttons .selection-button {
		width: 100%;
		background: rgb(248, 248, 248);
		border: 1px solid rgb(210, 210, 210);
	}
	
	
	#parameter-distributions-box .selection-button {
		background: rgb(248, 248, 248);
		border: 1px solid rgb(210, 210, 210);
		text-align: left;
		margin-left: 20px;
	}
	
	#left-new-simulation-button {
		margin-top: 11px;
		margin-left: 33px;
	}
	
	/* --------------------------------------------------------------------------*/
	/* Right Panel - Parameter Distributions  ----------------------------*/
	/* --------------------------------------------------------------------------*/
	
	#graph-panel {
		height: 320px;
		width: 75%;
		margin-left: auto;
		margin-right: auto;
		margin-top: 55px;
		margin-bottom: 45px;
	}
	
	#tested_params-bottom-panel {
		width: 416px;
		margin-left: auto;
		margin-right: auto;
	}
	
	#show-the-top-text {
		display: inline-block;
		margin-right: 7px;
	}
	
	
	/* --------------------------------------------------------------------------*/
	/* Right Panel - Inspect Simulations  ---------------------------------------*/
	/* --------------------------------------------------------------------------*/
	
	
	#right-main-panel {
		display: inline-block;
		height: calc(100vh - 59px);
		width: calc(100vw - 273px);
	}
	
	#analyse-simulation-box {
		height: calc(100vh - 59px);
		width: calc(100vw - 273px);
		border-width: 1px;
	}
	
	
	/* Run Monte-Carlo Simulation View - Upper ---------------------------------*/
	#right-main-upper-box {
		margin-left: 23px;
		margin-top: 12px;
	}
	
	#parameter-values-title {
		width: 350px;
		padding: 7px 13px 7px 21px;
		border: 1px solid rgb(180, 180, 180);
	}
	
	#simulation-parameter-box {
		padding: 14px;
		background-color: rgb(244, 244, 244);
		width: 350px;
	}
	
	.rule-heading {
		font-weight: 600;
		margin-bottom: 1px;
		padding-top: 6px;
	}
	
	.parameter-value {
		padding-left: 16px;
	}
	
	/* Run Monte-Carlo Simulation View - Lower ---------------------------------*/
	#right-main-lower-box {
		display: block;
		margin-top: 36px;
		margin-left: auto;
		margin-right: auto;
		width: 438px;
		padding-right: 130px;
	}
	
	#number-of-entities-to-simulate-box {
		margin-left: 55px;
	}
	
	#number-of-entities-to-simulate-box label {
		padding-top: 7px;
		padding-right: 0px;
	}
	
	#number-of-entities-to-simulate-box .col-sm-4 {
		padding-left: 4px;
	}
	
	#progress-bar-frame {
		margin-top: 60px;
		width: 90%;
		margin-left: 63px;
		margin-right: auto;
	}
	
	/* --------------------------------------------------------------------------*/
	/* Right Panel - Test New Parameters  ---------------------------------------*/
	/* --------------------------------------------------------------------------*/
	
	#test-new-parameters #simulation-parameter-box , #test-new-parameters #parameter-values-title {
		width: 400px;
	}
	
	#test-new-parameters .form-group {
		    margin-bottom: 8px;
	}
	
	#test-new-parameters .parameter-label{
		font-weight: 500;
		margin-top: 8px;
	}
	
	#test-new-parameters #right-main-lower-box {
		width: 517px;
	}
	
	#test-new-parameters #number-of-entities-to-simulate-box {
		display: inline-block;
		width: 236px;
		margin-left: 0px;
	}
	
	#test-new-parameters #run-monte-carlo-sim-button {
		display: inline-block;
		float: right;
	}
	
	
</style>	



{% endblock %}	

{% block content %}
<div id="outer-left-panel">
	<div class="accordion md-accordion" id="accordion-left" role="tablist" aria-multiselectable="true">	
		<div class="card">
			<div class="card-header" role="tab" id="accordion-left-header-1">
				<button class="btn left-panel-header collapsed accordion-toggle" data-parent="#accordion-left" href="#accordion-left-content-1" aria-expanded="false" aria-controls="accordion-left-content-1">Info</button>
			</div>
			<div id="accordion-left-content-1" class="collapse" role="tabpanel" aria-labelledby="accordion-left-header-1" data-parent="#accordion-left">
				<div class="card-body">
					<div class="form left-panel-body">
						<div class="form-group row">
							<label for="simulation-name" class="col-sm-5">Simulation Name</label>
							<div class="col-sm-7">
								<input id="simulation-name" class="form-control" value="{{ simulation_model.simulation_name }}">
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="card">
			<div class="card-header" role="tab" id="accordion-left-header-2">
				<button class="btn left-panel-header collapsed accordion-toggle" data-parent="#accordion-left" href="#accordion-left-content-2" aria-expanded="false" aria-controls="accordion-left-content-2" onclick="drawParameterDistributions()">Parameter Distributions</button>
			</div>
			<div id="accordion-left-content-2" class="collapse" role="tabpanel" aria-labelledby="accordion-left-header-2" data-parent="#accordion-left">
				<div class="card-body">
					<div id="parameter-distributions-box"></div>
				</div>
			</div>
		</div>
		<div class="card">
			<div class="card-header" role="tab" id="accordion-left-header-3">
				<button class="btn left-panel-header collapsed accordion-toggle" data-parent="#accordion-left" href="#accordion-left-content-3" aria-expanded="false" aria-controls="accordion-left-content-3">Inspect Simulations</button>
			</div>
			<div id="accordion-left-content-3" class="collapse" role="tabpanel" aria-labelledby="accordion-left-header-3" data-parent="#accordion-left">
				<div class="card-body">
					<div class="parameter-selection-area">
						<div id="learned-parameter-selection-buttons"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="card">
			<div class="card-header" role="tab" id="accordion-left-header-4">
				<button class="btn left-panel-header collapsed accordion-toggle" data-parent="#accordion-left" href="#accordion-left-content-4" aria-expanded="false" aria-controls="accordion-left-content-4">Test New Parameters</button>
			</div>
			<div id="accordion-left-content-4" class="collapse" role="tabpanel" aria-labelledby="accordion-left-header-4" data-parent="#accordion-left">
				<div class="card-body">
					<div class="parameter-selection-area">
						<div id="new-parameter-selection-buttons"></div>
					</div>
					<button id="left-new-simulation-button" class="btn btn-success" type="button" onclick="showNewSimulationButton()">+ New Simulation</button>
				</div>
			</div>
		</div>
	</div>
</div>
<div id="right-main-panel">
</div>



		
<script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-ui.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-exports.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-gantt.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-data-adapter.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
 

<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
<script type="text/javascript" src="https://rawgit.com/RickStrahl/jquery-resizable/master/src/jquery-resizable.js"></script>



 
<script type="text/javascript">
	// GLOBAL VARIABLES:
	var simulation_id = {{ simulation_model.id|safe }};
	var run_number = {{ simulation_model.run_number|safe }};
	
	var objects_dict = {{ simulation_model.objects_dict|safe }};
	var y_value_attributes = {{ simulation_model.y_value_attributes|safe }};
	var all_priors_df = {{ simulation_model.all_priors_df|safe }};
	var not_used_rules = {{ simulation_model.not_used_rules|safe }};
	
	
	
	
	
	var is_timeseries_analysis = {{ simulation_model.is_timeseries_analysis|yesno:"true,false" }};
	var simulation_start_time = {{ simulation_model.simulation_start_time }};
    var simulation_end_time = {{ simulation_model.simulation_end_time }};
    var timestep_size = {{ simulation_model.timestep_size }};
	var simulation_name = '{{ simulation_model.simulation_name }}';
	var execution_order_id = {{ simulation_model.execution_order_id }};
	var execution_order = {};
	var parameter_info = {};
	





	//========================================================================
	//========================================================================
	//=========================   LEFT PANEL      ============================
	//========================================================================
	//========================================================================


	//== Fill in  'Parameter Distributions' ================================================================================================
	function drawParameterDistributions() {
	
		var parameter_distribution_buttons_str = '';
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules']);
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]]);
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]]
					if (rule['learn_posterior'] && (!(object_numbers[i] in not_used_rules) || (object_numbers[i] in not_used_rules && !(rule_ids[k] in not_used_rules[object_numbers[i]])))) {
					
						parameter_distribution_buttons_str += '<div class="rule-heading">' + objects_dict[object_numbers[i]]['object_name'] + ', Rule ' + String(rule_ids[k]) + ':</div>';
						if (!rule['has_probability_1']) {
							parameter_distribution_buttons_str += '<button class="btn btn-light selection-button" type="button" onclick="showParameterDistribution(' +  object_numbers[i] + ', ' +  attribute_ids[j] + ',' +  rule_ids[k] + ', null)">Rule probaility</button>';
						}
						var used_parameter_ids = rule['used_parameter_ids'];
						for (var l = 0; l < used_parameter_ids.length; l++) {
							parameter_distribution_buttons_str += '<button class="btn btn-light selection-button" type="button" onclick="showParameterDistribution(' +  object_numbers[i] + ', ' +  attribute_ids[j] + ',' +  rule_ids[k] + ',' +  used_parameter_ids[l] + ')">' + parameter_info[used_parameter_ids[l]]["parameter_name"] + '</button>';
						}
					}
					
				}
			}
		}
		
		$('#parameter-distributions-box').html(parameter_distribution_buttons_str);
	}
	
	
	
	//== Fill in  'Inspect Simulations' ================================================================================================
	function drawInspectSimulations() {
		var parameter_numbers = Object.keys(all_priors_df);
		var parameter_selection_buttons_str = '';
		for (var i = 0; i < parameter_numbers.length; i++) {
			var parameter_number = parameter_numbers[i];
			parameter_selection_buttons_str += '<button id="param-selection-button-' +  parameter_number + '" class="btn btn-light selection-button run-toggle" type="button" onclick="showParameterSimulations(' +  parameter_number + ')">Param ' +  parameter_number + ' - Score: ' + String(Math.round((1 - all_priors_df[parameter_number]["error"])*100)) + '% </button>';
		}
		$('#learned-parameter-selection-buttons').html(parameter_selection_buttons_str);
	} 
	


	function activateSimulatedParameters() {
	
		//deactivate all
		var parameter_numbers = Object.keys(all_priors_df);
		for (var i = 0; i < parameter_numbers.length; i++) {
			$('#param-selection-button-' + String(parameter_numbers[i])).attr("onclick",'showRunMonteCarloSimulationButton(' + String(parameter_numbers[i]) + ')');
			$('#param-selection-button-' + String(parameter_numbers[i])).css("background",'rgb(200,200,200)');
			$('#param-selection-button-' + String(parameter_numbers[i])).css("color",'rgb(130,130,130)');
		}
	
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				parameter_numbers = JSON.parse(this.responseText);
				
				//activate Inspect Simulation buttons
				learned_parameter_numbers = parameter_numbers['learned_parameter_numbers']
				for (var i = 0; i < learned_parameter_numbers.length; i++) {
					$('#param-selection-button-' + String(learned_parameter_numbers[i])).attr("onclick",'showParameterSimulations(' + String(learned_parameter_numbers[i]) + ')');
					$('#param-selection-button-' + String(learned_parameter_numbers[i])).css("background",'rgb(248, 248, 248)');
					$('#param-selection-button-' + String(learned_parameter_numbers[i])).css("color",'#333');
				}
				
				//create Test New Parameters buttons
				new_parameter_numbers = parameter_numbers['new_parameter_numbers']
				parameter_selection_buttons_str = '';
				for (var i = 0; i < new_parameter_numbers.length; i++) {
					var parameter_number = new_parameter_numbers[i];
					parameter_selection_buttons_str += '<button  class="btn btn-light selection-button run-toggle" type="button" onclick="showNewParameterSimulations(' +  parameter_number + ')">Param ' +  parameter_number + '</button>';
				}
				$('#new-parameter-selection-buttons').html(parameter_selection_buttons_str);
				
			}
		};
		xhttp.open('GET', '/tool/get_simulated_parameter_numbers?simulation_id=' + String(simulation_id) + '&run_number=' + String(run_number), true);
		xhttp.send();
	}


	//========================================================================
	//========================================================================
	//========   RIGHT PANEL  - Parameter Distributions    ===================
	//========================================================================
	//========================================================================

	function showParameterDistribution(object_number, attribute_id, rule_id, parameter_id) {
		$('#right-main-panel').html('<div id="graph-panel"></div>' +
									'<div id="tested_params-bottom-panel">' + 
										'<div id="show-the-top-text">Show the top</div>' +
										'<div id="top-x-button-group" class="btn-group" data-toggle="buttons">' + 
											'<label class="btn design-simulate-button active" onclick="showDistributionOfTopX(3, ' + String(object_number) + ',' + String(attribute_id) + ',' + String(rule_id) + ',' + String(parameter_id) + ')">3</label>' + 
											'<label class="btn design-simulate-button active" onclick="showDistributionOfTopX(10, ' + String(object_number) + ',' + String(attribute_id) + ',' + String(rule_id) + ',' + String(parameter_id) + ')">10</label>' + 
											'<label class="btn design-simulate-button active" onclick="showDistributionOfTopX(30, ' + String(object_number) + ',' + String(attribute_id) + ',' + String(rule_id) + ',' + String(parameter_id) + ')">30</label>' + 
											'<label class="btn design-simulate-button active" onclick="showDistributionOfTopX(100, ' + String(object_number) + ',' + String(attribute_id) + ',' + String(rule_id) + ',' + String(parameter_id) + ')">100</label>' + 
											'<label class="btn design-simulate-button active" onclick="showDistributionOfTopX(10000, ' + String(object_number) + ',' + String(attribute_id) + ',' + String(rule_id) + ',' + String(parameter_id) + ')">All</label>' + 
										'</div>' + 
									'</div>');
		showDistributionOfTopX(10, object_number, attribute_id, rule_id, parameter_id);
	}
	


	
	function showDistributionOfTopX(X, object_number, attribute_id, rule_id, parameter_id) {
	
		$('#graph-panel').html('');
		
		//prepare the histogram
		var lower_bound = parameter_info[parameter_id]['min_value'];
		var upper_bound = parameter_info[parameter_id]['max_value'];
		
		//bin_lower_bounds
		var bin_interval = (upper_bound - lower_bound)/40;
		var bin_interval_order_of_magnitude = Math.pow(10, Math.floor(Math.log(bin_interval)/Math.log(10)));
		var rounded_bin_interval = Math.ceil(bin_interval/bin_interval_order_of_magnitude) * bin_interval_order_of_magnitude
		var bins_bottom_edge = Math.floor(lower_bound/rounded_bin_interval) * rounded_bin_interval 
		var bin_lower_bounds = []
		for (var i = 0; i < 40; i++) {
			bin_lower_bounds.push(bins_bottom_edge + i*rounded_bin_interval)
		}
		
		// bin_occurences
		bin_occurences = Array(40).fill(0);
		for (var i = 0; i < Math.min(X,Object.keys(all_priors_df).length); i++) {
			var value = all_priors_df[i]['param' + String(parameter_id)];
			var bin_number = 0;
			for (var j = 0; j < bin_lower_bounds.length; j++) {
				if (value > bin_lower_bounds[j]) { bin_number = j;	}
			}
			bin_occurences[bin_number] += 1;
		}
		
		// histogram_data
		var histogram_data = []
		for (var i = 0; i < bin_lower_bounds.length; i++) {
			if (bin_occurences[i] > 0){
				histogram_data.push([String(bin_lower_bounds[i]), String(bin_occurences[i])]);
			} else {
				histogram_data.push([String(bin_lower_bounds[i]), null]);
			}
		}
		
		//plot the histogram
		anychart.onDocumentReady(function () {

			var chart = anychart.column();
			chart.title(objects_dict[object_number]['object_name'] + '.[' + objects_dict[object_number]['object_attributes'][attribute_id]['attribute_name'] + '], Rule ' + String(rule_id) + ', ' + parameter_info[parameter_id]["parameter_name"] );
			chart.yScale().ticks().allowFractional(false);
			//chart.animation(true);

			var series = chart.column(histogram_data);

			series.tooltip().titleFormat('{%X}');

			series.tooltip()
					.position('center-top')
					.anchor('center-bottom')
					.offsetX(0)
					.offsetY(5);
					
			var tooltip = series.tooltip();


			chart.barGroupsPadding(0);
			chart.yScale().minimum(0);
			chart.yAxis().labels().format('{%Value}{groupsSeparator: }');
			chart.tooltip().positionMode('point');
			chart.interactivity().hoverMode('by-x');

			chart.xAxis().title(parameter_info[parameter_id]["parameter_name"] );
			chart.yAxis().title('Count');

			// set container id for the chart
			chart.container('graph-panel');
			chart.draw();
		});
	}

	//========================================================================
	//========================================================================
	//========   RIGHT PANEL  - Inspect Simulations    =======================
	//========================================================================
	//========================================================================


	function showRunMonteCarloSimulationButton(parameter_number) {
		var right_main_panel_string = 	'<div id="right-main-upper-box">' +
											'<div id="parameter-values-title" class="left-panel-header">Parameter Values</div>' +
											'<div id="simulation-parameter-box">';
											
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules']);
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]]);
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]]
					if (rule['learn_posterior'] && (!(object_numbers[i] in not_used_rules) || (object_numbers[i] in not_used_rules && !(rule_ids[k] in not_used_rules[object_numbers[i]])))) {
					
						right_main_panel_string += '<div class="rule-heading">' + objects_dict[object_numbers[i]]['object_name'] + ', Rule ' + String(rule_ids[k]) + ':</div>';
						if (!rule['has_probability_1']) {
							right_main_panel_string += '<div class="parameter-value">Rule probaility = ' + all_priors_df[parameter_number]['triggerThresholdForRule' + String(rule_ids[k])].toFixed(3) + '</div>';
						}
						var used_parameter_ids = rule['used_parameter_ids'];
						for (var l = 0; l < used_parameter_ids.length; l++) {
							right_main_panel_string += '<div class="parameter-value">' + parameter_info[used_parameter_ids[l]]["parameter_name"] + ' = ' + all_priors_df[parameter_number]['param' + String(used_parameter_ids[l])].toFixed(3) + '</div>';
						}
					}
					
				}
			}
		}
		
		right_main_panel_string +=			'</div>' +
										'</div>' +
										'<div id="right-main-lower-box">' +
											'<div id="number-of-entities-to-simulate-box" class="form">' +
												'<div class="form-group row">' +
													'<label for="number_of_entities_to_simulate" class="col-sm-8">Number of Entities to run</label>' +
													'<div class="col-sm-4">' +
														'<input id="number_of_entities_to_simulate" class="form-control" value="300">' +
													'</div>' +
												'</div>' +
											'</div>' +
											'<button id="run-monte-carlo-sim-button" class="btn btn-success" type="button" onclick="runMonteCarloSimulation(' + parameter_number + ')">Get Simulation Results for this Parameter Combination</button>' +
										'</div>' +
										'<div id="progress-bar-frame" style="display:none;">' +
											'<div id="progress-box" class="progress">' +
												'<div id="progress-bar" class="progress-bar" style="width:0%"></div>' +
											'</div>' +
											'<div id="progress-bar-description" class="progress-description"></div>' +
										'</div>';
										
		$('#right-main-panel').html(right_main_panel_string);
	}
	
	
	function runMonteCarloSimulation(parameter_number) {
		
		$('#run-monte-carlo-sim-button').prop('disabled',true)
		$('#progress-bar-frame').css('display', 'block');
		$('#progress-bar').attr('style','width:0%');
		$('#progress-bar-description').html('');
		
		
		setTimeout('sendSimulationRequest(' + String(parameter_number) + ');', 10);
		setTimeout('update_the_progress_bar();', 2000);
	}
	
	
	
	async function sendSimulationRequest(parameter_number) {
	
		request_body = {'simulation_id': simulation_id, 'parameter_number': parameter_number}
		
		//add number_of_entities_to_simulate
		request_body['number_of_entities_to_simulate'] =  parseInt($('#number_of_entities_to_simulate').val());
		
		//add posted_prior_dict
		posted_prior_dict = {}
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules']);
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]]);
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]]
					if (rule['learn_posterior']) {
						posted_prior_dict[rule_ids[k]] = {}
					
						if (!rule['has_probability_1']) {
							posted_prior_dict[rule_ids[k]]['probability'] = all_priors_df[parameter_number]['triggerThresholdForRule' + String(rule_ids[k])]
						}
						var used_parameter_ids = rule['used_parameter_ids'];
						for (var l = 0; l < used_parameter_ids.length; l++) {
							posted_prior_dict[rule_ids[k]][used_parameter_ids[l]] = all_priors_df[parameter_number]['param' + String(used_parameter_ids[l])]
						}
					}
				}
			}
		}
		request_body['prior_dict'] =  posted_prior_dict;
		
		
		run_simulation_post_request = new XMLHttpRequest();   // new HttpRequest instance
		run_simulation_post_request.onreadystatechange = function() {
		
			if (this.readyState == 4 && this.status == 200) {
				
				parameter_number = JSON.parse(this.responseText);
				showParameterSimulations(parameter_number);
				
				activateSimulatedParameters();
				
			}
		};
		run_simulation_post_request.open("POST", "/tool/run_single_monte_carlo/", true);
		run_simulation_post_request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		run_simulation_post_request.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		run_simulation_post_request.send(JSON.stringify(request_body));
	}



	
	async function update_the_progress_bar() {
		var progress = '0';

		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				
				var progress_dict = JSON.parse(this.responseText);
				//progess-bar
				if ('current_number' in progress_dict){
					$('#progress-bar').attr('style','width:' + String(100 * progress_dict['current_number']/progress_dict['total_number']) + '%')
					$('#progress-bar-description').html(progress_dict['text'] +  String(progress_dict['current_number']) + '/' + String(progress_dict['total_number']));				
				}
				
				if (run_simulation_post_request.readyState < 4) {
					window.setTimeout(() => { update_the_progress_bar();}, 1000);
				}

			}
		};
		xhttp.open("GET", "/tool/get_simulation_progress?simulation_id=" + simulation_id , true);
		xhttp.send();
		
	}
	
	function showParameterSimulations(parameter_number) {
		$('#right-main-panel').html('<iframe id="analyse-simulation-box" src="' + String(parameter_number) + '" title="analyse_simulations_with_this_parameter_combination"></iframe>');
	}
	
	
	//========================================================================
	//========================================================================
	//========   RIGHT PANEL  - Test New Parameters    =======================
	//========================================================================
	//========================================================================
	
	
	function showNewSimulationButton() {
		var right_main_panel_string = 	'<div id="right-main-upper-box">' +
											'<div id="test-new-parameters">' +
												'<div id="parameter-values-title" class="left-panel-header">Parameter Values</div>' +
												'<div id="simulation-parameter-box">';
											
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules']);
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]]);
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]]
					if (rule['learn_posterior'] && (!(object_numbers[i] in not_used_rules) || (object_numbers[i] in not_used_rules && !(rule_ids[k] in not_used_rules[object_numbers[i]])))) {
					
						right_main_panel_string += 		'<div class="rule-heading">' + objects_dict[object_numbers[i]]['object_name'] + ', Rule ' + String(rule_ids[k]) + ':</div>';
						if (!rule['has_probability_1']) {
							right_main_panel_string += 	'<div class="form-group row">' +
															'<label class="col-sm-8 parameter-label" for="probability-of-rule-' + String(rule_ids[k]) + '">Rule Probability = </label>' +
															'<div class="col-sm-4">' +
																'<input type="text" id="probability-of-rule-' + String(rule_ids[k]) + '" class="form-control" value="">' +
															'</div>' +
														'</div>';
						}
						var used_parameter_ids = rule['used_parameter_ids'];
						for (var l = 0; l < used_parameter_ids.length; l++) {
							right_main_panel_string += '<div class="form-group row">' +
															'<label class="col-sm-8 parameter-label" for="value-of-parameter-' + String(used_parameter_ids[l]) + '">' + parameter_info[used_parameter_ids[l]]["parameter_name"] + ' = </label>' +
															'<div class="col-sm-4">' +
																'<input type="text" id="value-of-parameter-' + String(used_parameter_ids[l]) + '" class="form-control" value="">' +
															'</div>' +
														'</div>';
						}
					}
					
				}
			}
		}
		
		right_main_panel_string +=				'</div>' +
												'<div id="right-main-lower-box">' +
													'<div id="number-of-entities-to-simulate-box" class="form">' +
														'<div class="form-group row">' +
															'<label for="number_of_entities_to_simulate" class="col-sm-8">Number of Entities to run</label>' +
															'<div class="col-sm-4">' +
																'<input id="number_of_entities_to_simulate" class="form-control" value="300">' +
															'</div>' +
														'</div>' +
													'</div>' +
													'<button id="run-monte-carlo-sim-button" class="btn btn-success" type="button" onclick="runNewSimulation()">Run</button>' +
												'</div>' +
												'<div id="progress-bar-frame" style="display:none;">' +
													'<div id="progress-box" class="progress">' +
														'<div id="progress-bar" class="progress-bar" style="width:0%"></div>' +
													'</div>' +
													'<div id="progress-bar-description" class="progress-description"></div>' +
												'</div>' +
											'</div>' +
										'</div>';
										
		$('#right-main-panel').html(right_main_panel_string);
	
	}



	function runNewSimulation() {
		
		$('#run-monte-carlo-sim-button').prop('disabled',true)
		$('#progress-bar-frame').css('display', 'block');
		$('#progress-bar').attr('style','width:0%');
		$('#progress-bar-description').html('');
		
		setTimeout('sendNewSimulationRequest();', 10);
		setTimeout('update_the_progress_bar();', 2000);
	}
	
	
	
	async function sendNewSimulationRequest() {
	
		request_body = {'simulation_id': simulation_id, 'parameter_number': null}

		//add number_of_entities_to_simulate
		request_body['number_of_entities_to_simulate'] =  parseInt($('#number_of_entities_to_simulate').val());
		
		//add posted_prior_dict
		posted_prior_dict = {}
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules']);
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]]);
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]]
					if (rule['learn_posterior']) {
						posted_prior_dict[rule_ids[k]] = {}
					
						if (!rule['has_probability_1']) {
							posted_prior_dict[rule_ids[k]]['probability'] = parseFloat($('#probability-of-rule-' + String(rule_ids[k])).val());
						}
						var used_parameter_ids = rule['used_parameter_ids'];
						for (var l = 0; l < used_parameter_ids.length; l++) {
							posted_prior_dict[rule_ids[k]][used_parameter_ids[l]] = parseFloat($('#value-of-parameter-' + String(used_parameter_ids[l])).val());
						}
					}
				}
			}
		}
		request_body['prior_dict'] =  posted_prior_dict;
		
		
		run_simulation_post_request = new XMLHttpRequest();   // new HttpRequest instance
		run_simulation_post_request.onreadystatechange = function() {
		
			if (this.readyState == 4 && this.status == 200) {
				
				parameter_number = JSON.parse(this.responseText);
				$('#param-selection-button-' + String(parameter_number)).attr("onclick",'showParameterSimulations(' + String(parameter_number) + ')');
				$('#param-selection-button-' + String(parameter_number)).css("background",'rgb(248, 248, 248)');
				$('#param-selection-button-' + String(parameter_number)).css("color",'#333');
				showNewParameterSimulations(parameter_number);
				
			}
		};
		run_simulation_post_request.open("POST", "/tool/run_single_monte_carlo/", true);
		run_simulation_post_request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		run_simulation_post_request.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		run_simulation_post_request.send(JSON.stringify(request_body));
	}
	
	
	

	function showNewParameterSimulations(parameter_number) {
		$('#right-main-panel').html('<iframe id="analyse-simulation-box" src="new-' + String(parameter_number) + '" title="analyse_simulations_with_this_parameter_combination"></iframe>');
	}
	//========================================================================
	//========================================================================
	//========================    MAIN      ==================================
	//========================================================================
	//========================================================================	

	window.onload = function() {	

		
		// make the accordion in the left sidebar collapseable
		$('.accordion-toggle').click(function() {
			content_element = $($(this).attr('href'));
			if (content_element.hasClass('in')) {
				content_element.hide();
				content_element.removeClass('in')
			} else {
				content_element.show();
				content_element.addClass('in')
			}
		});
		
		//$('#accordion-left-content-3').show();
		//$('#accordion-left-content-3').addClass('in');
		
		
		
		// load parameter_info
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules']);
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]]);
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]]
					if (rule['learn_posterior']) {
					
						var used_parameter_ids = rule['used_parameter_ids'];
						for (var l = 0; l < used_parameter_ids.length; l++) {
							//get the Parameter Info
							var xhttp = new XMLHttpRequest();       
							xhttp.onreadystatechange = function() {
								if (this.readyState == 4 && this.status == 200) {
									response_dict = JSON.parse(this.responseText);
									parameter_info[response_dict['id']] = response_dict;
								}
							};
							xhttp.open('GET', '/tool/get_parameter_info?parameter_id=' + String(used_parameter_ids[l]) + '&is_last_parameter=' + String(l == (used_parameter_ids.length-1)), true);
							xhttp.send();
						}
					}
					
				}
			}
		}
		
		
		drawInspectSimulations();
		activateSimulatedParameters();
		
		
	}
	
</script>


<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.0/jquery-ui.js"></script>

	 

{% endblock %}



